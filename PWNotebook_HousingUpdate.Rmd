---
title: "PWNotebook_HousingModel"
output:
  html_notebook:
    fig_caption: yes
    number_sections: yes
    toc: yes
  html_document: default
  pdf_document:
    extra_dependencies: natbib,booktabs,lscape,graphicx
  word_document: default
date: '`r Sys.Date()`'
---


# R Startup

```{r, setup, include=FALSE }
knitr::opts_chunk$set(echo = TRUE)

knitr::opts_knit$set(root.dir = '/home/a1psw01/Projects/HousingUpdate/Programs/')
knitr::opts_chunk$set(cache =TRUE,eval=FALSE)
rm(list=ls())
require(readr); require(readxl);
require(dplyr); require(tidyr);require(tidyselect)
require(ggplot2); require(RColorBrewer)
require(reshape2); require(stringr)
require(knitr); require(png)
require(binsreg)
options(dplyr.width=Inf); options(dplyr.print_max=Inf)
options(stringsAsFactors=FALSE)
require(fixest)
require(modelr)
require(lubridate)
require(janitor)
require(ISOweek)
require(haven)
require(zoo)
require(seasonal)
require(rlang)
path_tg <- 'Figures/'
# setwd('/home/a1psw01/Desktop/Notebooks/')
getwd()
source("/shared/LoewensteinWillen/ResidentialInvestment/dofiles and scripts/fGraphicsFunctionsNew.R")
```




#  January 2024 CPI

https://frbprod1-my.sharepoint.com/personal/paul_willen_bos_frb_org/_layouts/15/Doc.aspx?sourcedoc={3760894e-dea2-46af-b258-abc0b3b9053d}&action=edit&wd=target%28Quick%20Notes.one%7Cd6c68003-c0bd-5047-998e-9950685d1524%2FNotes%7C09a9def5-f42b-d94b-9e2c-b5a4688217d6%2F%29&wdorigin=703

https://frbprod1-my.sharepoint.com/personal/paul_willen_bos_frb_org/_layouts/15/Doc.aspx?sourcedoc={3760894e-dea2-46af-b258-abc0b3b9053d}&action=edit&wd=target%28Policy.one%7Cee96b10a-6207-0f49-b893-028f753a8ee6%2FJanuary%202024%20cpi%7C2cce8a80-778f-9644-a019-eb2bbb20985b%2F%29&wdorigin=703

Hi Everyone,

Thank you for your efforts. As discussed during the meeting, I don't believe it's worthwhile to dive into the intricacies of OER. In particular, I don't think we should even discuss the possibility of a persistent deviation between OER and Rent.  It's important to note that since the onset of the pandemic, Rent and OER have grown almost exactly the same amount, with Rent increasing by 20.67% and OER by 20.47%, respectively. The close correlation between these two series has been consistent since their inception. Over the period from 1983 to the present, OER has grown approximately 4 percent relative to Rent, translating to less than one percent per decade. 

Regarding Susan's situation, I don't believe analyzing rent growth across different cities will be helpful. The BLS aims to compute housing costs for a household in a representative location. To replicate their methodology, we would need to access zip code-level data and examine variations _within_ cities. However, this approach presents challenges similar to those faced by the BLS, namely, that rent indexes are only available in areas with a high concentration of renters and, consequently, a low concentration of owners. To illustrate the scale of this issue, consider that while Zillow provides rent observations for 6000 zip codes, it offers price observations for 26,000.  

## BLS Mistake

https://infodisplay.infodesk.com/item/1349d9c2-6a87-45ca-90cd-83dbc0bdec60.html?&VERSION=3&UID=bosadmin@bos.frb.org&CU=frb4589&APP=1&PROFILE=ktg9&

Super Users,

Good afternoon.

The weights for single family detached homes increased materially from December 2023 to January 2024. All of you searching for the source of the divergence have found it.

No additional information related to this question will be disseminated. We do not do diagnostic analysis of microdata.




```{r}
1.3/36
1.3/36*1.76
.54/.965


csv_file<-"/home/a1psw01/Desktop/Notebooks/Data/Zip_zhvi_uc_sfrcondo_tier_0.33_0.67_sm_sa_month.csv"

zhvi_zip<-read_csv(csv_file) %>%
     readr::type_convert()

csv_file<-"/home/a1psw01/Desktop/Notebooks/Data/Zip_zori_uc_sfrcondomfr_sm_month.csv"

zori_zip<-read_csv(csv_file) %>%
     readr::type_convert()


```
# McDash computations


```{r}


# csv_file <- "/home/a1psw01/Desktop/Notebooks/Data/MBSPrices15_20_30_1699028802874.csv"
# jpm <- read.csv(file = csv_file, header = TRUE, sep = ",",
#                 dec = ".",strip.white = TRUE,na.strings=c("N/A")) %>%
#      mutate(Date = as.Date(Date,"%d-%b-%y")) 
# 
# names(jpm) <- make_clean_names(names(jpm))     
# 
# ls<-str_extract_all(names(jpm), '[0-9]+')
# ls<-data.frame(matrix(unlist(ls), ncol = max(lengths(ls)), byrow = TRUE)) %>%
#      mutate(term=as.numeric(X1)) %>%
#      mutate(rate=as.numeric(paste0(X2,".",X3))) %>%
#      select(-c(X1,X2,X3,X4))



# csv_file <- 
#      "/home/a1psw01/Desktop/Notebooks/Data/lps1130975601699019102.csv"
# 
# mcdash_download<- read.csv(file = csv_file, 
#                            header = TRUE, 
#                            sep =",",
#                            dec = ".",
#                            strip.white = TRUE,
#                            na.strings=c(-1,''))

# mcdash <- mcdash_download %>%
#      mutate(as_of_date=
#                  as.Date(paste0(substr(as_of_mon_id,1,4),"/",
#                                 substr(as_of_mon_id,5,6),"/1"))) %>%
#      filter(lien_type==1)%>%
#      filter(is.na(fico_orig)==FALSE) %>%
#      # filter(is.na(orig_amt)==FALSE)  %>%
#      filter(prod_type==10) %>%
#      # left_join(.,jpm)
#      {.}
# 
# 
# 
# ```
# ```{r}
# 
# 
# 
# date_pool <- as.Date("2023/8/1")
# date_valuation <- as.Date("2023/10/20")
# 
# mm <- mcdash %>% filter(as_of_date==date_pool) %>%
#      select(as_of_date,cur_int_rate,prin_bal_amt,ltv_mtm_cty11_d) %>% 
#      rename(date=as_of_date) %>%
#      mutate(house_value=prin_bal_amt/ltv_mtm_cty11_d*100) %>%
#      filter(ltv_mtm_cty11_d>0) %>%
#      drop_na()
# 
# jpm_m <- jpm %>% filter(date==date_valuation)
# 
# 
# f_interp <- function(rates,prices,note){
#      price=approx(rates,prices,note)$y
#      return(price)
# }
# 
# mm_u <- mm %>% group_by(cur_int_rate) %>%
#      summarise(mean(cur_int_rate)) %>%
#      mutate(p=0) %>%
#      mutate(p_no_g_fee=0)
# 
# for (ii in seq(1,NROW(mm_u),by=1)){
#      mm_u$p[ii]<-f_interp(ls$rate[1:14],jpm_m[2:15],mm_u[ii,2])
#      mm_u$p_no_g_fee[ii]<-f_interp(ls$rate[1:14],jpm_m[2:15],mm_u[ii,2]-.55)
# }
# 
# mm <- mm %>% left_join(.,mm_u) %>%
#      drop_na %>%
#      rowwise() %>%
#      mutate(dollar=max((100-p_no_g_fee)*prin_bal_amt/100,0)) %>%
#      mutate(share_valuation=dollar/house_value)
# 
# mean(mm$share_valuation,na.rm = TRUE)
# mean(mm$dollar)/mean(mm$house_value)
# mean(mm$p,na.rm = TRUE)


```

## McDash

```{r}
# csv_file <- "/home/a1psw01/Desktop/Notebooks/Data/lps1129065741698170402.csv"
# mcdash_download <- read_csv(csv_file) 
# 
# mcdash_download <- mcdash_download %>%
#      group_by(loan_id) %>%
#      filter(as_of_mon_id==min(as_of_mon_id)) %>%
#      ungroup %>%
#      {.}

# mcdash <- mcdash_download %>%
#      mutate(close_dt=as.Date(close_dt)) %>%
#      filter(prod_type==10) %>%
#      filter(lien_type==1)%>%
#      filter(term_nmon==360) %>%
#      filter(close_dt>as.Date("2016/1/1")&
#                  close_dt<as.Date("2017/3/1")) %>%
#      group_by(close_dt) %>%
#      summarise(cur_int_rate=mean(cur_int_rate,na.rm=TRUE),nobs=n())
# 
# plot(mcdash$close_dt,mcdash$cur_int_rate,type = "l")

```

# Fannie Mae Lock-in Survey

https://www.fanniemae.com/research-and-insights/perspectives/lock-effect-not-only-reason-housing-supply-woes

Survey results are here : /home/a1psw01/Desktop/Notebooks/Documents/FNMA_lock_in_effect_research_deck.pdf

Hard to interpret the results

No baseline.  Obviously, there's no reason why "I like the home / location" and "My job and family are located here" should have changed much in the last two years.  

So it's possible that people always report staying n homes longer than they expected. 

Let's say that normally, 33 percent of people say they are planning to stay longer than expected, 33 percent planning to move when expected and 33 percent planning to move sooner than expected.  a shock comes and those people 

Two things:  

1.  I have a lower mortgage rate than current mortgage rates11

2.  General equilibrium effects of lock-in should show up in two questions:

     Home prices are too high to buy a new home
     There are not many homes for sale that I like


# Goolsbee

## Odd lots podcast

https://pca.st/gi09q0d8

Around minute 18

housing was growing 3-3.5 percent

housing needs to come down.

normal dynamics on residential house prices have had some bumps

bunch of people locked in  resisting putting their homes on the market
supply of existing homes has come down driving prices up

slowed decline of residential inflation

## PIIE Speech

https://www.chicagofed.org/publications/speeches/2023/september-28-peterson-institute

"All this means that over the next few quarters the key to further progress will be what happens to housing inflation. Continued progress would bode well, but there is a risk that recent increases in home prices could spill over to market rents and stall the improvement here. So, this is a critical risk to monitor."

#  Talking points for Susan


After falling in the second half of 2022, house prices have been rising rapidly in recent months.  Does this mean that rent inflation is going to become a problem again?


We are relatively optimistic

1.  unusally low number of transactions makes it hard to interpret short run price changes

2.  multifamily housing prices are still falling

3.  relationship between rents and prices is not stable.  large changes in prices do not lead to big changes in rents. 
     -- 2020-2022 was highly unusual - big change in prices mostly driven by changes in rents.




# Load Data

## Haver

```{r Haver Load}
require(ISOweek)
csv_file <- "/shared/crt/OptimalBlue/RateCalcs/Data/research_haver_weekly.csv"
rhw <- read.csv(file = csv_file, header = TRUE, sep = ",",
                dec = ".",strip.white = TRUE)
rhw$Date <- as.Date(rhw$date-1,origin="0000-01-01")

csv_file <- "/shared/crt/OptimalBlue/RateCalcs/Data/research_haver_monthly.csv"
rhm <- read.csv(file = csv_file, header = TRUE, sep = ",",
                dec = ".",strip.white = TRUE)
rhm$Date <- as.Date(rhm$date-1,origin="0000-01-01")

csv_file <- "/shared/crt/OptimalBlue/RateCalcs/Data/research_haver_quarterly.csv"
rhq <- read.csv(file = csv_file, header = TRUE, sep = ",",
                dec = ".",strip.white = TRUE)
rhq$Date <- as.Date(rhq$date-1,origin="0000-01-01")

csv_file <- "/shared/crt/OptimalBlue/RateCalcs/Data/research_haver_annual.csv"
rha <- read.csv(file = csv_file, header = TRUE, sep = ",",
                dec = ".",strip.white = TRUE)
rha$Date <- as.Date(rha$date-1,origin="0000-01-01")

csv_file <- "/shared/crt/OptimalBlue/RateCalcs/Data/research_haver_daily.csv"
rhd <- read.csv(file = csv_file, header = TRUE, sep = ",",
                dec = ".",strip.white = TRUE)
rhd$Date <- as.Date(rhd$date-1,origin="0000-01-01")



```


## CoStar

Note some wacky stuff about the costar downloads.  First, to make sure you get the national data (which we need), you need to make sure to un-toggle "Exclude countries."

Also, if you include submarkets, then it generates a csv but if you exclude submarkets, it generates an xlsx file.

![](/home/a1psw01/Desktop/Notebooks/Images/Images2024/CostarDownload.png)

Another Costar mystery is the "Add National Index Markets" button.  It's not clear that it does anythingand it is a bit odd that you can't remove national index markets?  What if you added them by mistake?

![](/home/a1psw01/Desktop/Notebooks/Images/Images2024/CostarNationalIndexButton.png)

The useful documentation for costar is, mysteriously, in a section called Market Insights on the Markets page

For example, the "zip code to submarket mapping" solves a lot of the problem with matching costar rents to properties that are not already identified by costar.

also the useful map from submarket to submarket group is actually in the zip code to submarket mapping NOT in the submarket to submarket group map which only works for non-MF properties (like retail and industrial)

![](/home/a1psw01/Desktop/Notebooks/Images/Images2024/CostarMarketInsights.png)

```{r,  }

xlsx_file <- "/home/a1psw01/Desktop/Notebooks/Data/PWCoStar_102_AllData_2024May.xlsx"
CostarDownload <- 
     read_excel(path=xlsx_file,col_types = "text") %>%
     readr::type_convert()

names(CostarDownload ) <- make_clean_names(names(CostarDownload ))
CostarDownload <- CostarDownload %>% 
     filter(grepl("QTD",period)==FALSE)%>%
     mutate(date=as.Date(
          paste0(substr(period,1,4),
                 "/",
                 as.numeric(substr(period,7,7))*3-2,"/1"))) %>%
     arrange(date) %>% filter(date<Sys.Date())


Costar_CBSA <- CostarDownload %>% 
     filter(geography_type=="Metro") %>%
     select(date,cbsa_code,
            market_effective_rent_unit,market_sale_price_per_unit,
            population,households) %>%
     relocate(date)

CPIData<- rhm %>% select(Date,UIXFDHEN) %>%
     mutate(year=year(Date),month=month(Date)) %>%
     mutate(date=as.Date(paste0(year,"/",month,"/1"))) %>%
     select(-c(Date,year,month)) %>%
     na.omit


Costar_National <- CostarDownload %>% 
     filter(geography_type=="National") %>%
     select(date,
            market_effective_rent_unit,market_sale_price_per_unit,market_cap_rate,
            population,households) %>%
     left_join(.,CPIData) %>%
     mutate(population=na.approx(population)) %>%
     mutate(households=na.approx(households)) %>%
     mutate(rent_price=market_effective_rent_unit/market_sale_price_per_unit)%>%
     relocate(date)  %>%
     drop_na()

```

## CoreLogic SFRI Data

```{r,  }
csv_file = "/home/a1psw01/Desktop/Notebooks/Data/sfri_dw_sfri_combined_v4_202403.csv"

SFRIDownload <- read_csv(csv_file) %>%
     readr::type_convert() %>%
     filter(tier_code==11|tier_code==0|tier_code==7) %>%
     mutate(date=as.Date(
          paste0(substr(as_of_mon_id,1,4),"/",
                 substr(as_of_mon_id,5,6),"/1"))) 
     

SFRI_National <-SFRIDownload %>% 
     filter(tier_code==11) %>%
     filter(geo=="National") %>%
     mutate(year=lubridate::year(date),
            month=lubridate::month(date)) %>%
     select(date,single_family_rent_index) %>%
     relocate(date)



SFRI_All <-SFRIDownload %>% 
     filter(geo=="National") %>%
     mutate(year=lubridate::year(date),
            month=lubridate::month(date)) %>%
     select(date,tier_name,single_family_rent_index) %>%
     pivot_wider(names_from=tier_name,values_from=single_family_rent_index) %>%
     arrange(date)

names(SFRI_All) <- make_clean_names(names(SFRI_All))

SFRI_CBSA <-SFRIDownload %>% rename(cbsa_code=geo_code) %>%
      filter(tier_code==11) %>%
     filter(geo!="National") %>%
     mutate(year=lubridate::year(date),
            month=lubridate::month(date)) %>%
     select(date,cbsa_code,single_family_rent_index) %>%
     relocate(date)
```

## CoreLogic HPI Data

```{r,  }
csv_file="../Data/hpi_dw_cbsa_v4_202405.csv"

HPIDownload <- read_csv(csv_file) %>%
     readr::type_convert()

HPI_CBSA <-HPIDownload %>% 
     filter(tier_code==11) %>%
     mutate(cbsa_code=ifelse(is.na(cbsa_code)==1,99999,cbsa_code)) %>%
     mutate(date=as.Date(paste0(substr(as_of_mon_id,1,4),"/",
                                substr(as_of_mon_id,5,6),"/1"))) %>%
     mutate(year=lubridate::year(date),
            month=lubridate::month(date)) %>%
     relocate(date) %>%
     select(date,cbsa_code,cbsa_name,home_price_index)

csv_file="../Data/hpi_dw_state_v4_202405.csv"

HPIDownload <- read_csv(csv_file) %>%
     readr::type_convert() %>%
     mutate(date=as.Date(paste0(substr(as_of_mon_id,1,4),"/",
                                substr(as_of_mon_id,5,6),"/1"))) %>%
     mutate(year=lubridate::year(date),
            month=lubridate::month(date))

HPI_National <-HPIDownload %>% 
     filter(state_name=="National") %>%
     filter(tier_code==11) %>%
     relocate(date) %>%
     select(date,home_price_index) %>%
     arrange(date)

csv_file="../Data/hpi_dw_county_v4_202405.csv"

HPIDownload <- read_csv(csv_file) %>%
     readr::type_convert() 

HPI_County <-HPIDownload %>% 
     filter(tier_code==11) %>%
     # mutate(cbsa_code=ifelse(is.na(cbsa_code)==1,99999,cbsa_code)) %>%
     mutate(date=as.Date(paste0(substr(as_of_mon_id,1,4),"/",
                                substr(as_of_mon_id,5,6),"/1"))) %>%
     mutate(year=lubridate::year(date),
            month=lubridate::month(date)) %>%
     relocate(date)  %>%
     filter(parent_geography_used=="N/A")  %>%
     select(date,fips_code,home_price_index)%>%
     rename(FIPS=fips_code) %>%
     {.}

```

## CBRE Data

```{r}

csv_file<-"/home/a1psw01/Desktop/Notebooks/Data/a_MarketForecast_Quarterly_Baseline.csv"

CBREDownload <- read_csv(csv_file) %>%
     readr::type_convert() %>%
     mutate(date=as.Date(paste0(substr(Year,1,4),"/",
                                3*as.numeric(substr(Year,6,6))-2,"/1"))) %>%
     mutate(year=lubridate::year(date),
            month=lubridate::month(date)) %>%
     relocate(date)

CBRE<- CBREDownload %>% filter(MarketMnemonic=="NATION") %>%
     select(date,RentIndex) %>%
     rename(CBRERentIndex=RentIndex)

```

## Create CBSA Dataset

```{r,  }
PR_CBSA <- Costar_CBSA %>%
     left_join(.,SFRI_CBSA)  %>%
     left_join(.,HPI_CBSA) %>%
     arrange(cbsa_code,date) %>%
     mutate(year=year(date))%>%
     relocate(cbsa_code,cbsa_name,date) %>%
                   drop_na  %>%
     pivot_longer(cols =
                       c(market_effective_rent_unit,market_sale_price_per_unit,
                         single_family_rent_index,home_price_index),
                  names_to="transaction",
                  # names_prefix="x",
                  values_to="price")
```


## Create National Dataset

```{r,  }

ZillowData<- rhm %>% select(Date,USZHV,USZOI,USZOIM,USZOIS,UIXFDHEN,PCUHSRR,PCUHSHAN,LJPRIVA) %>%
     mutate(year=year(Date),month=month(Date)) %>%
     mutate(date=as.Date(paste0(year,"/",month,"/1"))) %>%
     select(-c(Date,year,month))

PR_National <- Costar_National %>%
     left_join(.,SFRI_National)  %>%
     left_join(.,SFRI_All) %>%
     left_join(.,HPI_National) %>%
     left_join(.,ZillowData) %>%
     mutate(sfri_dollar=
                 single_family_rent_index/
                 single_family_rent_index[date==as.Date("2015/1/1")]*
                 USZOI[date==as.Date("2015/1/1")]) %>%
     mutate(hpi_dollar=
                 home_price_index/
                 home_price_index[date==as.Date("2015/1/1")]*
                 USZHV[date==as.Date("2015/1/1")]) %>%
    mutate(year=year(date))

RentComparison <- PR_National %>%
     select(date,market_effective_rent_unit,USZOI,USZOIS,USZOIM,single_family_rent_index,single_family_detached,single_family_combined,single_family_attached,home_price_index,PCUHSRR,PCUHSHAN,LJPRIVA) %>%
     left_join(.,CBRE) %>%
     rename(Costar=market_effective_rent_unit) %>%
     rename(ZillowSF=USZOIS) %>%
     rename(ZillowMF=USZOIM) %>%
     rename(Zillow=USZOI) %>%
     rename(SFRI=single_family_rent_index) %>%
     rename(SFRI_Attached=single_family_attached) %>%
     rename(SFRI_Detached=single_family_detached) %>%
     rename(CBRE=CBRERentIndex) %>%
     rename(HPI=home_price_index) %>%
     rename(CPIRent=PCUHSRR) %>%
     rename(OER=PCUHSHAN)  %>%
     rename(Earnings=LJPRIVA) 

write_csv(RentComparison,"/home/a1psw01/Desktop/Notebooks/Data/PWNotebook_HousingModel_RentComparison.csv")
```

## LoewensteinWillen Estimates

``` {r,  }

require(haven)

PXShelter<-rhm %>% select(year,UIXFDHEN,SPECAPE) %>% na.omit %>%
     group_by(year) %>%
     summarise(UIXFDHEN=log(mean(UIXFDHEN)),SPECAPE=log(mean(SPECAPE))) %>%
     mutate(Date=as.Date(paste0(year,"/1/1")))

FRM30 <-rhw %>% select(year,FRM30) %>% na.omit %>%
     group_by(year) %>%
     summarise(FRM30=mean(FRM30)) %>%
     mutate(Date=as.Date(paste0(year,"/1/1")))

PRInterestScatter <- read_dta(file = "/shared/LoewensteinWillen/priceRentRatio/data/realEstate/decomposition/repeatSalePriceRentRatio_exLargeMulti_netTax_w.dta") %>%
     mutate(Date=as.Date(paste0(year,"/1/1"))) %>%
     left_join(.,FRM30)  

RepeatSale <- read_dta(file = "/shared/LoewensteinWillen/priceRentRatio/data/realEstate/decomposition/repeatSalePriceRentRatio_exLargeMulti_netTax_w.dta") %>%
     mutate(Date=as.Date(paste0(year,"/1/1"))) %>%
     left_join(.,PXShelter)  %>%
     mutate(inflation=UIXFDHEN-lag(UIXFDHEN),logUIX=UIXFDHEN)
```

## Redfin data


https://www.redfin.com/news/data-center/

```{r}


redfin_national<-readr::read_tsv("../Data/us_national_market_tracker.tsv000")

redfin_state <-readr::read_tsv("../Data/state_market_tracker.tsv000")


# redfin_national <-readr::read_tsv("/home/a1psw01/Desktop/Notebooks/Data/city_market_tracker.tsv000")

redfin <- rbind(redfin_state,redfin_national) %>% filter(property_type_id==-1) %>%
     subset(select=names(.)[-grep("mom",names(.))]) %>%
     subset(select=names(.)[-grep("yoy",names(.))])  %>%
     mutate(sale_hazard=homes_sold/inventory) %>%
     arrange(state,period_begin) %>%
     filter(!(period_begin<as.Date("2017/1/1")))%>%
     filter(is_seasonally_adjusted==FALSE) %>%
     mutate(year=year(period_begin),month=month(period_begin))

est1<-feols(log(homes_sold) ~ factor(month)*state,data=redfin[redfin$period_begin<as.Date("2020/1/1"),])
redfin2<- add_predictions(redfin, est1, var = "predSales") %>%
     mutate(sales_index=100*homes_sold/exp(predSales))


est1<-feols(log(inventory) ~ factor(month)*state,data=redfin[redfin$period_begin<as.Date("2020/1/1"),])
redfin2<- add_predictions(redfin2, est1, var = "predInv") %>%
     mutate(inventory_index=100*inventory/exp(predInv))

est1<-feols(log(new_listings) ~ factor(month)*state,data=redfin[redfin$period_begin<as.Date("2020/1/1"),])
redfin2<- add_predictions(redfin2, est1, var = "predList") %>%
     mutate(listing_index=100*new_listings/exp(predList))





```

# Analysis

## Regression

```{r,  }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_2023_101_Price_Rent_SF_MF"


PR_CBSA <- PR_CBSA %>%
     arrange(desc(transaction))

num="101a_1"
name<-paste0("spec",num)
specs<-name #c(specs,name)
y<-"log(price)"
x<-c("factor(date)*i(transaction)")
StartDate<-as.Date("2018/1/1")
EndDate<-as.Date("2024/6/30")
reg_formula<-formula(paste(y, paste(x, collapse=" + "), sep=" ~ " ))
sample<- PR_CBSA[PR_CBSA$transaction%in%c("market_sale_price_per_unit","market_effective_rent_unit"),]
Output  <- feols(reg_formula,sample)
assign(name,list(y=y,x=x,Output=Output,StartDate=StartDate,EndDate=EndDate))

num="101a_2"
name<-paste0("spec",num)
specs<-name #c(specs,name)
y<-"log(price)"
x<-c("factor(date)*i(transaction)+factor(cbsa_code)*transaction")
StartDate<-as.Date("2018/1/1")
EndDate<-as.Date("2024/6/30")
reg_formula<-formula(paste(y, paste(x, collapse=" + "), sep=" ~ " ))
sample<- PR_CBSA[!PR_CBSA$transaction%in%c("market_sale_price_per_unit","market_effective_rent_unit"),]
Output  <- feols(reg_formula,sample)
assign(name,list(y=y,x=x,Output=Output,StartDate=StartDate,EndDate=EndDate))



# dictx = c(libor_6_months_mid_rate="\\multirow{2}{6cm}{\\hangindent=1cm 6-month LIBOR in \\%}",
#           GSCPI="\\multirow{2}{6cm}{\\hangindent=1cm FRBNY Supply Chain Pressure Index}",
#           "scale(rent_diff)"="\\multirow{2}{6cm}{\\hangindent=1cm Cumulative $\\Delta$ in rent per square foot (scaled)}",
#           cap_rate_diff="\\multirow{2}{6cm}{\\hangindent=1cm Cumulative $\\Delta$ in cap rate in \\%}",
#           new_units="\\multirow{2}{6cm}{\\hangindent=1cm Number of new units in project}",
#           "pmit"="Prob(Permit)",
#           "factor(age_y)"="Age",
#           "factor(geography_name)"="Neighborhood",
#           "rental_dummy"="Condo",
#           "date"="Quarter",
#           "geography_name"="Neighborhood",
#           "high_idp"="High IDP percentage",
#           "qq"="Seasonal",
#           "age_y)"="Age",
#           "factor(n_units)2"=paste0("(",UnitCutoff$cutoff[1],",",UnitCutoff$cutoff[2],"] Units"),
#           "factor(n_units)3"=paste0("(",UnitCutoff$cutoff[2],",",UnitCutoff$cutoff[3],"] Units"),
#           "factor(n_units)4"=paste0("(",UnitCutoff$cutoff[3],",",UnitCutoff$cutoff[4],"] Units"),
#           "COVIDTRUE"="Year$>$2019"
#           )

eval(
     parse(
          text=paste0(
               "etable(list(",
               paste0(specs,"$Output",collapse=","),")",
               # ",tex = TRUE",
               # paste0(",file =\"",FigureRoot,"_tabular.tex\""),
               # ",replace = TRUE",
               # # ",dict=dictx",
               # ",vcov=~date+geography_name",
               ")"
               )
          )
     )

# fCompileTable(pst_root=FigureRoot,Width="!",Height="4.5cm",
#          WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()
```

## Set Up Data for Bar Charts

```{r  }

RepeatSaleAnn <- RepeatSale %>% 
     select(year,Date,
            coefiProp,coefooProp,coefrentProp,
            inflation) %>%
     mutate(coefPriceRent=coefiProp-coefrentProp) %>%
     mutate(coefRealRent=coefrentProp-inflation) %>%
     mutate(signP=sign(coefiProp),
            signRealRent=sign(coefRealRent),
            signPriceRent=sign(coefPriceRent)) %>%
     mutate(PriceRentShare=coefPriceRent/coefiProp*signP) %>%
     mutate(RealRentShareBase=ifelse(signRealRent>0&
                                          signPriceRent<0|signRealRent<0&
                                          signPriceRent>0,0,PriceRentShare) ) %>%
     mutate(RealRentShare=coefRealRent/coefiProp) %>%
     mutate(RealRentShareLine=ifelse(signRealRent>0&
                                          signPriceRent<0|signRealRent<0&
                                          signPriceRent>0,
                                     RealRentShare*signP,
                                     PriceRentShare+RealRentShare*signP)) %>%
     mutate(InflationBase=pmax(PriceRentShare,
                               RealRentShareLine,0,
                               na.rm=TRUE)) %>%
     mutate(InflationLine=InflationBase+
                 inflation/coefiProp*signP)

RepeatSaleAnn2 <- RepeatSaleAnn %>% 
     mutate(Date=as.Date(paste0(year,"/12/31")))
RepeatSaleAnn <- rbind(RepeatSaleAnn,RepeatSaleAnn2) %>% 
     arrange(Date)

RepeatSalesPhases <- RepeatSale %>% 
     filter(year%in%c(2000,2005,2011,2020,2021)) %>%
     mutate(Time=year-lag(year),
            PriceGrowth=indexiProp-lag(indexiProp),
            PriceGrowthOO=indexooProp-lag(indexooProp),
            NomRentGrowth=indexrentProp-lag(indexrentProp),
            Inflation=logUIX-lag(logUIX)) %>%
     mutate(PriceGrowthAnn=PriceGrowth/Time,
            NomRentGrowthAnn=NomRentGrowth/Time,
            InflationAnn=Inflation/Time) %>%
     mutate(RealPriceGrowthAnn=PriceGrowthAnn-InflationAnn,
            RealRentGrowthAnn=NomRentGrowthAnn-InflationAnn) %>%
     mutate(RealRentShareAnn=RealRentGrowthAnn/RealPriceGrowthAnn)

RepeatSalesPhases <- as.data.frame(t(RepeatSalesPhases))

RepeatSaleTotal <- RepeatSale %>% select(year,Date,
                                         coefiProp,coefooProp,coefrentProp,
                                         inflation) %>%
     mutate(coefPricePrice=coefooProp-coefiProp) %>%
     mutate(coefPriceRent=coefiProp-coefrentProp) %>%
     mutate(coefRealRent=coefrentProp-inflation) %>%
     mutate(signP=sign(coefooProp),
            signRealRent=sign(coefRealRent),
            signPriceRent=sign(coefPriceRent),
            signPricePrice=sign(coefPricePrice),
            signInflation=sign(inflation),
            signRent=sign(coefrentProp)) 

xx <- RepeatSaleTotal %>% select(coefPriceRent,
                                 coefPricePrice,
                                 coefRealRent,
                                 inflation) %>%
     as.matrix(.)
yy <- RepeatSaleTotal %>% 
     select(signPriceRent,
            signPricePrice,
            signRealRent,
                                 signInflation) 
RepeatSaleLevel <- data.frame(cbind(RepeatSaleTotal$year,
                                    (xx*as.matrix(yy>0))%*%upper.tri(matrix(1,4,4),
                                                                     diag = TRUE),
                                    (xx*as.matrix(yy<0))%*%upper.tri(matrix(1,4,4),
                                                                     diag = TRUE),
                                    RepeatSaleTotal$coefooProp)) %>%
     mutate(Date=as.Date(paste0(X1,"/1/1")))

RepeatSaleLevel2 <- RepeatSaleLevel %>% 
     mutate(Date=as.Date(paste0(X1,"/12/31")))
RepeatSaleLevel <- rbind(RepeatSaleLevel,RepeatSaleLevel2) %>% 
     arrange(Date)

RepeatSaleLevel3 <- RepeatSaleLevel %>% 
     mutate(Date=as.Date(paste0(X1,"/7/1")))

xx <- RepeatSaleTotal %>% 
     select(coefPriceRent,coefPricePrice,coefrentProp) %>%
     as.matrix(.)
yy <- RepeatSaleTotal %>% 
     select(signPriceRent,signPricePrice,signRent) 

RepeatSaleNoInflation <- data.frame(cbind(RepeatSaleTotal$year,
                                    (xx*as.matrix(yy>0))%*%upper.tri(matrix(1,3,3),
                                                                     diag = TRUE),
                                    (xx*as.matrix(yy<0))%*%upper.tri(matrix(1,3,3),
                                                                     diag=TRUE),
                                    RepeatSaleTotal$coefooProp)) %>%
     mutate(Date=as.Date(paste0(X1,"/1/1")))

RepeatSaleNoInflation2 <- 
     RepeatSaleNoInflation %>% 
     mutate(Date=as.Date(paste0(X1,"/12/31")))

RepeatSaleNoInflation <- 
     rbind(RepeatSaleNoInflation,RepeatSaleNoInflation2) %>% 
     arrange(Date)

RepeatSaleNoInflation3 <- 
     RepeatSaleNoInflation %>% 
     mutate(Date=as.Date(paste0(X1,"/7/1")))
```



## PW_HousingUpdate_103_PriceDecomp1

![This figure shows a decomposition of the price growth of housing using the methods in Loewenstein and Willen (2023).  The decomposition goes between -100 and plus 100 and over. ](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_103_PriceDecomp1-1.png)

``` {r,  }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_103_PriceDecomp1"

xlims=as.Date(c("2001/1/1","2024/2/1"))
factor=0.8

pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =xlims,
                     pst_ylims         =c(-1.55,1.55),
                     #pst_ylimsRight    =c(-3.85,18),
                     pst_xticks        =seq(as.Date(c("2001/7/1")),
                                            as.Date("2023/1/1"),by="1 year"),
                     pst_xlines        =seq(as.Date(c("2002/1/1")),
                                            as.Date("2023/1/1"),by="1 year"),
                     pst_yticks        =c(seq(-1.0,1.0,by=.25)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     pst_yticks_mainRight = 0,
                     pst_yticksRight   =seq(-4,6,by=2),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=2,
                     pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),
                     DateFormat    ="%y",
                     ylabel   ="Share of Price Growth or Decline",
                     ylabel_sep= 250,
                     ylabel_sepRight= 100,
                     ylabelRight ="rate in \\%",
                     
                     YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "Year")




fPSTArea(pst_root=FigureRoot,
         pst_name="RentShare",
         pst_x=as.numeric(RepeatSaleAnn$Date),
         pst_y=RepeatSaleAnn$RealRentShareBase,
         pst_y2 = RepeatSaleAnn$RealRentShareLine,
         pst=pst_box,
         color=paste0(as.character(c(255,156,96)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2020/7/1")),
         yy_1=0.55,
         label="\\parbox{1in}{\\centering Real Rent }",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=90,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="InflationShare",
         pst_x=as.numeric(RepeatSaleAnn$Date),
         pst_y=RepeatSaleAnn$InflationBase,
         pst_y2 = ifelse(RepeatSaleAnn$InflationLine > 1.55,1.55,RepeatSaleAnn$InflationLine),
         pst=pst_box,
         color=paste0(as.character(c(0,192,96)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2020/7/1")),
         yy_1=0.84,
         label="\\parbox{1in}{\\centering Inflation}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=90,
         Opacity = 0.4,
         side="left")


fPSTArea(pst_root=FigureRoot,
         pst_name="PriceRentShare",
         pst_x=as.numeric(RepeatSaleAnn$Date),
         pst_y=rep(0,NROW(RepeatSaleAnn)),
         pst_y2 =ifelse(RepeatSaleAnn$PriceRentShare< -1.55,-1.55,RepeatSaleAnn$PriceRentShare),
         pst=pst_box,
         color=paste0(as.character(c(255,232,64)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2009/6/1")),
         yy_1=-0.45,
         label="\\parbox{1in}{\\centering Price/Rent}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=90,
         Opacity = .4,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="LinePlus1",
         pst_x=xlims,
         pst_y=c(1,1),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2018/2/1")),
         yy_1=.14,
         label="",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "3pt 5pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="LineMinus1",
         pst_x=xlims,
         pst_y=c(-1,-1),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2018/2/1")),
         yy_1=.14,
         label="",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "3pt 5pt",
         dir=0,
         side="left")


fCompile(pst_root=FigureRoot,SubFiles=list("RentShare",
                                           "PriceRentShare",
                                           "InflationShare",
                                           "LinePlus1",
                                           "LineMinus1",
                                           "PSTAxes"),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()


```

## PW_HousingUpdate_104_PriceDecomp2

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_104_PriceDecomp2-1.png)

``` {r,  }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_104_PriceDecomp2"
xlims=as.Date(c("2001/1/1","2024/1/1"))


factor=0.8
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =xlims,
                     pst_ylims         =100*c(-.21,.17),
                     #pst_ylimsRight    =c(-3.85,18),
                     pst_xticks        =seq(as.Date(c("2001/7/1")),as.Date("2024/1/1"),by="1 year"),
                     pst_xlines        =seq(as.Date(c("2002/1/1")),as.Date("2023/1/1"),by="1 year"),
                     pst_yticks        =100*c(seq(-.20,.15,by=.05)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     pst_yticks_mainRight = 0,
                     pst_yticksRight   =seq(-4,6,by=2),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),
                     DateFormat    ="%y",
                     ylabel   ="Growth in \\%",
                     ylabel_sep= 150,
                     ylabel_sepRight= 100,
                     ylabelRight ="rate in \\%",
                     YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "Year")





fPSTArea(pst_root=FigureRoot,
         pst_name="PriceRentPos",
         pst_x=as.numeric(RepeatSaleLevel$Date),
         pst_y=100*rep(0,NROW(RepeatSaleLevel)),
         pst_y2 =100*RepeatSaleLevel$X2,
         pst=pst_box,
         color=paste0(as.character(c(255,232,64)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2003/6/1")),
         yy_1=2,
         label="$\\Delta$ $p^r/Rent$",
         # xx_1=last(as.numeric(RepeatSaleLevel$Date)),
         # yy_1=100*last(.5*rep(0,NROW(RepeatSaleLevel))+.5*RepeatSaleLevel$X2),
         # label="\\parbox{1in}{\\raggedright $\\leftarrow \\Delta$ $p^r/Rent$}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=90,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="PriceRentNeg",
         pst_x=as.numeric(RepeatSaleLevel$Date),
         pst_y=100*rep(0,NROW(RepeatSaleLevel)),
         pst_y2 =100*RepeatSaleLevel$X6,
         pst=pst_box,
         color=paste0(as.character(c(255,232,64)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2009/6/1")),
         yy_1=-0.45,
         label="",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=90,
         Opacity = .4,
         side="left")


fPSTArea(pst_root=FigureRoot,
         pst_name="PricePricePos",
         pst_x=as.numeric(RepeatSaleLevel$Date),
         pst_y=100*RepeatSaleLevel$X2,
         pst_y2 =100*RepeatSaleLevel$X3,
         pst=pst_box,
         color=paste0(as.character(c(179, 66, 245)/256),collapse = ","),
         xx_1=last(as.numeric(RepeatSaleLevel$Date)),
         yy_1=100*last(.5*RepeatSaleLevel$X2+.5*RepeatSaleLevel$X3),
         label="",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=0,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="PricePriceNeg",
         pst_x=as.numeric(RepeatSaleLevel$Date),
         pst_y=100*RepeatSaleLevel$X6,
         pst_y2 =100*RepeatSaleLevel$X7,
         pst=pst_box,
         color=paste0(as.character(c(179, 66, 245)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2002/6/1")),
         yy_1=-2,
         label="$\\Delta$ $p^o/p^r$",
         # xx_1=last(as.numeric(RepeatSaleLevel$Date)),
         # yy_1=100*last(.5*RepeatSaleLevel$X6+.5*RepeatSaleLevel$X7),
         # label="\\parbox{1in}{\\raggedright $\\leftarrow \\Delta$ $p^o/p^r$}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=-90,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="RealRentPos",
         pst_x=as.numeric(RepeatSaleLevel$Date),
         pst_y=100*RepeatSaleLevel$X3,
         pst_y2 =100*RepeatSaleLevel$X4,
         pst=pst_box,
         color=paste0(as.character(c(255,156,96)/256),collapse = ","),
         xx_1=last(as.numeric(RepeatSaleLevel$Date)),
         yy_1=100*last(.5*RepeatSaleLevel$X3+.5*RepeatSaleLevel$X4),
         label="",#\\parbox{1in}{\\raggedright $\\leftarrow \\Delta$ real $rent$}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=0,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="RealRentNeg",
         pst_x=as.numeric(RepeatSaleLevel$Date),
         pst_y=100*RepeatSaleLevel$X7,
         pst_y2 =100*RepeatSaleLevel$X8,
         pst=pst_box,
         color=paste0(as.character(c(255,156,96)/256),collapse = ","),
         xx_1=last(as.numeric(RepeatSaleLevel$Date)),
         yy_1=100*last(.5*RepeatSaleLevel$X7+.5*RepeatSaleLevel$X8),
         label="\\parbox{1in}{\\raggedright $\\leftarrow \\Delta$ real $rent$}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=0,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="InflationPos",
         pst_x=as.numeric(RepeatSaleLevel$Date),
         pst_y=100*RepeatSaleLevel$X4,
         pst_y2 =100*RepeatSaleLevel$X5,
         pst=pst_box,
         color=paste0(as.character(c(0,192,96)/256),collapse = ","),
         xx_1=last(as.numeric(RepeatSaleLevel$Date)),
         yy_1=100*last(.5*RepeatSaleLevel$X4+.5*RepeatSaleLevel$X5),
         label="\\parbox{1in}{\\raggedright $\\leftarrow$ Inflation}",
        LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=0,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="InflationNeg",
         pst_x=as.numeric(RepeatSaleLevel$Date),
         pst_y=100*RepeatSaleLevel$X8,
         pst_y2 =100*RepeatSaleLevel$X9,
         pst=pst_box,
         color=paste0(as.character(c(0,192,96)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2009/6/1")),
         yy_1=-0.45,
         label="",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=90,
         Opacity = .4,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="PriceGrowth",
         pst_x=as.numeric(RepeatSaleLevel3$Date),
         pst_y=100*RepeatSaleLevel3$X10,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2007/9/15")),
         yy_1=-.07*100,
         label="",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1.5pt",
         LineDash = "2pt 1pt",
         dir=45,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="PriceGrowthLabel",
         pst_x=c(as.numeric(tail(RepeatSaleLevel3$Date,3)[1])+50,tail(RepeatSaleLevel3$Date,3)[1]+400),
         pst_y=rep(tail(100*RepeatSaleLevel3$X10,3)[1],2),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(tail(RepeatSaleLevel3$Date,3)[1])+400,
         yy_1=last(tail(100*RepeatSaleLevel3$X10,3)[1]),
         label="$\\Delta p^o$",
         LineStyle = "solid",
         arrows = "<-",
         sep=0.1,
         LineWidth=".35pt",
         LineDash = "2pt 1pt",
         dir=0,
         side="left")



fCompile(pst_root=FigureRoot,SubFiles=list("PriceRentPos","PriceRentNeg",
                                           "PricePricePos","PricePriceNeg",
                                           "RealRentPos","RealRentNeg",
                                           "InflationPos","InflationNeg",
                                           "PriceGrowth","PriceGrowthLabel",
                                           "PSTAxes"),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```

## PW_HousingUpdate_104b_PriceDecomp2Owner


```{r}
 rs_owner <- RepeatSale %>% select(year,Date,
                                         coefiProp,coefooProp,coefrentProp,
                                         inflation) %>%
     mutate(coefPriceRent=coefooProp-coefrentProp) %>%
     mutate(coefRealRent=coefrentProp-inflation) %>%
     mutate(signP=sign(coefooProp),
            signRealRent=sign(coefRealRent),
            signPriceRent=sign(coefPriceRent),
            signInflation=sign(inflation),
            signRent=sign(coefrentProp)) 

xx <- rs_owner %>% select(coefPriceRent,
                                 coefRealRent,
                                 inflation) %>%
     as.matrix(.)
yy <- rs_owner %>% 
     select(signPriceRent,
            signRealRent,
           signInflation) 
rs_owner_l <- data.frame(cbind(rs_owner$year,
                                    (xx*as.matrix(yy>0))%*%upper.tri(matrix(1,3,3),
                                                                     diag = TRUE),
                                    (xx*as.matrix(yy<0))%*%upper.tri(matrix(1,3,3),
                                                                     diag = TRUE),
                                    rs_owner$coefooProp)) %>%
     mutate(Date=as.Date(paste0(X1,"/1/1")))

rs_owner_l2 <- rs_owner_l %>% 
     mutate(Date=as.Date(paste0(X1,"/12/31")))
rs_owner_l <- rbind(rs_owner_l,rs_owner_l2) %>% 
     arrange(Date)

rs_owner_l3 <- rs_owner_l %>% 
     mutate(Date=as.Date(paste0(X1,"/7/1")))

```



![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_104b_PriceDecomp2Owner-1.png)

``` {r,  }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_104b_PriceDecomp2Owner"
xlims=as.Date(c("2001/1/1","2024/1/1"))


factor=0.8
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =xlims,
                     pst_ylims         =100*c(-.16,.17),
                     #pst_ylimsRight    =c(-3.85,18),
                     pst_xticks        =seq(as.Date(c("2001/7/1")),as.Date("2024/1/1"),by="1 year"),
                     pst_xlines        =seq(as.Date(c("2002/1/1")),as.Date("2024/1/1"),by="1 year"),
                     pst_yticks        =100*c(seq(-.15,.15,by=.05)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     pst_yticks_mainRight = 0,
                     pst_yticksRight   =seq(-4,6,by=2),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),
                     DateFormat    ="%y",
                     ylabel   ="Growth in \\%",
                     ylabel_sep= 150,
                     ylabel_sepRight= 100,
                     ylabelRight ="rate in \\%",
                     YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "Year")





fPSTArea(pst_root=FigureRoot,
         pst_name="PriceRentPos",
         pst_x=as.numeric(rs_owner_l$Date),
         pst_y=100*rep(0,NROW(rs_owner_l)),
         pst_y2 =100*rs_owner_l$X2,
         pst=pst_box,
         color=paste0(as.character(c(255,232,64)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2003/6/1")),
         yy_1=1,
         label="$\\Delta$ $p^o/Rent$",
         # xx_1=last(as.numeric(rs_owner_l$Date)),
         # yy_1=100*last(.5*rep(0,NROW(rs_owner_l))+.5*rs_owner_l$X2),
         # label="\\parbox{1in}{\\raggedright $\\leftarrow \\Delta$ $p^r/Rent$}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=90,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="PriceRentNeg",
         pst_x=as.numeric(rs_owner_l$Date),
         pst_y=100*rep(0,NROW(rs_owner_l)),
         pst_y2 =100*rs_owner_l$X5,
         pst=pst_box,
         color=paste0(as.character(c(255,232,64)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2009/6/1")),
         yy_1=-0.45,
         label="",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=90,
         Opacity = .4,
         side="left")




fPSTArea(pst_root=FigureRoot,
         pst_name="RealRentPos",
         pst_x=as.numeric(rs_owner_l$Date),
         pst_y=100*rs_owner_l$X2,
         pst_y2 =100*rs_owner_l$X3,
         pst=pst_box,
         color=paste0(as.character(c(255,156,96)/256),collapse = ","),
         xx_1=last(as.numeric(rs_owner_l$Date)),
         yy_1=100*last(.5*rs_owner_l$X2+.5*rs_owner_l$X3),
         label="",#"\\parbox{1in}{\\raggedright $\\leftarrow \\Delta$ real $rent$}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=0,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="RealRentNeg",
         pst_x=as.numeric(rs_owner_l$Date),
         pst_y=100*rs_owner_l$X5,
         pst_y2 =100*rs_owner_l$X6,
         pst=pst_box,
         color=paste0(as.character(c(255,156,96)/256),collapse = ","),
         xx_1=last(as.numeric(rs_owner_l$Date)),
         yy_1=100*last(.5*rs_owner_l$X5+.5*rs_owner_l$X6),
         label="\\parbox{1in}{\\raggedright $\\leftarrow \\Delta$ real $rent$}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=0,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="InflationPos",
         pst_x=as.numeric(rs_owner_l$Date),
         pst_y=100*rs_owner_l$X3,
         pst_y2 =100*rs_owner_l$X4,
         pst=pst_box,
         color=paste0(as.character(c(0,192,96)/256),collapse = ","),
         xx_1=last(as.numeric(rs_owner_l$Date)),
         yy_1=100*last(.5*rs_owner_l$X3+.5*rs_owner_l$X4),
         label="\\parbox{1in}{\\raggedright $\\leftarrow$ Inflation}",
        LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=0,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="InflationNeg",
         pst_x=as.numeric(rs_owner_l$Date),
         pst_y=100*rs_owner_l$X6,
         pst_y2 =100*rs_owner_l$X7,
         pst=pst_box,
         color=paste0(as.character(c(0,192,96)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2009/6/1")),
         yy_1=-0.45,
         label="",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=90,
         Opacity = .4,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="PriceGrowth",
         pst_x=as.numeric(rs_owner_l3$Date),
         pst_y=100*rs_owner_l3$X8,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2007/9/15")),
         yy_1=-.07*100,
         label="",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1.5pt",
         LineDash = "2pt 1pt",
         dir=45,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="PriceGrowthLabel",
         pst_x=c(as.numeric(tail(RepeatSaleLevel3$Date,3)[1])+50,tail(RepeatSaleLevel3$Date,3)[1]+400),
         pst_y=rep(tail(100*RepeatSaleLevel3$X10,3)[1],2),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(tail(RepeatSaleLevel3$Date,3)[1])+400,
         yy_1=last(tail(100*RepeatSaleLevel3$X10,3)[1]),
         label="$\\Delta p^o$",
         LineStyle = "solid",
         arrows = "<-",
         sep=0.1,
         LineWidth=".35pt",
         LineDash = "2pt 1pt",
         dir=0,
         side="left")



fCompile(pst_root=FigureRoot,SubFiles=list("PriceRentPos","PriceRentNeg",
                                           # "PricePricePos","PricePriceNeg",
                                           "RealRentPos","RealRentNeg",
                                           "InflationPos","InflationNeg",
                                           "PriceGrowth","PriceGrowthLabel",
                                           "PSTAxes"),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```


## PW_HousingUpdate_105_PriceDecomp2NoInflation




![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_105_PriceDecomp2NoInflation-1.png)

``` {r  }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_105_PriceDecomp2NoInflation"

xlims=as.Date(c("2001/1/1","2024/2/1"))

factor=0.8
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =xlims,
                     pst_ylims         =100*c(-.18,.17),
                     #pst_ylimsRight    =c(-3.85,18),
                     pst_xticks        =seq(as.Date(c("2001/7/1")),as.Date("2024/1/1"),by="1 year"),
                     pst_xlines        =seq(as.Date(c("2002/1/1")),as.Date("2024/1/1"),by="1 year"),
                     pst_yticks        =100*c(seq(-.15,.15,by=.05)),
                     factor            =0.8,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     pst_yticks_mainRight = 0,
                     pst_yticksRight   =seq(-4,6,by=2),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),
                     DateFormat    ="%y",
                     ylabel   ="Growth in \\%",
                     ylabel_sep= 150,
                     ylabel_sepRight= 100,
                     ylabelRight ="rate in \\%",
                     YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "Year")





fPSTArea(pst_root=FigureRoot,
         pst_name="PriceRentPos",
         pst_x=as.numeric(RepeatSaleNoInflation$Date),
         pst_y=100*rep(0,NROW(RepeatSaleNoInflation)),
         pst_y2 =100*RepeatSaleNoInflation$X2,
         pst=pst_box,
         color=paste0(as.character(c(255,232,64)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2003/6/1")),
         yy_1=2,
         label="$\\Delta$ $p^r/Rent$",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=090,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="PriceRentNeg",
         pst_x=as.numeric(RepeatSaleNoInflation$Date),
         pst_y=100*rep(0,NROW(RepeatSaleNoInflation)),
         pst_y2 =100*RepeatSaleNoInflation$X5,
         pst=pst_box,
         color=paste0(as.character(c(255,232,64)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2009/6/1")),
         yy_1=-0.45,
         label="",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=90,
         Opacity = .4,
         side="left")


fPSTArea(pst_root=FigureRoot,
         pst_name="PricePricePos",
         pst_x=as.numeric(RepeatSaleNoInflation$Date),
         pst_y=100*RepeatSaleNoInflation$X2,
         pst_y2 =100*RepeatSaleNoInflation$X3,
         pst=pst_box,
         color=paste0(as.character(c(179, 66, 245)/256),collapse = ","),
         xx_1=last(as.numeric(RepeatSaleNoInflation$Date)),
         yy_1=100*last(.5*RepeatSaleNoInflation$X2+.5*RepeatSaleNoInflation$X3),
         label="",#"\\parbox{1in}{\\raggedright $\\leftarrow \\Delta$ $p^o/p^r$}",
        LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=0,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="PricePriceNeg",
         pst_x=as.numeric(RepeatSaleNoInflation$Date),
         pst_y=100*RepeatSaleNoInflation$X5,
         pst_y2 =100*RepeatSaleNoInflation$X6,
         pst=pst_box,
         color=paste0(as.character(c(179, 66, 245)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2002/6/1")),
         yy_1=-2,
         label="$\\Delta$ $p^o/p^r$",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=-90,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="RentPos",
         pst_x=as.numeric(RepeatSaleNoInflation$Date),
         pst_y=100*RepeatSaleNoInflation$X3,
         pst_y2 =100*RepeatSaleNoInflation$X4,
         pst=pst_box,
         color=paste0(as.character(c(255,156,96)/256),collapse = ","),
         xx_1=last(as.numeric(RepeatSaleNoInflation$Date)),
         yy_1=100*last(.5*RepeatSaleNoInflation$X3+.5*RepeatSaleNoInflation$X4),
         label="\\parbox{1in}{\\raggedright $\\leftarrow \\Delta$ $Rent$}",
        LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=0,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="RentNeg",
         pst_x=as.numeric(RepeatSaleNoInflation$Date),
         pst_y=100*RepeatSaleNoInflation$X6,
         pst_y2 =100*RepeatSaleNoInflation$X7,
         pst=pst_box,
         color=paste0(as.character(c(255,156,96)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2009/6/1")),
         yy_1=-0.45,
         label="",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=90,
         Opacity = .4,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="PriceGrowth",
         pst_x=as.numeric(RepeatSaleNoInflation3$Date),
         pst_y=100*RepeatSaleNoInflation3$X8,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2007/9/15")),
         yy_1=-.07*100,
         label="",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1.5pt",
         LineDash = "2pt 1pt",
         dir=45,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="PriceGrowthLabel",
         pst_x=c(as.numeric(tail(RepeatSaleLevel3$Date,3)[1])+50,tail(RepeatSaleLevel3$Date,3)[1]+400),
         pst_y=rep(tail(100*RepeatSaleLevel3$X10,3)[1],2),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(tail(RepeatSaleLevel3$Date,3)[1])+400,
         yy_1=last(tail(100*RepeatSaleLevel3$X10,3)[1]),
         label="$\\Delta p^o$",
         LineStyle = "solid",
         arrows = "<-",
         sep=0.1,
         LineWidth=".35pt",
         LineDash = "2pt 1pt",
         dir=0,
         side="left")



fCompile(pst_root=FigureRoot,SubFiles=list("PriceRentPos","PriceRentNeg",
                                           "PricePricePos","PricePriceNeg",
                                           "RentPos","RentNeg",
                                          "PriceGrowth","PriceGrowthLabel",
                                           "PSTAxes"),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()
```

## PW_HousingUpdate_106_ZillowDecomposition

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_106_ZillowDecomposition-1.png)


``` {r,  }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_106_ZillowDecomposition"

pr_series<- rhm %>% select(Date,USZHV,USZOI,UIXFDHEN) %>%
     na.omit

pr_series <- pr_series %>%
     mutate(RentGrowth=(log(USZOI)-lag(log(USZOI),12))) %>%
     mutate(InflationGrowth=(log(UIXFDHEN)-lag(log(UIXFDHEN),12))) %>%
     mutate(PRGrowth=
                 (log(USZHV)-lag(log(USZHV),12)-
                       (log(USZOI)-lag(log(USZOI),12))) ) %>%
     mutate(PriceGrowth=(log(USZHV)-lag(log(USZHV),12))) %>%
     mutate(RealRentGrowth=RentGrowth-InflationGrowth) %>%
     mutate(RealRentShare=RealRentGrowth/PriceGrowth,
            RealRentShare=ifelse(RealRentShare<0,0,RealRentShare)) %>%
     mutate(PRShare=1-PRGrowth/PriceGrowth,PRShare=ifelse(PRShare>1,1,PRShare))

last_date<-max(pr_series$Date)

factor=0.8
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2017/1/1"),Sys.Date()+30),
                     pst_ylims         =c(-3,19),
                     #pst_ylimsRight    =c(-3.85,18),
                     pst_xticks        =seq(as.Date(c("2017/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2018/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =c(seq(0,16,by=4)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     pst_yticks_mainRight = 0,
                     pst_yticksRight   =seq(-4,6,by=2),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),
                     DateFormat    ="%Y",
                     ylabel   ="in \\%",
                     ylabel_sep= 50,
                     ylabel_sepRight= 100,
                     ylabelRight ="rate in \\%",
                     YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "Year")

fPSTLine(pst_root=FigureRoot,
         pst_name="RealRentGrowth",
         pst_x=as.numeric(pr_series$Date),
         pst_y=100*pr_series$RealRentGrowth,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(pr_series$Date)),
         yy_1=100*last(pr_series$RealRentGrowth),
         label="\\parbox{2in}{\\raggedright$\\leftarrow$ (1) Real Rent Growth}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="NominalRentGrowth",
         pst_x=as.numeric(pr_series$Date),
         pst_y=100*pr_series$RealRentGrowth+100*pr_series$InflationGrowth,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(pr_series$Date)),
         yy_1=100*last(pr_series$RealRentGrowth)+100*last(pr_series$InflationGrowth),
         label="\\parbox{2in}{\\raggedright$\\leftarrow$ (2) Nominal Rent Growth}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="PriceRentGrowth",
         pst_x=as.numeric(pr_series$Date),
         pst_y=100*pr_series$PRGrowth,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2015/4/1")),
         yy_1=-1,
         label="\\parbox{0.8in}{\\raggedright (3) Price/Rent Growth}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 2pt",
         dir=-45,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="PriceGrowth",
         pst_x=as.numeric(pr_series$Date),
         pst_y=100*pr_series$PriceGrowth,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(pr_series$Date))-20,
         yy_1=100*last(pr_series$PriceGrowth),
         label="\\parbox{2in}{\\raggedright$\\leftarrow$ (3) Price Growth}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="PriceRentText",
         pst=pst_box,
         pst_x=c(as.numeric(last(pr_series$Date)),
                 as.numeric(last(pr_series$Date)))+50,
         pst_y=c(100*last(pr_series$PriceGrowth)-.3,100*
                      last(pr_series$RealRentGrowth)+
                      100*last(pr_series$InflationGrowth)+.3),
         arrows="<->",
         LineWidth = "0.5pt",
         color = "black",
         xx_1=as.numeric(last(pr_series$Date))+100,
         yy_1=mean(c(100*last(pr_series$PriceGrowth)-.3,100*
                          last(pr_series$RealRentGrowth)+100*last(pr_series$InflationGrowth)+.3)),
         label="\\parbox{1.25in}{\\raggedright (3)$-$(2) Effect of Price/Rent Growth}",
         sep=0.1,
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="InflationText",
         pst=pst_box,
         pst_x=c(as.numeric(last(pr_series$Date)),
                 as.numeric(last(pr_series$Date)))+50,
         pst_y=c(100*last(pr_series$RealRentGrowth)+
                      100*last(pr_series$InflationGrowth)-.3,
                 100*last(pr_series$RealRentGrowth)+.3),
         arrows="<->",
         LineWidth = "0.5pt",
         color = "black",
         xx_1=as.numeric(last(pr_series$Date))+100,
         yy_1=mean(c(100*last(pr_series$RealRentGrowth)+
                          100*last(pr_series$InflationGrowth)-.3,
                     100*last(pr_series$RealRentGrowth)+.3)),
         label="\\parbox{1.25in}{\\raggedright (2)$-$(1) Effect of Inflation}",
         sep=0.1,
         dir=0,
         side="left")


fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes"
                       ,"RealRentGrowth"
                       ,"NominalRentGrowth"
                       # ,"PriceGrowth"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```

## PW_HousingUpdate_106b_ZillowDecompositionSA

Old Note:  Note that these figure is using year-on-year differences because there are big seasonals with rents.  Since I am dealing with seasonal adjustment by taking differences I used the NSA rent series from Zillow.  However,  for the price series, Zillow only reports an SA series (although I am not 100% sure that the price series is SA because the only mention of SA is in the chart legend.  There's no mention of seasonal adjustment in the series definition nor does the mnemonic have an "A" at the end).  Choice of the SA versus NSA series matters a lot.  Using the SA rent series, real rent growth has gone up and all the decline in prices results from declines in the price-rent ratio.  Using the NSA series, by contrast, implies that real rent growth has fallen and the price-rent ratio growth has *increased*.  It is important to stress, because it is easy to forget, that all these series are still growing rapidly:  even using the NSA differences, we find that real rent growth is growing at more than 6 percent per year and prices are growing 16 percent per year. 

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_106b_ZillowDecompositionSA-1.png)


``` {r,  }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_106b_ZillowDecompositionSA"

pr_series<- rhm %>% select(Date,USZHV,USZOIA,UIXFDHEN) %>%
     na.omit

pr_series <- pr_series %>%
     mutate(RentGrowth=(log(USZOIA)-lag(log(USZOIA),12))) %>%
     mutate(InflationGrowth=(log(UIXFDHEN)-lag(log(UIXFDHEN),12))) %>%
     mutate(PRGrowth=(log(USZHV)-lag(log(USZHV),12)-(log(USZOIA)-lag(log(USZOIA),12))) ) %>%
     mutate(PriceGrowth=(log(USZHV)-lag(log(USZHV),12))) %>%
     mutate(RealRentGrowth=RentGrowth-InflationGrowth) %>%
     mutate(RealRentShare=RealRentGrowth/PriceGrowth,RealRentShare=ifelse(RealRentShare<0,0,RealRentShare)) %>%
     mutate(PRShare=1-PRGrowth/PriceGrowth,PRShare=ifelse(PRShare>1,1,PRShare))


last_date<-max(pr_series$Date)

factor=0.8
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2015/1/1"),Sys.Date()+30),
                     pst_ylims         =c(-3,19),
                     #pst_ylimsRight    =c(-3.85,18),
                     pst_xticks        =seq(as.Date(c("2015/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2016/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =c(seq(0,16,by=4)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     pst_yticks_mainRight = 0,
                     pst_yticksRight   =seq(-4,6,by=2),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),
                     DateFormat    ="%Y",
                     ylabel   ="in \\%",
                     ylabel_sep= 50,
                     ylabel_sepRight= 100,
                     ylabelRight ="rate in \\%",
                     YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "Year")




fPSTLine(pst_root=FigureRoot,
         pst_name="RealRentGrowth",
         pst_x=as.numeric(pr_series$Date),
         pst_y=100*pr_series$RealRentGrowth,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(pr_series$Date)),
         yy_1=100*last(pr_series$RealRentGrowth),
         label="\\parbox{2in}{\\raggedright$\\leftarrow$ (1) Real Rent Growth}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="NominalRentGrowth",
         pst_x=as.numeric(pr_series$Date),
         pst_y=100*pr_series$RealRentGrowth+100*pr_series$InflationGrowth,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(pr_series$Date)),
         yy_1=100*last(pr_series$RealRentGrowth)+100*last(pr_series$InflationGrowth),
         label="\\parbox{2in}{\\raggedright$\\leftarrow$ (2) Nominal Rent Growth}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="PriceRentGrowth",
         pst_x=as.numeric(pr_series$Date),
         pst_y=100*pr_series$PRGrowth,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2015/4/1")),
         yy_1=-1,
         label="\\parbox{0.8in}{\\raggedright (3) Price/Rent Growth}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 2pt",
         dir=-45,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="PriceGrowth",
         pst_x=as.numeric(pr_series$Date),
         pst_y=100*pr_series$PriceGrowth,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(pr_series$Date)),
         yy_1=100*last(pr_series$PriceGrowth),
         label="\\parbox{2in}{\\raggedright$\\leftarrow$ (3) Price Growth}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="PriceRentText",
         pst=pst_box,
         pst_x=c(as.numeric(last(pr_series$Date)),as.numeric(last(pr_series$Date)))+50,
         pst_y=c(100*last(pr_series$PriceGrowth)-.3,100*last(pr_series$RealRentGrowth)+100*last(pr_series$InflationGrowth)+.3),
         arrows="<->",
         LineWidth = "0.5pt",
         color = "black",
         xx_1=as.numeric(last(pr_series$Date))+100,
         yy_1=mean(c(100*last(pr_series$PriceGrowth)-.3,100*last(pr_series$RealRentGrowth)+100*last(pr_series$InflationGrowth)+.3)),
         label="\\parbox{1.25in}{\\raggedright (3)$-$(2) Effect of Price/Rent Growth}",
         sep=0.1,
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="InflationText",
         pst=pst_box,
         pst_x=c(as.numeric(last(pr_series$Date)),as.numeric(last(pr_series$Date)))+50,
         pst_y=c(100*last(pr_series$RealRentGrowth)+100*last(pr_series$InflationGrowth)-.3,100*last(pr_series$RealRentGrowth)+.3),
         arrows="<->",
         LineWidth = "0.5pt",
         color = "black",
         xx_1=as.numeric(last(pr_series$Date))+100,
         yy_1=mean(c(100*last(pr_series$RealRentGrowth)+100*last(pr_series$InflationGrowth)-.3,100*last(pr_series$RealRentGrowth)+.3)),
         label="\\parbox{1.25in}{\\raggedright (2)$-$(1) Effect of Inflation}",
         sep=0.1,
         dir=0,
         side="left")

fCompile(pst_root=FigureRoot,SubFiles=list("PSTAxes",
                                           "RealRentGrowth",
                                           "NominalRentGrowth",
                                           "PriceGrowth",
                                           "PriceRentText",
                                           "InflationText"),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()
```

## PW_HousingUpdate_107_CoreLogicDecomposition

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_107_CoreLogicDecomposition-1.png)


``` {r,  }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_107_CoreLogicDecomposition"
pr_series <- PR_National %>%
     mutate(RentGrowth=(log(sfri_dollar)-lag(log(sfri_dollar),4))) %>%
     mutate(InflationGrowth=(log(UIXFDHEN)-lag(log(UIXFDHEN),4))) %>%
     mutate(PRGrowth=
                 (log(hpi_dollar)-lag(log(hpi_dollar),4)-
                       (log(sfri_dollar)-lag(log(sfri_dollar),4))) ) %>%
     mutate(PriceGrowth=(log(hpi_dollar)-lag(log(hpi_dollar),4))) %>%
     mutate(RealRentGrowth=RentGrowth-InflationGrowth) %>%
     mutate(RealRentShare=RealRentGrowth/PriceGrowth,
            RealRentShare=ifelse(RealRentShare<0,0,RealRentShare)) %>%
     mutate(PRShare=1-PRGrowth/PriceGrowth,PRShare=ifelse(PRShare>1,1,PRShare)) %>%
     drop_na()
last_date<-max(pr_series$Date)


factor=0.75
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2017/1/1"),Sys.Date()+30),
                     pst_ylims         =c(-19,19),
                     pst_ylimsRight    =c(2.5,14),
                     pst_xticks        =seq(as.Date(c("2017/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2018/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =c(seq(0,15,by=5)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     pst_yticks_mainRight = 0,
                     pst_yticksRight   =seq(3,8,by=1),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),
                     DateFormat    ="%Y",
                     ylabel   ="\\footnotesize in \\%",
                     ylabel_sep= 35,
                     ylabel_sepRight= 35,
                     ylabelRight =
                          "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "")

fPSTLine(pst_root=FigureRoot,
         pst_name="RealRentGrowth",
         pst_x=as.numeric(pr_series$date)+45,
         pst_y=100*pr_series$RealRentGrowth,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(pr_series$date)+45),
         yy_1=100*last(pr_series$RealRentGrowth),
         label="\\parbox{2in}{\\raggedright$\\leftarrow$ Real Rent Growth}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="NominalRentGrowth",
         pst_x=as.numeric(pr_series$date)+45,
         pst_y=100*pr_series$RealRentGrowth+100*pr_series$InflationGrowth,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(pr_series$date)+45),
         yy_1=100*last(pr_series$RealRentGrowth)+100*last(pr_series$InflationGrowth),
         label="\\parbox{2in}{\\raggedright$\\leftarrow$ Rent Inflation}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")
# fPSTLine(pst_root=FigureRoot,
#          pst_name="PriceRentGrowth",
#          pst_x=as.numeric(pr_series$date),
#          pst_y=100*pr_series$PRGrowth,
#          pst=pst_box,
#          color="black",
#          xx_1=as.numeric(as.Date("2015/4/1")),
#          yy_1=-1,
#          label="\\parbox{0.8in}{\\raggedright (3) Price/Rent Growth}",
#          LineStyle = "dashed",
#          sep=0.1,
#          LineWidth="1pt",
#          LineDash = "1pt 2pt",
#          dir=-45,
#          side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="PriceGrowth",
         pst_x=as.numeric(pr_series$date)+45,
         pst_y=100*pr_series$PriceGrowth,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(pr_series$date)+45),
         yy_1=100*last(pr_series$PriceGrowth),
         label="\\parbox{2in}{\\raggedright$\\leftarrow$ Price Inflation}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")
# fPSTLine(pst_root=FigureRoot,
#          pst_name="PriceRentText",
#          pst=pst_box,
#          pst_x=c(as.numeric(last(pr_series$date)),
#                  as.numeric(last(pr_series$date)))+50,
#          pst_y=c(100*last(pr_series$PriceGrowth)-.3,100*
#                       last(pr_series$RealRentGrowth)+
#                       100*last(pr_series$InflationGrowth)+.3),
#          arrows="<->",
#          LineWidth = "0.5pt",
#          color = "black",
#          xx_1=as.numeric(last(pr_series$date))+100,
#          yy_1=mean(c(100*last(pr_series$PriceGrowth)-.3,100*
#                           last(pr_series$RealRentGrowth)+100*last(pr_series$InflationGrowth)+.3)),
#          label="\\parbox{1.25in}{\\raggedright (3)$-$(2) Effect of Price/Rent Growth}",
#          sep=0.1,
#          dir=0,
#          side="left")
#
# fPSTLine(pst_root=FigureRoot,
#          pst_name="InflationText",
#          pst=pst_box,
#          pst_x=c(as.numeric(last(pr_series$date)),
#                  as.numeric(last(pr_series$date)))+50,
#          pst_y=c(100*last(pr_series$RealRentGrowth)+
#                       100*last(pr_series$InflationGrowth)-.3,
#                  100*last(pr_series$RealRentGrowth)+.3),
#          arrows="<->",
#          LineWidth = "0.5pt",
#          color = "black",
#          xx_1=as.numeric(last(pr_series$date))+100,
#          yy_1=mean(c(100*last(pr_series$RealRentGrowth)+
#                           100*last(pr_series$InflationGrowth)-.3,
#                      100*last(pr_series$RealRentGrowth)+.3)),
#          label="\\parbox{1.25in}{\\raggedright (2)$-$(1) Effect of Inflation}",
#          sep=0.1,
#          dir=0,
#          side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="RentPrice",
         pst_x=as.numeric(pr_series$date)+45,
         pst_y=1200*pr_series$sfri_dollar/pr_series$hpi_dollar,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(pr_series$date)+45),
         yy_1=last(1200*pr_series$sfri_dollar/
                        pr_series$hpi_dollar),
         label="\\parbox{2in}{\\raggedright$\\leftarrow$ Rent/Price Ratio}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="right")

fPSTLine(pst_root=FigureRoot,
         pst_name="CapRate",
         pst_x=as.numeric(pr_series$date)+45,
         pst_y=100*pr_series$market_cap_rate,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(pr_series$date)+45),
         yy_1=last(100*pr_series$market_cap_rate),
         label="\\parbox{2in}{\\raggedright$\\leftarrow$ Multi-family Cap Rate}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "5pt 5pt",
         dir=0,
         side="right")



frm30 <- rhw %>% subset(select=c(Date,FRM30,FCM10,year)) %>%
     mutate(quarter=quarter(Date)) %>%group_by(year,quarter) %>%
     summarize(FRM30=mean(FRM30,na.rm=TRUE),
               FCM10=mean(FCM10,na.rm=TRUE)) %>%
     mutate(Date=as.Date(paste0(year,"/",quarter*3-2,"/1")))

fPSTLine(pst_root=FigureRoot,
         pst_name="FRM30",
         pst_x=as.numeric(frm30$Date),
         pst_y=frm30$FRM30,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(frm30$Date)),
         yy_1=last(frm30$FRM30),
         label="\\parbox{2in}{\\raggedright$\\swarrow$ 30-yr Mortgage Rate}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=45,
         side="right")


fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes",
                       "RealRentGrowth",
                       "NominalRentGrowth",
                       "PriceGrowth",
                       "RentPrice",
                       "FRM30",
                       "CapRate"),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```

## PW_HousingUpdate_108_CostarDecomposition

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_108_CostarDecomposition-1.png) 
``` {r,  }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_108_CostarDecomposition"

pr_series <- Costar_National %>%
     mutate(RentGrowth=4*(log(market_effective_rent_unit)-
                               lag(log(market_effective_rent_unit),1))) %>%
     mutate(InflationGrowth=4*(log(UIXFDHEN)-lag(log(UIXFDHEN),1))) %>%
     mutate(PRGrowth=
                 4*(log(market_sale_price_per_unit)-
                         lag(log(market_sale_price_per_unit),1)-
                         4*(log(market_effective_rent_unit)-
                                 lag(log(market_effective_rent_unit),1))) ) %>%
     mutate(PriceGrowth=4*(log(market_sale_price_per_unit)-
                                lag(log(market_sale_price_per_unit),1))) %>%
     mutate(RealRentGrowth=RentGrowth-InflationGrowth) %>%
     mutate(RealRentShare=RealRentGrowth/PriceGrowth,
            RealRentShare=ifelse(RealRentShare<0,0,RealRentShare)) %>%
     mutate(PRShare=1-PRGrowth/PriceGrowth,PRShare=ifelse(PRShare>1,1,PRShare)) %>%
     drop_na()
last_date<-max(pr_series$Date)

factor=0.75
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2017/1/1"),Sys.Date()+30),
                     pst_ylims         =c(-35,24),
                     pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("2017/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2018/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =c(seq(-10,20,by=5)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     pst_yticks_mainRight = 0,
                     pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     pst_yticks_decimalRight = 1,
                     aspect            =1,
                     DateFormat    ="%Y",
                     ylabel   ="\\footnotesize in \\%",
                     ylabel_sep= 35,
                     ylabel_sepRight= 35,
                     ylabelRight =
                          "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "")

fPSTLine(pst_root=FigureRoot,
         pst_name="RealRentGrowth",
         pst_x=as.numeric(pr_series$date),
         pst_y=100*pr_series$RealRentGrowth,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(pr_series$date)),
         yy_1=100*last(pr_series$RealRentGrowth),
         label="\\parbox{2in}{\\raggedright$\\leftarrow$ Real Rent Growth}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="NominalRentGrowth",
         pst_x=as.numeric(pr_series$date),
         pst_y=100*pr_series$RealRentGrowth+100*pr_series$InflationGrowth,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(tail(pr_series$date,n=1)[1]),
         yy_1=100*tail(pr_series$RealRentGrowth,n=1)[1]+
              100*tail(pr_series$InflationGrowth,n=1)[1]+1,
         label="\\parbox{2in}{\\raggedright$\\swarrow$ Rent Inflation}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")
# fPSTLine(pst_root=FigureRoot,
#          pst_name="PriceRentGrowth",
#          pst_x=as.numeric(pr_series$date),
#          pst_y=100*pr_series$PRGrowth,
#          pst=pst_box,
#          color="black",
#          xx_1=as.numeric(as.Date("2015/4/1")),
#          yy_1=-1,
#          label="\\parbox{0.8in}{\\raggedright (3) Price/Rent Growth}",
#          LineStyle = "dashed",
#          sep=0.1,
#          LineWidth="1pt",
#          LineDash = "1pt 2pt",
#          dir=-45,
#          side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="PriceGrowth",
         pst_x=as.numeric(pr_series$date),
         pst_y=100*pr_series$PriceGrowth,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(tail(pr_series$date,n=2)[1]),
         yy_1=100*tail(pr_series$PriceGrowth,n=2)[1],
         label="\\parbox{2in}{\\raggedright$\\leftarrow$ Price Inflation}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")
# fPSTLine(pst_root=FigureRoot,
#          pst_name="PriceRentText",
#          pst=pst_box,
#          pst_x=c(as.numeric(last(pr_series$date)),
#                  as.numeric(last(pr_series$date)))+50,
#          pst_y=c(100*last(pr_series$PriceGrowth)-.3,100*
#                       last(pr_series$RealRentGrowth)+
#                       100*last(pr_series$InflationGrowth)+.3),
#          arrows="<->",
#          LineWidth = "0.5pt",
#          color = "black",
#          xx_1=as.numeric(last(pr_series$date))+100,
#          yy_1=mean(c(100*last(pr_series$PriceGrowth)-.3,100*
#                           last(pr_series$RealRentGrowth)+100*last(pr_series$InflationGrowth)+.3)),
#          label="\\parbox{1.25in}{\\raggedright (3)$-$(2) Effect of Price/Rent Growth}",
#          sep=0.1,
#          dir=0,
#          side="left")
#
# fPSTLine(pst_root=FigureRoot,
#          pst_name="InflationText",
#          pst=pst_box,
#          pst_x=c(as.numeric(last(pr_series$date)),
#                  as.numeric(last(pr_series$date)))+50,
#          pst_y=c(100*last(pr_series$RealRentGrowth)+
#                       100*last(pr_series$InflationGrowth)-.3,
#                  100*last(pr_series$RealRentGrowth)+.3),
#          arrows="<->",
#          LineWidth = "0.5pt",
#          color = "black",
#          xx_1=as.numeric(last(pr_series$date))+100,
#          yy_1=mean(c(100*last(pr_series$RealRentGrowth)+
#                           100*last(pr_series$InflationGrowth)-.3,
#                      100*last(pr_series$RealRentGrowth)+.3)),
#          label="\\parbox{1.25in}{\\raggedright (2)$-$(1) Effect of Inflation}",
#          sep=0.1,
#          dir=0,
#          side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="RentPrice",
         pst_x=as.numeric(pr_series$date),
         pst_y=1200*pr_series$market_effective_rent_unit/
              pr_series$market_sale_price_per_unit,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(pr_series$date)),
         yy_1=last(1200*pr_series$market_effective_rent_unit/
                        pr_series$market_sale_price_per_unit),
         label="\\parbox{2in}{\\raggedright$\\leftarrow$ Rent/Price Ratio}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="right")

fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes",
                       # "RealRentGrowth",
                       "NominalRentGrowth",
                       "PriceGrowth",
                       "RentPrice"),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```



```{r}

PR_National <- PR_National %>% mutate(quarter=quarter(date))

write_csv(PR_National,"/home/a1psw01/Desktop/Notebooks/Data/PR_National.csv")

csv_file="/home/a1psw01/Desktop/Notebooks/Data/PR_National_SA.csv"
PR_National <- read_csv(csv_file)

# est1<-feols(log(hpi_dollar) ~ factor(quarter),
#             data=PR_National[PR_National$year>2004&PR_National$year<2020,])
# PR2<- add_predictions(PR_National, est1, var = "predHPI") %>%
#      mutate(predHPI=predHPI-mean(predHPI)) %>%
#      mutate(predHPI=log(hpi_dollar)-predHPI) %>%
#      mutate(predHPI_level=exp(predHPI)) %>%
#      mutate(PriceGrowth=4*(predHPI-lag(predHPI,1)))
# 
# plot(PR2$date,PR2$predHPI )
# 
# est1<-feols(log(sfri_dollar) ~ factor(quarter),
#             data=PR_National[PR_National$year>2004&PR_National$year<2020,])
# PR2<- add_predictions(PR2, est1, var = "predSFRI") %>%
#      mutate(predSFRI=predSFRI-mean(predSFRI)) %>%
#      mutate(predSFRI=log(sfri_dollar)-predSFRI) %>%
#      mutate(predSFRI_level=exp(predSFRI)) %>%
#      mutate(RentGrowth=4*(predSFRI-lag(predSFRI,1)))

     


```

## PW_HousingUpdate_109_CostarVSF_MoM

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_109_CostarVSF_MoM-1.png) 

``` {r, }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_109_CostarVSF_MoM"

factor=0.65
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2014/1/1"),Sys.Date()+30),
                     pst_ylims         =c(-16,27),
                     # pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("2014/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2015/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =c(seq(-15,25,by=5)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     pst_yticks_mainRight = 0,
                     pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     pst_yticks_decimalRight = 1,
                     aspect            =sqrt(1.25),
                     DateFormat    ="%Y",
                     ylabel   ="\\scalebox{.8}{\\parbox{3cm}{\\centering Growth rate in \\% \\\\ \\scriptsize{Quarterly, SAAR}}}",
                     ylabel_sep= 35,
                     ylabel_sepRight= 35,
                     ylabelRight =
                          "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "")


pr_series <- Costar_National %>%
     mutate(RentGrowth=4*(log(market_effective_rent_unit)-
                             lag(log(market_effective_rent_unit),1))) %>%
     mutate(InflationGrowth=4*(log(UIXFDHEN)-lag(log(UIXFDHEN),1))) %>%
     mutate(PRGrowth=
                 4*(log(market_sale_price_per_unit)-
                       lag(log(market_sale_price_per_unit),1)-
                       4*(log(market_effective_rent_unit)-
                             lag(log(market_effective_rent_unit),1))) ) %>%
     mutate(PriceGrowth=4*(log(market_sale_price_per_unit)-
                              lag(log(market_sale_price_per_unit),1))) %>%
     mutate(RealRentGrowth=RentGrowth-InflationGrowth) %>%
     mutate(RealRentShare=RealRentGrowth/PriceGrowth,
            RealRentShare=ifelse(RealRentShare<0,0,RealRentShare)) %>%
     mutate(PRShare=1-PRGrowth/PriceGrowth,PRShare=ifelse(PRShare>1,1,PRShare)) %>%
     drop_na()

last_date<-max(pr_series$Date)


fPSTLine(pst_root=FigureRoot,
         pst_name="Costar",
         pst_x=as.numeric(pr_series$date),
         pst_y=100*pr_series$PriceGrowth,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(pr_series$date)),
         yy_1=100*last(pr_series$PriceGrowth),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright Multifamily price}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")


     
pr_series <- PR_National  %>%
     mutate(RentGrowth=4*(log(sfri_dollar)-lag(log(sfri_dollar),1))) %>%
     mutate(PriceGrowth=4*(log(hpi_dollar)-lag(log(hpi_dollar),1))) %>%
     drop_na()


fPSTLine(pst_root=FigureRoot,
         pst_name="CoreLogic",
         pst_x=as.numeric(pr_series$date),
         pst_y=100*pr_series$PriceGrowth,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(first(tail(pr_series$date,n=2))),
         yy_1=100*first(tail(pr_series$PriceGrowth,n=2)),
         label="$\\leftarrow$ \\parbox{4cm}{\\raggedright1-4 Family home price}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="CoreLogicRent",
         pst_x=as.numeric(pr_series$date),
         pst_y=100*pr_series$RentGrowth,
         pst=pst_box,
         color="red",
         xx_1=as.numeric(last(pr_series$date)),
         yy_1=100*last(pr_series$RentGrowth),
         label="$\\leftarrow$ \\parbox{3cm}{\\raggedright1-4 Family rent (red)}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")




fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes",
                       "Costar",
                       "CoreLogic"
                       ,"CoreLogicRent"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```

## PW_HousingUpdate_110_Yields

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_110_Yields-1.png)

``` {r }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_110_Yields"


ylims=c(-1.25,.89)
factor=.6

pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2015/12/1"),Sys.Date()-60),
                     pst_ylims         =ylims,
                     pst_xticks       =seq(as.Date(c("2015/7/1")),Sys.Date()-60,by="1 year"),
                     # XTickLabels = lubridate::quarter(seq(as.Date(c("2019/2/15")),Sys.Date()-60,by="3 month")),
                     pst_xlines        =seq(as.Date(c("2015/01/01")),Sys.Date()-60,by="1 year"),                                   
                     pst_yticks        =seq(-1.2,1,by=.4),
                     #pst_ytickLabels = c(150,seq(200,800,by=100)),
                     factor            =factor,
                     # pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     # pst_ylimsRight = c(-2,20),
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(-2,10,by=2),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=1,
                     # pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),#sqrt(2),
                     DateFormat    ="%Y",
                     ylabel   ="\\parbox{5cm}{\\centering Difference from Q4, 2019, \\\\ in percentage points}",
                    ylabel_sep= 30,
                     # ylabel_sepRight= 100,
                     # ylabelRight ="in \\%",
                     # YNumberSideRight="right",
                     TickLineColor = "lightgray",
                     XLabel = "")



fPSTLine(pst_root=FigureRoot,
         pst_name="FCM10",
         pst_x=as.numeric(rhw$Date),
         pst_y=rhw$FCM10-mean(rhw$FCM10[year(rhw$Date)==2019],na.rm=TRUE),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2023/1/1")),
         yy_1=0.4,
         label="\\parbox{1.5cm}{\\centering\\scriptsize Earnings/Price}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "2pt 1pt",
         dir=90,
         side="left")

specape <- rhm %>% select(Date,SPECAPE) %>% drop_na()

fPSTLine(pst_root=FigureRoot,
         pst_name="SPECAPE",
         pst_x=as.numeric(specape$Date),
         pst_y=1/specape$SPECAPE*100-mean(1/specape$SPECAPE[year(specape$Date)==2019])*100,
         pst=pst_box,
         color="red",
         xx_1=tail(as.numeric(specape$Date),n=1),
         yy_1=tail(1/specape$SPECAPE*100-mean(1/specape$SPECAPE[year(specape$Date)==2019])*100,n=1),
         label="$\\leftarrow$\\parbox{1.5cm}{\\centering\\scriptsize Earnings/Price}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".5pt",
         LineDash = "2pt 1pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="SPE5COOM",
         pst_x=as.numeric(rhm$Date),
         pst_y=1/rhm$SPE5COOM*100-1/rhm$SPE5COOM[rhm$Date==as.Date("2019/12/31")]*100,
         pst=pst_box,
         color="red",
         xx_1=as.numeric(as.Date("2023/1/1")),
         yy_1=0.4,
         label="\\parbox{1.5cm}{\\centering\\scriptsize Earnings/Price}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".5pt",
         LineDash = "2pt 1pt",
         dir=90,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="SPE5COMM",
         pst_x=as.numeric(rhm$Date),
         pst_y=1/rhm$SPE5COMM*100-1/rhm$SPE5COMM[rhm$Date==as.Date("2019/12/31")]*100,
         pst=pst_box,
         color="red",
         xx_1=as.numeric(as.Date("2023/1/1")),
         yy_1=0.4,
         label="\\parbox{1.5cm}{\\centering\\scriptsize Earnings/Price}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".5pt",
         LineDash = "2pt 1pt",
         dir=90,
         side="left")

pr_series <- PR_National %>%
     mutate(CLrent_price=1200*sfri_dollar/hpi_dollar) %>%
     mutate(CLrent_priceDiff=CLrent_price-CLrent_price[date==as.Date("2019/10/1")]) %>%
     mutate(CSrent_price=1200*rent_price)%>%
     mutate(CSrent_priceDiff=CSrent_price-CSrent_price[date==as.Date("2019/10/1")]) %>%
     drop_na()



fPSTLine(pst_root=FigureRoot,
         pst_name="CoreLogicRentPrice",
         pst_x=as.numeric(pr_series$date),
         pst_y=pr_series$CLrent_priceDiff,
         pst=pst_box,
         color="green",
         xx_1=as.numeric(last(pr_series$date)),
         yy_1=last(pr_series$CLrent_priceDiff),
         label="\\parbox{2in}{\\raggedright$\\leftarrow$ 1-4 family rent/price}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="CostarCapRate",
         pst_x=as.numeric(pr_series$date),
         pst_y=pr_series$CSrent_priceDiff,
         pst=pst_box,
         color="blue",
         xx_1=as.numeric(last(pr_series$date)),
         yy_1=last(pr_series$CSrent_priceDiff),
         label="\\parbox{2in}{\\raggedright$\\leftarrow$ 5+ family rent/price}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")



fCompile(pst_root=FigureRoot,SubFiles=list("PSTAxes"#"ListingsMA","SalesMA"
                                           ,"SPECAPE"
                                           ,"CoreLogicRentPrice"
                                           ,"CostarCapRate"),#,"NH","RI","CT
                                           # ,,"Label_Listings"),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```

## PW_HousingUpdate_111_Existing_v_New_rate

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_111_Existing_v_New_rate-1.png)

```{r}
FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_111_Existing_v_New_rate"

frm30 <- rhw %>% subset(select=c(Date,FRM30,year)) %>%
     mutate(quarter=quarter(Date)) %>%group_by(year,quarter) %>%
     summarize(FRM30=mean(FRM30,na.rm=TRUE))

interest <- rhq %>% subset(select=c(Date,FMOROTR,year)) %>%
     mutate(quarter=quarter(Date)) %>%
     drop_na %>%
     left_join(.,frm30) %>%
     mutate(margin=FMOROTR-FRM30)

ylims=c(-16,18)
factor=0.6
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("1976/12/1"),Sys.Date()+90),
                     pst_ylims         =ylims,
                     pst_xticks       =seq(as.Date(c("1980/01/01")),Sys.Date()+90,by="5 year"),
                     pst_xlines        =seq(as.Date(c("1980/01/01")),Sys.Date()+90,by="5 year"),                                   pst_yticks        =seq(0,20,by=5),
                     factor            =factor,
                     # pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     pst_ylimsRight = c(-9,19),
                     pst_yticks_mainRight = 0,
                     pst_yticksRight   =seq(-8,4,by=4),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),#sqrt(2),
                     DateFormat    ="%Y",
                     ylabel   ="\\parbox{7cm}{\\centering\\scriptsize{ Mortgage rate in \\%}}",
                     ylabel_sep= 50,
                     ylabel_sepRight= 100,
                     ylabelRight ="\\scriptsize{Difference in \\%}",
                     YNumberSideRight="right",
                     TickLineColor = "lightgray",
                     XLabel = "")

fPSTLine(pst_root=FigureRoot,
         pst_name="Received",
         pst_x=as.numeric(rhq$Date),
         pst_y=rhq$FMOROTR,
         pst=pst_box,
         color="green",
         xx_1=as.numeric(as.Date("1977/7/1")),
         yy_1=8,
         label="\\parbox{2cm}{\\centering Existing Loan Interest Rate}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".25pt",
         LineDash = "2pt 1pt",
         dir=-45,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="Paid",
         pst_x=as.numeric(rhw$Date),
         pst_y=rhw$FRM30,
         pst=pst_box,
         color="blue",
         xx_1=as.numeric(as.Date("1984/1/1")),
         yy_1=15,
         label="New Loan Interest Rate",
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".25pt",
         LineDash = "2pt 1pt",
         dir=45,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="Margin",
         pst_x=as.numeric(interest$Date),
         pst_y=interest$margin,
         pst=pst_box,
         color="red",
         xx_1=as.numeric(as.Date("1984/1/1")),
         yy_1=-4,
         label="Margin",
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".25pt",
         LineDash = "2pt 1pt",
         dir=-45,
         side="right")

fCompile(pst_root=FigureRoot,SubFiles=list("Received","Paid","Margin"
                                           ,"PSTAxes"),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```

## PW_HousingUpdate_111b_Existing_v_New_rate_short

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_111b_Existing_v_New_rate_short-1.png)

```{r}
FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_111b_Existing_v_New_rate_short"

frm30 <- rhw %>% subset(select=c(Date,FRM30,year)) %>%
     mutate(quarter=quarter(Date)) %>%group_by(year,quarter) %>%
     summarize(FRM30=mean(FRM30,na.rm=TRUE))

interest <- rhq %>% subset(select=c(Date,FMOROTR,year)) %>%
     mutate(quarter=quarter(Date)) %>%
     drop_na %>%
     left_join(.,frm30) %>%
     mutate(margin=FMOROTR-FRM30)

ylims=c(-5,9)
factor=0.6
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("1999/12/1"),Sys.Date()+90),
                     pst_ylims         =ylims,
                     pst_xticks       =seq(as.Date(c("2000/01/01")),Sys.Date()+90,by="5 year"),
                     pst_xlines        =seq(as.Date(c("2000/01/01")),Sys.Date()+90,by="5 year"),                                   pst_yticks        =seq(3,8,by=1),
                     factor            =factor,
                     # pst_xticks_main   =0,
                     pst_yticks_main   =999,
                     pst_ylimsRight = c(-1.2,8.4),
                     pst_yticks_mainRight = 0,
                     pst_yticksRight   =seq(-1,3,by=1),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),#sqrt(2),
                     DateFormat    ="%Y",
                     ylabel   ="\\parbox{7cm}{\\centering\\scriptsize{ Mortgage rate in \\%}}",
                     ylabel_sep= 50,
                     ylabel_sepRight= 100,
                     ylabelRight ="\\scriptsize{Difference in \\%}",
                     YNumberSideRight="right",
                     TickLineColor = "lightgray",
                     XLabel = "")

fPSTLine(pst_root=FigureRoot,
         pst_name="Received",
         pst_x=as.numeric(rhq$Date),
         pst_y=rhq$FMOROTR,
         pst=pst_box,
         color="green",
         xx_1=as.numeric(as.Date("2006/7/1")),
         yy_1=5,
         label="\\parbox{2cm}{\\centering Existing Loan Interest Rate}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".25pt",
         LineDash = "2pt 1pt",
         dir=-90,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="Paid",
         pst_x=as.numeric(rhw$Date),
         pst_y=rhw$FRM30,
         pst=pst_box,
         color="blue",
         xx_1=as.numeric(as.Date("2008/1/1")),
         yy_1=7,
         label="New Loan Interest Rate",
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".25pt",
         LineDash = "2pt 1pt",
         dir=90,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="Margin",
         pst_x=as.numeric(interest$Date),
         pst_y=-interest$margin,
         pst=pst_box,
         color="red",
         xx_1=as.numeric(as.Date("2007/1/1")),
         yy_1=1.25,
         label="\\parbox{2cm}{\\centering Gain to investors from prepayment}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".25pt",
         LineDash = "2pt 1pt",
         dir=90,
         side="right")

fCompile(pst_root=FigureRoot,SubFiles=list("Received","Paid","Margin"
                                           ,"PSTAxes"),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```

## PW_HousingUpdate_112_Transactions

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_112_Transactions-1.png)


``` {r,  }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_112_Transactions"


factor=0.6
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2017/1/1"),Sys.Date()+30),
                     pst_ylims         =c(69,125),
                     #pst_ylimsRight    =c(-3.85,18),
                     pst_xticks        =seq(as.Date(c("2017/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2018/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =c(seq(70,120,by=10)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     pst_yticks_mainRight = 0,
                     pst_yticksRight   =seq(-4,6,by=2),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),
                     DateFormat    ="%Y",
                     ylabel   ="\\scalebox{0.98}{\\parbox{2in}{\\centering Existing home sales \\\\ \\scriptsize{2017-2019=100, SAAR}}}",
                     ylabel_sep= 50,
                     ylabel_sepRight= 100,
                     ylabelRight ="",
                     YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "")



fPSTLine(pst_root=FigureRoot,
         pst_name="Listings",
         pst_x=as.numeric(rhm$Date),
         pst_y=100*rhm$USMNBAU/mean(rhm$USMNBAU[rhm$Date>as.Date("2017/1/1")&rhm$Date<as.Date("2020/1/1")]),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2019/1/1")),
         yy_1=105,
         label="\\scalebox{1.2}{\\parbox{2cm}{\\centering  Existing Home Sales}}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 2pt",
         dir=90,
         side="left")




fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes",
                       "Listings"),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```




## PW_HousingUpdate_113_History

formerley PriceRentCOVID106_History

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_113_History-1.png)

```{r }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_113_History"


pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =as.Date(c("1974/1/1","2023/8/1")),
                     pst_ylims         =log(c(74,210)),
                     #pst_ylimsRight    =c(-3.85,18),
                     pst_xticks        =seq(as.Date(c("1975/1/1")),as.Date("2022/1/1"),by="5 year"),
                     pst_xlines        =seq(as.Date(c("1975/1/1")),as.Date("2022/1/1"),by="5 year"),
                     pst_yticks        =log(c(seq(80,200,by=20))),
                     pst_ytickLabels   =c(seq(80,200,by=20)),
                     factor            =.9,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(-4,6,by=2),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),
                     DateFormat    ="%Y",
                     ylabel   ="Index, Jan-2000=100",
                     ylabel_sep= 300,
                     # ylabel_sepRight= 100,
                     # ylabelRight ="rate in \\%",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "")


Indices<-rhm %>% subset(select=c(Date,UIXFDHEN,CASUSXRM,USHSRN)) %>%
     mutate(priceIndex=CASUSXRM/UIXFDHEN,rentIndex=USHSRN/UIXFDHEN) %>%
     mutate(priceIndex=100*priceIndex/priceIndex[Date==as.Date("2000/1/31")]) %>%
     mutate(rentIndex=100*rentIndex/rentIndex[Date==as.Date("2000/1/31")])


fPSTLine(pst_root=FigureRoot,
         pst_name="rent",
         pst_x=as.numeric(Indices$Date),
         pst_y=log(Indices$rentIndex),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2004/1/1")),
         yy_1=log(105),
         label="\\parbox{1in}{\\raggedright Real rent (BLS)}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 4pt",
         dir=-45,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="price",
         pst_x=as.numeric(Indices$Date[Indices$Date>as.Date("1999/12/31")]),
         pst_y=log(Indices$priceIndex[Indices$Date>as.Date("1999/12/31")]),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2005/1/1")),
         yy_1=log(160),
         label="\\parbox{1in}{\\raggedleft Real HPA (Case-Shiller)}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 2pt",
         dir=135,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="pricePre2000",
         pst_x=as.numeric(Indices$Date[Indices$Date<=as.Date("2000/1/1")]),
         pst_y=log(Indices$priceIndex[Indices$Date<=as.Date("2000/1/1")]),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2005/10/1")),
         yy_1=log(100),
         label="",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "5pt 3pt",
         dir=-45,
         side="left")

####################################
fCompile(pst_root=FigureRoot,SubFiles=list("PSTAxes"
                                           ,"rent"
                                           ,"price"
                                           ,"pricePre2000")
         ,PictureSize=factor/.75*c(9,8),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

# pp<-readPNG(paste0(FigureRoot,"-1.png"))
plot.new()
# plot.window(xlim=c(0,1), ylim=c(0,1))
# rasterImage(pp,0,0,0.95,0.95*sqrt(2))



```


## PW_HousingUpdate_114_RentComparison
```{r}

RentComparisonGrowth <- RentComparison %>%
     mutate(Zillowdiff=log(Zillow)-lag(log(Zillow),4)) %>%
     mutate(ZillowMFdiff=log(ZillowMF)-lag(log(ZillowMF),4)) %>%
     mutate(ZillowSFdiff=log(ZillowSF)-lag(log(ZillowSF),4)) %>%
     mutate(CBREdiff=log(CBRE)-lag(log(CBRE),4)) %>%
     mutate(SFRIdiff=log(SFRI)-lag(log(SFRI),4)) %>%
     mutate(CoStardiff=log(Costar)-lag(log(Costar),4)) %>%
     mutate(HPIdiff=log(HPI)-lag(log(HPI),4)) 

```


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_114_RentComparison-1.png) 

``` {r, }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_114_RentComparison"

factor=0.65
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2014/1/1"),Sys.Date()+30),
                     pst_ylims         =c(-1,15),
                     # pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("2014/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2015/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =c(seq(0,14,by=2)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 1,
                     aspect            =sqrt(1.25),
                     DateFormat    ="%Y",
                     ylabel   ="\\scalebox{.8}{\\parbox{4cm}{\\centering Rent inflation in \\% \\\\ \\scriptsize{Quarterly, Year-on-Year}}}",
                     ylabel_sep= 5,
                     # ylabel_sepRight= 35,
                     # ylabelRight =
                     #      "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                      XLabel = "\\scalebox{.5}{\\parbox{16cm}{\\textrm This figure shows year-over-year changes in multi-family and single-family rent indices.  Source:  CoreLogic and Costar.}}")




fPSTLine(pst_root=FigureRoot,
         pst_name="Costar",
         pst_x=as.numeric(RentComparisonGrowth$date)+45,
         pst_y=100*RentComparisonGrowth$CoStardiff,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2020/3/15")),
         yy_1=1.05,
         label="\\parbox{2cm}{\\raggedleft Multifamily Rent Inflation (Costar)}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=180,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="SFRI",
         pst_x=as.numeric(RentComparisonGrowth$date)+45,
         pst_y=100*RentComparisonGrowth$SFRIdiff,
         pst=pst_box,
         color="red",
         xx_1=as.numeric(as.Date("2023/2/1")),
         yy_=6,
         label="\\parbox{2cm}{\\raggedright Single-Family Rent Inflation (CoreLogic)}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")


xs=as.numeric(c(as.Date("2019/1/1"),as.Date("2020/11/1")))   
ys=c(6.1,3.8)
fPSTLine(pst_root=FigureRoot,
         pst_name="SFRILabel",
         pst_x=xs,
         pst_y=ys,
         pst=pst_box,
         color="black",
         xx_1=xs[1],
         yy_1=ys[1],
         label="\\parbox{3cm}{\\centering CoreLogic SF}",
         LineStyle = "solid",
         arrows = "->",
         sep=0.0,
         LineWidth=".2pt",
         LineDash = "6pt 2pt",
         dir=90,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="ZillowSF",
         pst_x=as.numeric(RentComparisonGrowth$date)+45,
         pst_y=100*RentComparisonGrowth$ZillowSFdiff,
         pst=pst_box,
         color="green",
         xx_1=as.numeric(last(RentComparisonGrowth$date)),
         yy_1=last(na.omit(100*RentComparisonGrowth$ZillowSFdiff)),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright Zillow SF}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="ZillowMF",
         pst_x=as.numeric(RentComparisonGrowth$date)+45,
         pst_y=100*RentComparisonGrowth$ZillowMFdiff,
         pst=pst_box,
         color="green",
         xx_1=as.numeric(last(RentComparisonGrowth$date)),
         yy_1=last(na.omit(100*RentComparisonGrowth$ZillowMFdiff)),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright Zillow MF}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="CBRE",
         pst_x=as.numeric(RentComparisonGrowth$date)+45,
         pst_y=100*RentComparisonGrowth$CBREdiff,
         pst=pst_box,
         color="blue",
         xx_1=as.numeric(as.Date("2021/3/1")),
         yy_1=-3,
         label="\\parbox{3cm}{\\raggedright CBRE MF}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="HPI",
         pst_x=as.numeric(RentComparisonGrowth$date)+45,
         pst_y=100*RentComparisonGrowth$HPIdiff,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(RentComparisonGrowth$date)),
         yy_1=last(na.omit(100*RentComparisonGrowth$HPIdiff)),
        label="\\parbox{3cm}{\\raggedright HPI}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")


fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes"
                       ,"Costar"
                       ,"CBRE"
                       ,"ZillowSF"
                       ,"ZillowMF"
                       ,"SFRI"
                       # ,"SFRILabel"
                       # ,"HPI"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```


## PW_HousingUpdate_114a_RentComparison_Level


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_114a_RentComparison_Level-1.png) 

``` {r, }

RentComparisonLevel <- RentComparison %>% filter(date>=as.Date("2019/10/1")) %>%
     pivot_longer(.,cols=names(.)[2:NCOL(.)],
                  names_to="Series",
                  values_to="value") %>%
     group_by(Series) %>%
     mutate(index=value/value[1]*100) %>%
     select(-value) %>%
     pivot_wider(.,
                 names_from=Series,
                 values_from=index)

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_114a_RentComparison_Level"

factor=0.65
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2018/12/1"),Sys.Date()+30),
                     pst_ylims         =c(88,142),
                     # pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("2019/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2019/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =c(seq(90,140,by=10)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =100,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 1,
                     aspect            =sqrt(1.25),
                     DateFormat    ="%Y",
                     ylabel   ="\\scalebox{.8}{\\parbox{4cm}{\\centering Cumulative Rent Growth \\\\ \\scriptsize{Q4, 2019=100}}}",
                     ylabel_sep= 60,
                     # ylabel_sepRight= 35,
                     # ylabelRight =
                     #      "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "\\scalebox{.5}{\\parbox{16cm}{\\textrm This figures shows various rent indexes all relative to the fourth quarter of 2019}}")



fPSTLine(pst_root=FigureRoot,
         pst_name="CPIRent",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$CPIRent,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$CPIRent)),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright CPIRent}",
         LineStyle = "solid",
         sep=0.2,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="Costar",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$Costar,
         pst=pst_box,
         color="blue",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$Costar)),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright Costar}",
         LineStyle = "dashed",
         sep=0.2,
         LineWidth=".5pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="SFRI",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$SFRI,
         pst=pst_box,
         color="red",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$SFRI)),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright CoreLogic SF}",
         LineStyle = "dashed",
         sep=0.2,
         LineWidth="0.5pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="ZillowSF",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$ZillowSF,
         pst=pst_box,
         color="green",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$ZillowSF)),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright Zillow SF}",
         LineStyle = "dashed",
         sep=0.2,
         LineWidth="0.5pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="ZillowMF",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$ZillowMF,
         pst=pst_box,
         color="green",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$ZillowMF))+1,
         label="$\\swarrow$\\parbox{3cm}{\\raggedright Zillow MF}",
         LineStyle = "dashed",
         sep=0.2,
         LineWidth="0.5pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="CBRE",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$CBRE,
         pst=pst_box,
         color="brown",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$CBRE)),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright CBRE}",
         LineStyle = "dashed",
         sep=0.2,
         LineWidth="0.5pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="HPI",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$HPI,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$HPI)),
        label="\\parbox{3cm}{\\raggedright HPI}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="Earnings",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$Earnings,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$Earnings)),
        label="\\parbox{3cm}{\\raggedright HPI}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")


fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes"
                       ,"CPIRent"
                       ,"Costar"
                       ,"CBRE"
                       ,"ZillowSF"
                       ,"ZillowMF"
                       ,"SFRI"
                       # ,"Earnings"
                       # ,"SFRILabel"
                       # ,"HPI"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```


## PW_HousingUpdate_114b_RentComparison_Level_2021


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_114b_RentComparison_Level_2021-1.png) 

``` {r, }

RentComparisonLevel <- RentComparison %>% filter(date>=as.Date("2021/1/1")) %>%
     pivot_longer(.,cols=names(.)[2:NCOL(.)],
                  names_to="Series",
                  values_to="value") %>%
     group_by(Series) %>%
     mutate(index=value/value[1]*100) %>%
     select(-value) %>%
     pivot_wider(.,
                 names_from=Series,
                 values_from=index)

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_114b_RentComparison_Level_2021"

factor=0.65
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2020/12/1"),Sys.Date()+30),
                     pst_ylims         =c(98,132),
                     # pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("2021/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2021/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =c(seq(100,130,by=5)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =100,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 1,
                     aspect            =sqrt(1.25),
                     DateFormat    ="%Y",
                     ylabel   ="\\scalebox{.8}{\\parbox{4cm}{\\centering Cumulative Rent Growth \\\\ \\scriptsize{Q1, 2015=100}}}",
                     ylabel_sep= 40,
                     # ylabel_sepRight= 35,
                     # ylabelRight =
                     #      "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "\\scalebox{.5}{\\parbox{16cm}{\\textrm This figures shows various rent indexes all relative to the first quarter of 2015}}")



fPSTLine(pst_root=FigureRoot,
         pst_name="CPIRent",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$CPIRent,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$CPIRent)),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright CPIRent}",
         LineStyle = "solid",
         sep=0.3,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="Costar",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$Costar,
         pst=pst_box,
         color="blue",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$Costar)),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright Costar}",
         LineStyle = "dashed",
         sep=0.3,
         LineWidth=".5pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="SFRI",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$SFRI,
         pst=pst_box,
         color="red",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$SFRI)),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright CoreLogic SF}",
         LineStyle = "dashed",
         sep=0.3,
         LineWidth="0.5pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")


xs=as.numeric(c(as.Date("2019/1/1"),as.Date("2020/11/1")))   
ys=c(6.1,3.8)
fPSTLine(pst_root=FigureRoot,
         pst_name="SFRILabel",
         pst_x=xs,
         pst_y=ys,
         pst=pst_box,
         color="black",
         xx_1=xs[1],
         yy_1=ys[1],
         label="\\parbox{3cm}{\\centering CoreLogic SF}",
         LineStyle = "solid",
         arrows = "->",
         sep=0.0,
         LineWidth=".2pt",
         LineDash = "6pt 2pt",
         dir=90,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="ZillowSF",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$ZillowSF,
         pst=pst_box,
         color="green",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$ZillowSF)),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright Zillow SF}",
         LineStyle = "dashed",
         sep=0.3,
         LineWidth="0.5pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="ZillowMF",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$ZillowMF,
         pst=pst_box,
         color="green",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$ZillowMF)),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright Zillow MF}",
         LineStyle = "dashed",
         sep=0.3,
         LineWidth="0.5pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="CBRE",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$CBRE,
         pst=pst_box,
         color="brown",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$CBRE)),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright CBRE}",
         LineStyle = "dashed",
         sep=0.3,
         LineWidth="0.5pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="HPI",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$HPI,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$HPI)),
        label="\\parbox{3cm}{\\raggedright HPI}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="Earnings",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$Earnings,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$Earnings)),
        label="\\parbox{3cm}{\\raggedright HPI}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")


fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes"
                       ,"CPIRent"
                       ,"Costar"
                       ,"CBRE"
                       ,"ZillowSF"
                       ,"ZillowMF"
                       ,"SFRI"
                       # ,"Earnings"
                       # ,"SFRILabel"
                       # ,"HPI"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```








## PW_HousingUpdate_114c_RentComparison_Level_2014


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_114c_RentComparison_Level_2014-1.png) 

``` {r, }

RentComparisonLevel <- RentComparison %>% filter(date>=as.Date("2015/1/1")) %>%
     pivot_longer(.,cols=names(.)[2:NCOL(.)],
                  names_to="Series",
                  values_to="value") %>%
     group_by(Series) %>%
     mutate(index=value/value[1]*100) %>%
     select(-value) %>%
     pivot_wider(.,
                 names_from=Series,
                 values_from=index)

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_114c_RentComparison_Level_2014"

factor=0.75
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2014/12/1"),Sys.Date()+30),
                     pst_ylims         =log(c(98,175)),
                     # pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("2015/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2015/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =log(c(seq(100,175,by=10))),
                     pst_ytickLabels =c(seq(100,175,by=10)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =100,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 1,
                     aspect            =sqrt(2),
                     DateFormat    ="%Y",
                     ylabel   ="\\scalebox{.8}{\\parbox{4cm}{\\centering Cumulative Rent Growth \\\\ \\scriptsize{Q1, 2015=100}}}",
                     ylabel_sep= 40,
                     # ylabel_sepRight= 35,
                     # ylabelRight =
                     #      "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "\\scalebox{.5}{\\parbox{16cm}{\\textrm This figures shows various rent indexes at quarterly frequency, all relative to the first quarter of 2015.}}")



fPSTLine(pst_root=FigureRoot,
         pst_name="CPIRent",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=log(RentComparisonLevel$CPIRent),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=log(last(na.omit(RentComparisonLevel$CPIRent))),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright CPIRent}",
         LineStyle = "solid",
         sep=0.3,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="Costar",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=log(RentComparisonLevel$Costar),
         pst=pst_box,
         color="blue",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=log(last(na.omit(RentComparisonLevel$Costar))),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright Costar}",
         LineStyle = "dashed",
         sep=0.3,
         LineWidth=".5pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="SFRI",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=log(RentComparisonLevel$SFRI),
         pst=pst_box,
         color="red",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=log(last(na.omit(RentComparisonLevel$SFRI))),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright CoreLogic SF}",
         LineStyle = "dashed",
         sep=0.3,
         LineWidth="0.5pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")

SFRIIndex <- SFRI_National %>% filter(date>=as.Date("2015/1/1")) %>%
     arrange(date) %>%
     mutate(index=single_family_rent_index/single_family_rent_index[1]*100) %>%
     {.}
                  

fPSTLine(pst_root=FigureRoot,
         pst_name="SFRIMonthly",
         pst_x=as.numeric(SFRIIndex$date)+45,
         pst_y=log(SFRIIndex$index),
         pst=pst_box,
         color="red",
         xx_1=as.numeric(last(as.numeric(SFRIIndex$date))),
         yy_1=log(last(na.omit(SFRIIndex$index))),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright CoreLogic SF}",
         LineStyle = "dashed",
         sep=0.3,
         LineWidth="0.5pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="ZillowSF",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=log(RentComparisonLevel$ZillowSF),
         pst=pst_box,
         color="green",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=log(last(na.omit(RentComparisonLevel$ZillowSF))),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright Zillow SF}",
         LineStyle = "dashed",
         sep=0.3,
         LineWidth="0.5pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="ZillowMF",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=log(RentComparisonLevel$ZillowMF),
         pst=pst_box,
         color="green",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=log(last(na.omit(RentComparisonLevel$ZillowMF))),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright Zillow MF}",
         LineStyle = "dashed",
         sep=0.3,
         LineWidth="0.5pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="CBRE",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=log(RentComparisonLevel$CBRE),
         pst=pst_box,
         color="brown",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=log(last(na.omit(RentComparisonLevel$CBRE))),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright CBRE}",
         LineStyle = "dashed",
         sep=0.3,
         LineWidth="0.5pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")



fPSTLine(pst_root=FigureRoot,
         pst_name="Earnings",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$Earnings,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$Earnings)),
        label="\\parbox{3cm}{\\raggedright HPI}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")


fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes"
                       ,"CPIRent"
                       ,"Costar"
                       ,"CBRE"
                       ,"ZillowSF"
                       ,"ZillowMF"
                       # ,"SFRI"
                       ,"SFRIMonthly"
                       # ,"Earnings"
                       # ,"SFRILabel"
                       # ,"HPI"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```











## PW_HousingUpdate_114d_RentComparison_Level_2000


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_114d_RentComparison_Level_2000-1.png) 

``` {r, }

RentComparisonLevel <- RentComparison %>% filter(date>=as.Date("2005/1/1")) %>%
     pivot_longer(.,cols=names(.)[2:NCOL(.)],
                  names_to="Series",
                  values_to="value") %>%
     group_by(Series) %>%
     mutate(index=value/value[1]*100) %>%
     select(-value) %>%
     pivot_wider(.,
                 names_from=Series,
                 values_from=index)

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_114d_RentComparison_Level_2000"

factor=0.75
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2004/12/1"),Sys.Date()+30),
                     pst_ylims         =log(c(98,195)),
                     # pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("2005/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2005/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =log(c(seq(100,190,by=10))),
                     pst_ytickLabels =c(seq(100,190,by=10)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =100,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 1,
                     aspect            =sqrt(2),
                     DateFormat    ="%y",
                     ylabel   ="\\scalebox{.8}{\\parbox{4cm}{\\centering Cumulative Rent Growth \\\\ \\scriptsize{Q1, 2005=100}}}",
                     ylabel_sep= 100,
                     # ylabel_sepRight= 35,
                     # ylabelRight =
                     #      "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "\\scalebox{.5}{\\parbox{20cm}{\\textrm This figures shows various rent indexes at quarterly frequency, all relative to the first quarter of 2005.}}")



fPSTLine(pst_root=FigureRoot,
         pst_name="CPIRent",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=log(RentComparisonLevel$CPIRent),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=log(last(na.omit(RentComparisonLevel$CPIRent))),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright CPIRent}",
         LineStyle = "solid",
         sep=0.3,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="OER",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=log(RentComparisonLevel$OER),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=log(last(na.omit(RentComparisonLevel$OER))),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright OER}",
         LineStyle = "dashed",
         sep=0.3,
         LineWidth="1pt",
         LineDash = "1pt 1pt",
         dir=0,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="Costar",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=log(RentComparisonLevel$Costar),
         pst=pst_box,
         color="blue",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=log(last(na.omit(RentComparisonLevel$Costar))),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright Costar}",
         LineStyle = "dashed",
         sep=0.3,
         LineWidth=".5pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="SFRI",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=log(RentComparisonLevel$SFRI),
         pst=pst_box,
         color="red",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=log(last(na.omit(RentComparisonLevel$SFRI))),
         label="$\\nwarrow$\\parbox{3cm}{\\raggedright CoreLogic SF}",
         LineStyle = "dashed",
         sep=0.2,
         LineWidth="0.5pt",
         LineDash = "6pt 2pt",
         dir=-45,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="ZillowSF",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=log(RentComparisonLevel$ZillowSF),
         pst=pst_box,
         color="green",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=log(last(na.omit(RentComparisonLevel$ZillowSF))),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright Zillow SF}",
         LineStyle = "dashed",
         sep=0.3,
         LineWidth="0.5pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="ZillowMF",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=log(RentComparisonLevel$ZillowMF),
         pst=pst_box,
         color="green",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=log(last(na.omit(RentComparisonLevel$ZillowMF))),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright Zillow MF}",
         LineStyle = "dashed",
         sep=0.2,
         LineWidth="0.5pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="CBRE",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=log(RentComparisonLevel$CBRE),
         pst=pst_box,
         color="brown",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=log(last(na.omit(RentComparisonLevel$CBRE))),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright CBRE}",
         LineStyle = "dashed",
         sep=0.3,
         LineWidth="0.5pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")



fPSTLine(pst_root=FigureRoot,
         pst_name="Earnings",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$Earnings,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(RentComparisonLevel$date)),
         yy_1=last(na.omit(RentComparisonLevel$Earnings)),
        label="\\parbox{3cm}{\\raggedright HPI}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")


fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes"
                       ,"CPIRent"
                       ,"OER"
                       ,"Costar"
                       ,"CBRE"
                       # ,"ZillowSF"
                       # ,"ZillowMF"
                       ,"SFRI"
                       # ,"Earnings"
                       # ,"SFRILabel"
                       # ,"HPI"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```










## PW_HousingUpdate_115_RentComparison_MoM_SA
```{r}

require(seasonal)
require(TSstudio)

RentComparison <- RentComparison %>% mutate(quarter=quarter(date)) %>%
     mutate(year=year(date))

# f_seasonal <- function(input){
#      output=decompose(ts(input,frequency=4),type="multiplicative")$x/
#           decompose(ts(input,frequency=4),type="multiplicative")$seasonal
#      output=as.numeric(output)
#      return(output)}

f_seasonal_2 <- function(input,name){
     input=input %>% select(name)
     output=seas(ts(input,start = c(2000, 1),frequency=4))
     output=ts_reshape(output$data[,1],type="long")
     output <-  output %>% 
          mutate(date=as.Date(paste0(year,"/",quarter*3-2,"/1"))) %>%
          select(-c(year,quarter)) %>%
          rename(!!sym(paste0(name,"_SA")):=value)
     return(output)}

# f_seasonal_2(input=RentComparison,name="SFRI")

RentComparison_SA <- RentComparison %>% 
     left_join(.,f_seasonal_2(.,name="SFRI")) %>%
     left_join(.,f_seasonal_2(.,name="CBRE")) %>%
    left_join(.,f_seasonal_2(.,name="HPI")) %>%
    left_join(.,f_seasonal_2(.,name="Costar"))


RentComparison_SA <- RentComparison_SA %>%
     # mutate(Zillowdiff=log(Zillow)-lag(log(Zillow),4)) %>%
     # mutate(ZillowMFdiff=log(ZillowMF)-lag(log(ZillowMF),4)) %>%
     # mutate(ZillowSFdiff=log(ZillowSF)-lag(log(ZillowSF),4)) %>%
     mutate(CBREdiff_SA=log(CBRE_SA)-lag(log(CBRE_SA),1)) %>%
     mutate(SFRIdiff_SA=log(SFRI_SA)-lag(log(SFRI_SA),1)) %>%
     mutate(CoStardiff_SA=log(Costar_SA)-lag(log(Costar_SA),1)) %>%
     mutate(HPIdiff_SA=log(HPI_SA)-lag(log(HPI_SA),1))
```









```{r}
RentComparison_SA_CF <- read_csv("/home/a1psw01/Desktop/Notebooks/Data/paul_sa.csv")

RentComparison_SA <- RentComparison_SA_CF %>%
     # mutate(Zillowdiff=log(Zillow)-lag(log(Zillow),4)) %>%
     # mutate(ZillowMFdiff=log(ZillowMF)-lag(log(ZillowMF),4)) %>%
     # mutate(ZillowSFdiff=log(ZillowSF)-lag(log(ZillowSF),4)) %>%
     # mutate(CBREdiff_SA=diff(log(cbre),1) %>%
     mutate(SFRIdiff_SA=log(sfri_sa_add)-lag(log(sfri_sa_add),1)) %>%
     mutate(CoStardiff_SA=log(costar_sa_add)-lag(log(costar_sa_add),1)) %>%
     mutate(HPIdiff_SA=log(hpi_sa_add)-lag(log(hpi_sa_add),1))

```


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_115_RentComparison_MoM_SA-1.png) 

``` {r}

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_115_RentComparison_MoM_SA"

factor=0.65
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2014/1/1"),Sys.Date()+30),
                     pst_ylims         =c(-5,21),
                     # pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("2014/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2015/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =c(seq(-3,20,by=3)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 1,
                     aspect            =sqrt(1.25),
                     DateFormat    ="%Y",
                     ylabel   ="\\scalebox{.8}{\\parbox{4cm}{\\centering Rent inflation in \\% \\\\ \\scriptsize{Quarterly, Year-on-Year}}}",
                     ylabel_sep= 35,
                     # ylabel_sepRight= 35,
                     # ylabelRight =
                     #      "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "")




fPSTLine(pst_root=FigureRoot,
         pst_name="Costar",
         pst_x=as.numeric(RentComparison_SA$date)+45,
         pst_y=4*100*RentComparison_SA$CoStardiff_SA,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(RentComparison_SA$date)),
         yy_1=last(na.omit(4*100*RentComparison_SA$CoStardiff_SA)),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright Costar MF}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="SFRI",
         pst_x=as.numeric(RentComparison_SA$date)+45,
         pst_y=4*100*RentComparison_SA$SFRIdiff_SA,
         pst=pst_box,
         color="red",
         xx_1=as.numeric(last(RentComparison_SA$date)),
         yy_1=last(na.omit(4*100*RentComparison_SA$SFRIdiff_SA)),
         label="$\\leftarrow$\\parbox{1cm}{\\raggedright SFRI}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=0,
         side="left")


# xs=as.numeric(c(as.Date("2019/1/1"),as.Date("2020/11/1")))   
# ys=c(6.1,3.8)
# fPSTLine(pst_root=FigureRoot,
#          pst_name="SFRILabel",
#          pst_x=xs,
#          pst_y=ys,
#          pst=pst_box,
#          color="black",
#          xx_1=xs[1],
#          yy_1=ys[1],
#          label="\\parbox{3cm}{\\centering CoreLogic SF}",
#          LineStyle = "solid",
#          arrows = "->",
#          sep=0.0,
#          LineWidth=".2pt",
#          LineDash = "6pt 2pt",
#          dir=90,
#          side="left")

# fPSTLine(pst_root=FigureRoot,
#          pst_name="ZillowSF",
#          pst_x=as.numeric(RentComparison$date)+45,
#          pst_y=100*RentComparison$ZillowSFdiff,
#          pst=pst_box,
#          color="green",
#          xx_1=as.numeric(last(RentComparison$date)),
#          yy_1=last(na.omit(100*RentComparison$ZillowSFdiff)),
#          label="$\\leftarrow$\\parbox{3cm}{\\raggedright Zillow SF}",
#          LineStyle = "solid",
#          sep=0.1,
#          LineWidth="1pt",
#          LineDash = "4pt 2pt",
#          dir=0,
#          side="left")
# 
# fPSTLine(pst_root=FigureRoot,
#          pst_name="ZillowMF",
#          pst_x=as.numeric(RentComparison$date)+45,
#          pst_y=100*RentComparison$ZillowMFdiff,
#          pst=pst_box,
#          color="green",
#          xx_1=as.numeric(last(RentComparison$date)),
#          yy_1=last(na.omit(100*RentComparison$ZillowMFdiff)),
#          label="$\\leftarrow$\\parbox{3cm}{\\raggedright Zillow MF}",
#          LineStyle = "dashed",
#          sep=0.1,
#          LineWidth="1pt",
#          LineDash = "4pt 2pt",
#          dir=0,
#          side="left")


# fPSTLine(pst_root=FigureRoot,
#          pst_name="CBRE",
#          pst_x=as.numeric(RentComparison_SA$date)+45,
#          pst_y=4*100*RentComparison_SA$CBREdiff_SA,
#          pst=pst_box,
#          color="blue",
#          xx_1=as.numeric(as.Date("2021/3/1")),
#          yy_1=-3,
#          label="\\parbox{3cm}{\\raggedright CBRE MF}",
#          LineStyle = "dashed",
#          sep=0.1,
#          LineWidth="1pt",
#          LineDash = "4pt 2pt",
#          dir=0,
#          side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="HPI",
         pst_x=as.numeric(RentComparison_SA$date)+45,
         pst_y=4*100*RentComparison_SA$HPIdiff_SA,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(last(RentComparison_SA$date)),
         yy_1=last(na.omit(4*100*RentComparison_SA$HPIdiff_SA)),
        label="$\\leftarrow$\\parbox{3cm}{\\raggedright HPI}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")


fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes"
                       ,"Costar"
                       # ,"CBRE"
                       # ,"ZillowSF"
                       # ,"ZillowMF"
                       ,"SFRI"
                       # ,"SFRILabel"
                       ,"HPI"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```


```{r}

# Function definition
seasonal_adjustment <- function(ts_data, subset_data = NULL) {
  if (is.null(subset_data)) {
    subset_data <- ts_data
  }
  
  # Perform seasonal adjustment on the subset
  decomposed <- decompose(subset_data, type = "multiplicative")
  seasonal_adjustment_factors <- decomposed$seasonal
  
  # Apply seasonal adjustment factors to the entire time series
  seasonal_adjusted <- ts_data / seasonal_adjustment_factors
  
  # Return seasonally adjusted time series
  return(seasonal_adjustment_factors)
}

# Simulated example time series data with more periods
ts_data <- ts(rep(c(10, 15, 20, 25), 3), frequency = 4)

# Select subset of data for seasonal adjustment
subset_data <- window(ts_data, start = c(1, 1), end = c(3, 4))

# Perform seasonal adjustment using the function with subset data
seasonally_adjusted_data_subset <- seasonal_adjustment(ts_data, subset_data)

# Print the seasonally adjusted data using subset data
print(seasonally_adjusted_data_subset)

```





## PW_HousingUpdate_116_RoleOfOER

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_116_RoleOfOER-1.png)

```{r }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_116_RoleOfOER"

factor=0.65
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =as.Date(c("1982/1/1","2023/8/1")),
                     pst_ylims         =c(-9,9),
                     pst_ylimsRight    =c(-50,200),
                     pst_xticks        =seq(as.Date(c("1985/1/1")),as.Date("2022/1/1"),by="5 year"),
                     pst_xlines        =seq(as.Date(c("1985/1/1")),as.Date("2022/1/1"),by="5 year"),
                     pst_yticks        =seq(-1,8,by=1),
                     # pst_ytickLabels   =c(seq(80,200,by=20)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     pst_yticks_mainRight = 0,
                     pst_yticksRight   =seq(-40,40,by=20),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 0,
                     aspect            =sqrt(1.5),
                     DateFormat    ="%Y",
                     ylabel   ="\\parbox{4cm}{\\centering Inflation \\\\ \\scriptsize year-on-year in \\%}",
                     ylabel_sep= 100,
                     ylabel_sepRight= 100,
                     ylabelRight ="in bps",
                     YNumberSideRight = "right",
                     TickLineColor = "lightgray",
                     XLabel = "\\scalebox{.5}{\\parbox{16cm}{\\textrm This figure shows annualized, year-on-year growth rates in the CPI, as reported, and in a counterfactual version where we replace OER with RPR.  Source:  Haver Analytics and BLS.}}")

# RPCUHSHA@CPIDATA 
#   RPCUHSHA@CPIDATA   [CPI-U Relative Importance: Owners' Equivalent Rent of Residences (Parts per 100)]
# UHOA@CPIDATA 
#   UHOA@CPIDATA   [CPI-U: Owners' Equivalent Rent of Residences (SA, Dec-82=100)]
# UHSP@CPIDATA 
#   UHSP@CPIDATA   [CPI-U: Rent of Primary Residence (SA, 1982-84=100)]
# UI@CPIDATA 
#   UI@CPIDATA   [CPI-U: All Items (SA, 1982-84=100)]


Indices<-rhm %>% subset(select=c(Date,RPCUHSHA,UHOA,UHSP,UI)) %>%
     mutate(CPI_cf=UI-RPCUHSHA/100*UHOA+RPCUHSHA/100*UHSP) %>%
     mutate(Inflation=100*(log(UI)-lag(log(UI),12))) %>%
     mutate(Inflation_cf=100*(log(CPI_cf)-lag(log(CPI_cf),12)))

fPSTLine(pst_root=FigureRoot,
         pst_name="CPI",
         pst_x=as.numeric(Indices$Date),
         pst_y=Indices$Inflation,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("1991/1/1")),
         yy_1=6.2,
         label="\\parbox{1in}{\\centering CPI as reported (solid line)}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".1pt",
         LineDash = "1pt 4pt",
         dir=90,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="CPI_cf",
         pst_x=as.numeric(Indices$Date),
         pst_y=Indices$Inflation_cf,
         pst=pst_box,
         color="red",
         xx_1=as.numeric(as.Date("2008/1/1")),
         yy_1=5.5,
         label="\\parbox{1in}{\\centering Counterfactual CPI, assuming all housing is rented (dashed line)}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth=".1pt",
         LineDash = "4pt 2pt",
         dir=90,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="Gap",
         pst_x=as.numeric(Indices$Date),
         pst_y=100*(Indices$Inflation_cf-Indices$Inflation),
         pst=pst_box,
         color="green",
         xx_1=as.numeric(as.Date("1992/1/1")),
         yy_1=10,
         label="\\parbox{4cm}{\\centering Gap between counterfactual and reported\\\\ in basis points}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".1pt",
         LineDash = "1pt 4pt",
         dir=90,
         side="right")


####################################
fCompile(pst_root=FigureRoot,SubFiles=list("PSTAxes"
                                           ,"CPI"
                                           ,"CPI_cf"
                                           ,"Gap"
                                           )
         ,PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

# pp<-readPNG(paste0(FigureRoot,"-1.png"))
plot.new()
# plot.window(xlim=c(0,1), ylim=c(0,1))
# rasterImage(pp,0,0,0.95,0.95*sqrt(2))



```

## PW_HousingUpdate_117_RoleOfOER_Level

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_117_RoleOfOER_Level-1.png)
```{r}

HPI <-frbb_haver_series(mnemomonics = list("CASUSXAM"),database = "USECON") %>% na.omit %>%
     rename_with(toupper,contains("usecon")) %>%
     rename_with(~ gsub("_USECON","",.)) %>%
     mutate(date=as.Date(date)) %>%
     {.}

xlsx_file <- "/shared/HDM_shared_data/RealPageNational101.xlsx"

RealPageDownload <- read_excel(path=xlsx_file)  %>%
     clean_names()

RealPageNationalMonthly <- RealPageDownload %>%
     mutate(date=as.Date(paste0(substr(time_slice,2,5),"/",
                 substr(time_slice,7,8),"/1"))) %>%
     relocate(date) %>%
     select(date,effective_rpsf,rent_roll_rev_osf)

xlsx_file <- "/shared/HDM_shared_data/RealPageNational102Quarterly.xlsx"

RealPageDownload <- read_excel(path=xlsx_file)  %>%
     clean_names()

RealPageNationalQuarterly <- RealPageDownload %>%
     mutate(date=as.Date(paste0(substr(time_slice,2,5),"/",
                 3*as.numeric(substr(time_slice,7,7))-2,"/1"))) %>%
     relocate(date) %>%
     select(date,effective_rpsf,rent_roll_rev_osf)


CPIRents <- 
     frbb_haver_series(mnemomonics = list("UHOA","UHSP"),database = "CPIDATA") %>% na.omit %>%
     rename_with(toupper,contains("cpidata")) %>%
     rename_with(~ gsub("_CPIDATA","",.)) %>%
     mutate(date=as.Date(date)) %>%
     left_join(.,HPI) %>%
     left_join(.,RealPageNationalQuarterly) %>%
     mutate(across(-date, 
                ~ (. / .[date == as.Date("2020/1/1")]) * 100, 
                .names = "index_{col}"))


```

```{r }

FigureRoot="../Output/PW_HousingUpdate_117_RoleOfOER_Level"

factor=0.9
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =as.Date(c("1982/1/1","2023/8/1")),
                     pst_ylims         =log(c(85,610)),
                     #pst_ylimsRight    =c(-3.85,18),
                     pst_xticks        =seq(as.Date(c("1985/1/1")),as.Date("2022/1/1"),by="5 year"),
                     pst_xlines        =seq(as.Date(c("1985/1/1")),as.Date("2022/1/1"),by="5 year"),
                     pst_yticks        =log(c(100,150,300,600)),
                     pst_ytickLabels   =c(100,150,300,600),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(-4,6,by=2),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),
                     DateFormat    ="%Y",
                     ylabel   ="Index, Jan-2000=100",
                     ylabel_sep= 300,
                     # ylabel_sepRight= 100,
                     # ylabelRight ="rate in \\%",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "")

# RPCUHSHA@CPIDATA 
#   RPCUHSHA@CPIDATA   [CPI-U Relative Importance: Owners' Equivalent Rent of Residences (Parts per 100)]
# UHOA@CPIDATA 
#   UHOA@CPIDATA   [CPI-U: Owners' Equivalent Rent of Residences (SA, Dec-82=100)]
# UHSP@CPIDATA 
#   UHSP@CPIDATA   [CPI-U: Rent of Primary Residence (SA, 1982-84=100)]
# UI@CPIDATA 
#   UI@CPIDATA   [CPI-U: All Items (SA, 1982-84=100)]


# Indices<-rhm %>% subset(select=c(Date,RPCUHSHA,UHOA,UHSP,UI)) %>%
#      mutate(CPI_cf=UI-RPCUHSHA/100*UHOA+RPCUHSHA/100*UHSP) %>%
#      mutate(Inflation=100*(log(Indices$UI)-lag(log(Indices$UI),1))) %>%
#      mutate(Inflation_cf=100*(log(Indices$CPI_cf)-lag(log(Indices$CPI_cf),1)))
# 
# fPSTLine(pst_root=FigureRoot,
#          pst_name="CPI",
#          pst_x=as.numeric(Indices$Date),
#          pst_y=log(Indices$UI),
#          pst=pst_box,
#          color="black",
#          xx_1=as.numeric(as.Date("2002/1/1")),
#          yy_1=log(180),
#          label="\\parbox{1in}{\\raggedleft CPI}",
#          LineStyle = "solid",
#          sep=0.1,
#          LineWidth=".1pt",
#          LineDash = "1pt 4pt",
#          dir=135,
#          side="left")
# 
# fPSTLine(pst_root=FigureRoot,
#          pst_name="CPI_cf",
#          pst_x=as.numeric(Indices$Date),
#          pst_y=log(Indices$CPI_cf),
#          pst=pst_box,
#          color="red",
#          xx_1=as.numeric(as.Date("1998/1/1")),
#          yy_1=log(158),
#          label="\\parbox{1in}{\\centering Counterfactual Rent-based CPI}",
#          LineStyle = "solid",
#          sep=0.1,
#          LineWidth=".1pt",
#          LineDash = "1pt 4pt",
#          dir=-45,
#          side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="RPR",
         pst_x=as.numeric(CPIRents$date),
         pst_y=log(CPIRents$index_UHSP),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2002/1/1")),
         yy_1=log(180),
         label="\\parbox{1in}{\\raggedleft CPI}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".1pt",
         LineDash = "1pt 4pt",
         dir=135,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="OER",
         pst_x=as.numeric(CPIRents$date),
         pst_y=log(CPIRents$index_UHOA),
         pst=pst_box,
         color="red",
         xx_1=as.numeric(as.Date("1998/1/1")),
         yy_1=log(158),
         label="\\parbox{1in}{\\centering Counterfactual Rent-based CPI}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".1pt",
         LineDash = "1pt 4pt",
         dir=-45,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="HPI",
         pst_x=as.numeric(CPIRents$date),
         pst_y=log(CPIRents$index_CASUSXAM),
         pst=pst_box,
         color="red",
         xx_1=as.numeric(as.Date("1998/1/1")),
         yy_1=log(158),
         label="\\parbox{1in}{\\centering Counterfactual Rent-based CPI}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".1pt",
         LineDash = "1pt 4pt",
         dir=-45,
         side="left")

####################################
fCompile(pst_root=FigureRoot,SubFiles=list("PSTAxes"
                                           # ,"CPI"
                                           # ,"CPI_cf"
                                           ,"RPR"
                                           ,"OER"
                                           ,"HPI")
         ,PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "../Output/")

# pp<-readPNG(paste0(FigureRoot,"-1.png"))
plot.new()
# plot.window(xlim=c(0,1), ylim=c(0,1))
# rasterImage(pp,0,0,0.95,0.95*sqrt(2))



```

## PW_HousingUpdate_118_HPI

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_118_HPI-1.png)

```{r }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_118_HPI"

factor=0.65
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2014/1/1"),Sys.Date()+30),
                     pst_ylims         =c(-9,26),
                     # pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("2014/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2015/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =c(seq(-5,25,by=5)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 1,
                     aspect            =sqrt(1.25),
                     DateFormat    ="%Y",
                     ylabel   ="\\scalebox{.8}{\\parbox{6cm}{\\centering House Price Growth in \\% \\\\ \\scriptsize{Monthly, Seasonally Adjusted}}}",
                     ylabel_sep= 5,
                     # ylabel_sepRight= 35,
                     # ylabelRight =
                     #      "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "\\scalebox{.5}{\\parbox{16cm}{\\textrm This figure shows annualized month-over-month changes in the Zillow (black line), Case-Shiller (red line) and FHFA (blue dashed line) house price indices.  Source:  Haver Analytics.}}")




fPSTLine(pst_root=FigureRoot,
         pst_name="Zillow",
         pst_x=as.numeric(rhm$Date)+15,
         pst_y=1200*(log(rhm$USZHV)-log(lag(rhm$USZHV))),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2020/3/15")),
         yy_1=15,
         label="\\parbox{3cm}{\\centering House Price Growth (various indices,\\\\ see notes)}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=180,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="CaseShiller",
         pst_x=as.numeric(rhm$Date)+15,
         pst_y=1200*(log(rhm$CASUSXAM)-log(lag(rhm$CASUSXAM))),
         pst=pst_box,
         color="red",
         xx_1=as.numeric(as.Date("2020/3/15")),
         yy_1=1.05,
         label="",#"\\parbox{2cm}{\\raggedleft Multifamily (Costar)}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=180,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="FHFA",
         pst_x=as.numeric(rhm$Date)+15,
         pst_y=1200*(log(rhm$USPHPIM)-log(lag(rhm$USPHPIM))),
         pst=pst_box,
         color="blue",
         xx_1=as.numeric(as.Date("2020/3/15")),
         yy_1=1.05,
         label="",#"\\parbox{2cm}{\\raggedleft Multifamily (Costar)}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=180,
         side="left")



fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes"
                       ,"Zillow"
                       ,"CaseShiller"
                       ,"FHFA"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```





## PW_HousingUpdate_119_OERvRPR

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_119_OERvRPR-1.png)

```{r }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_119_OERvRPR"

factor=0.65
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2018/11/1"),Sys.Date()+30),
                     pst_ylims         =c(-1,11),
                     # pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("2019/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2019/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =c(seq(0,10,by=2)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 1,
                     aspect            =sqrt(1.25),
                     DateFormat    ="%Y",
                     ylabel   ="\\scalebox{.8}{\\parbox{6cm}{\\centering Index Growth \\\\ \\scriptsize{Monthly, Seasonally Adjusted}}}",
                     ylabel_sep= 5,
                     # ylabel_sepRight= 35,
                     # ylabelRight =
                     #      "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "\\scalebox{.5}{\\parbox{16cm}{\\textrm This figure shows annualized month-over-month growth rates in the Owners Equivalent Rent (OER) and Rent of Primary Residence (RPR) components of the CPI.  Source:  Haver Analytics and BLS.}}")




fPSTLine(pst_root=FigureRoot,
         pst_name="OER",
         pst_x=as.numeric(rhm$Date)+15,
         pst_y=1200*(log(rhm$UHOA)-log(lag(rhm$UHOA))),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2024/1/15")),
         yy_1=6.65,
         label="\\parbox{3cm}{\\centering Owners Equivalent Rent (OER)}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=75,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="RPR",
         pst_x=as.numeric(rhm$Date)+15,
         pst_y=1200*(log(rhm$UHSP)-log(lag(rhm$UHSP))),
         pst=pst_box,
         color="red",
         xx_1=as.numeric(as.Date("2024/1/15")),
         yy_1=4.3,
         label="\\parbox{3cm}{\\centering Rent of Primary Residence (RPR)}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=-75,
         side="left")




fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes"
                       ,"OER"
                       ,"RPR"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```


## PW_HousingUpdate_119a_OERvRPR_2005

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_119a_OERvRPR_2005-1.png)
```{r }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_119a_OERvRPR_2005"

factor=0.65
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("1983/11/1"),Sys.Date()+30),
                     pst_ylims         =c(0.97,1.105),
                     # pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("1985/1/1")),Sys.Date()+30,by="5 year"),
                     pst_xlines        =seq(as.Date(c("1985/1/1")),Sys.Date()+30,by="5 year"),
                     pst_yticks        =c(seq(0.98,1.1,by=.02)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=2,
                     # pst_yticks_decimalRight = 1,
                     aspect            =sqrt(2),
                     DateFormat    ="%y",
                     ylabel   ="\\scalebox{.8}{\\parbox{6cm}{\\centering Ratio \\\\ \\scriptsize{Monthly, Seasonally Adjusted}}}",
                     ylabel_sep= 500,
                     # ylabel_sepRight= 35,
                     # ylabelRight =
                     #      "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "\\scalebox{.5}{\\parbox{16cm}{\\textrm This figure shows the ratio of Owners Equivalent Rent (OER) and Rent of Primary Residence (RPR) components of the CPI.  Source:  Haver Analytics and BLS.}}")




fPSTLine(pst_root=FigureRoot,
         pst_name="Ratio",
         pst_x=as.numeric(rhm$Date)+15,
         pst_y=rhm$UHOA/rhm$UHSP,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2010/1/15")),
         yy_1=1.03,
         label="\\parbox{2cm}{\\centering Ratio of OER to RPR}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=45,
         side="left")






fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes"
                       ,"Ratio"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```


## PW_HousingUpdate_120_ConvergenceSpeed

Let 

+  $\lambda$ be the hazard of moving from below-market to market rent

+  $L$ is below market rent

+  $M$ is market rent.

+ $\phi$ is the initial share of below-market rent 

$$\text{Share below market}=\phi e^{-\lambda t}$$

$$CPI=(1-\phi)M+\phi\biggl(e^{-\lambda t}L+(1-e^{-\lambda t})M\biggr) $$
or
$$CPI=M+\phi e^{-\lambda t}(L-M)=M-\phi e^{-\lambda t}(M-L)$$
$$\dot CPI = \dot M +\lambda \phi e^{-\lambda t}(M-L) -\phi e^{-\lambda t}(\dot M)+\phi e^{-\lambda t}(\dot L) $$

$$\frac{\dot CPI}{CPI}=\frac{M_t}{CPI_t}\biggl[\frac{\dot M_t}{M_t}+
\underbrace{\lambda\biggl(1-\frac{L_t}{M_t}\biggr)\phi e^{-\lambda t}}_{\text{Effect of convergence}}+ 
\underbrace{\biggl(\frac{\dot L_t}{L_t}\frac{L_t}{M_t}- \frac{\dot M_t}{M_t} \biggr)\phi e^{-\lambda t}}_{\text{market v. non market inflation}}\biggr]$$
As $t\rightarrow \infty$,  $CPI$ rent inflation converges to market rent inflation.   Before then, it is a convex combination of the hazard and market rent inflation.  Holding the share of households paying non-market rent constant, a higher speed of convergence \emph{increases} inflation.  On other other hand, more people paying market rent lowers inflation.  


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_120_ConvergenceSpeed-1.png)

```{r }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_120_ConvergenceSpeed"

factor=0.65
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(-1,101),
                     pst_ylims         =c(-10,10.5),
                     pst_ylimsRight    =c(-5,120),
                     pst_xticks        =seq(0,100,by=10),
                     # pst_xlines        =seq(as.Date(c("1985/1/1")),as.Date("2022/1/1"),by="5 year"),
                     pst_yticks        =c(0,2,3,seq(4,10,by=2)),
                     # pst_ytickLabels   =c(seq(80,200,by=20)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =3,
                     pst_yticks_mainRight = 0,
                     pst_yticksRight   =seq(0,50,by=10),
                     pst_xticks_decimal=0,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 0,
                     aspect            =sqrt(1.5),
                     # DateFormat    ="",
                     ylabel   ="\\parbox{4cm}{\\centering Inflation in \\%}",
                     ylabel_sep= .5,
                     ylabel_sepRight= .5,
                     ylabelRight ="in \\%",
                     YNumberSideRight = "right",
                     TickLineColor = "lightgray",
                     XLabel_sep = 0.04,
                     XLabel = "\\parbox{10cm}{\\centering \\scalebox{.5}{In months}\\\\\\vspace{-.05in}
                     \\scalebox{.5}{\\parbox{20cm}{\\textrm This figure shows simulated paths of CPI Rent and Share of Units renting below market under different assumptions about the speed of transition of housing units from below market to market.}}}")

# RPCUHSHA@CPIDATA 
#   RPCUHSHA@CPIDATA   [CPI-U Relative Importance: Owners' Equivalent Rent of Residences (Parts per 100)]
# UHOA@CPIDATA 
#   UHOA@CPIDATA   [CPI-U: Owners' Equivalent Rent of Residences (SA, Dec-82=100)]
# UHSP@CPIDATA 
#   UHSP@CPIDATA   [CPI-U: Rent of Primary Residence (SA, 1982-84=100)]
# UI@CPIDATA 
#   UI@CPIDATA   [CPI-U: All Items (SA, 1982-84=100)]

tt=seq(0,100,by=1)


fConvergence <- function(tt,init_share,lambda,base_l,base_m,dotlogm,dotlogl){
     output=data.frame(tt) %>%
     mutate(init_share=init_share) %>%
     mutate(lambda=lambda) %>%
     mutate(dotlogm=dotlogm/12) %>%
     mutate(dotlogl=dotlogl/12) %>%
     mutate(m=base_m*exp(dotlogm/12*tt)) %>%
     mutate(l=base_l*exp(dotlogl/12*tt)) %>%
     mutate(share=exp(-lambda*tt)) %>%
     mutate(cpi=m-share*(m-l)) %>%
     mutate(dotm=dotlogm*m) %>%
     mutate(dotl=dotlogl*l) %>%
     mutate(dotlogcpi=m/cpi*(1-init_share)*dotlogm+
                 init_share*(dotlogm+
                                  lambda*(1-l/m)*share+
                                  share*(dotlogl*l/m-dotlogm))) %>%
          mutate(total_share=share*init_share)
     return(output)}

sim=fConvergence(tt=seq(0,100,by=1),
             init_share=0.5,
             lambda=0.01,
             base_l=80,
             base_m=100,
             dotlogm=0.03,
             dotlogl=0.04)
     

fPSTText(pst_root=FigureRoot,
         pst_name="CPILabel",
         pst=pst_box,
         xx_1=50,
         yy_1=9.5,
         label=paste0("Panel A: CPI Rent"),
         dir=90,
         sep=0,
         side="left")

fPSTText(pst_root=FigureRoot,
         pst_name="ShareLabel",
         pst=pst_box,
         xx_1=50,
         yy_1=48,
         label=paste0("Panel B: Share Below Market"),
         dir=90,
         sep=0,
         side="right")


fPSTLine(pst_root=FigureRoot,
         pst_name="Sim1",
         pst_x=sim$tt,
         pst_y=1200*sim$dotlogcpi,
         pst=pst_box,
         color="red",
         xx_1=70,
         yy_1=4,
         label="\\parbox{1in}{\\centering\\textcolor{red}{Low speed}}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 4pt",
         dir=90,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="Sim1share",
         pst_x=sim$tt,
         pst_y=100*sim$total_share,
         pst=pst_box,
         color="red",
         xx_1=60,
         yy_1=30,
         label="\\parbox{1in}{\\centering\\textcolor{red}{Low speed}}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 4pt",
         dir=75,
         side="right")

sim=fConvergence(tt=seq(0,100,by=1),
             init_share=0.5,
             lambda=0.06,
             base_l=80,
             base_m=100,
             dotlogm=0.03,
             dotlogl=0.04)
     

fPSTLine(pst_root=FigureRoot,
         pst_name="Sim2",
         pst_x=sim$tt,
         pst_y=1200*sim$dotlogcpi,
         pst=pst_box,
         color="green",
         xx_1=15,
         yy_1=6.2,
         label="\\parbox{1in}{\\raggedright\\textcolor{green}{High speed}}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 4pt",
         dir=45,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="Sim2share",
         pst_x=sim$tt,
         pst_y=100*sim$total_share,
         pst=pst_box,
         color="green",
         xx_1=20,
         yy_1=15,
         label="\\parbox{1in}{\\raggedright\\textcolor{green}{High speed}}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 4pt",
         dir=45,
         side="right")

####################################
fCompile(pst_root=FigureRoot,SubFiles=list("PSTAxes"
                                           ,"CPILabel"
                                           ,"ShareLabel"
                                           ,"Sim1"
                                           ,"Sim1share"
                                            ,"Sim2"
                                           ,"Sim2share"
                                           )
         ,PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

# pp<-readPNG(paste0(FigureRoot,"-1.png"))
plot.new()
# plot.window(xlim=c(0,1), ylim=c(0,1))
# rasterImage(pp,0,0,0.95,0.95*sqrt(2))
```




```{r}

lambda=0.1
l=100

t=seq(0,100,by=1)

xx=data_frame(t) %>%
     mutate(lambda=0.1) %>%
     mutate(l=50) %>%
     mutate(dotm=.03/12) %>%
     mutate(m=100*exp(dotm/12*t)) %>%
     mutate(share=exp(-lambda*t)) %>%
     mutate(dotcpi=lambda*(1-l/m)*share+(1-share)*dotm/m)
          



```




## PW_HousingUpdate_121_ConvergenceSpeedLogIndex

Let 

+  $\lambda$ be the hazard of moving from below-market to market rent

+  $L$ is below market rent

+  $M$ is market rent.

+ $\phi$ is the initial share of below-market rent 

$$\text{Share below market}=\phi e^{-\lambda t}$$

$$CPI=M^{(1-\phi)}L^{\phi e^{-\lambda t}}M^{\phi(1-e^{-\lambda t})=M(L/M)^{\phi e^{-\lambda t}}$$
or
$$\log CPI = \log M + \phi e^{-\lambda t} \log(L/M) $$
$$\dot CPI/CPI = \dot M/M +\lambda \phi e^{-\lambda t} \log(M/L) + 
\phi e^{-\lambda t}\biggl(\frac{\dot L}{L}-\frac{\dot M}{M}\biggr) $$

As $t\rightarrow \infty$,  $CPI$ rent inflation converges to market rent inflation.   Before then, it is a convex combination of the hazard and market rent inflation.  Holding the share of households paying non-market rent constant, a higher speed of convergence \emph{increases} inflation.  On other other hand, more people paying market rent lowers inflation.  

If we assume that both $L$ and $M$ grow at the same rate then

$$\dot CPI/CPI = \dot M/M +\lambda \phi e^{-\lambda t} \log(M/L) $$


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_121_ConvergenceSpeedLogIndex-1.png)

```{r }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_121_ConvergenceSpeedLogIndex"

factor=0.65
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(-1,101),
                     pst_ylims         =c(-10,10.5),
                     pst_ylimsRight    =c(-5,120),
                     pst_xticks        =seq(0,100,by=10),
                     # pst_xlines        =seq(as.Date(c("1985/1/1")),as.Date("2022/1/1"),by="5 year"),
                     pst_yticks        =c(0,2,3,seq(4,10,by=2)),
                     # pst_ytickLabels   =c(seq(80,200,by=20)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =3,
                     pst_yticks_mainRight = 0,
                     pst_yticksRight   =seq(0,50,by=10),
                     pst_xticks_decimal=0,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 0,
                     aspect            =sqrt(1.5),
                     # DateFormat    ="",
                     ylabel   ="\\parbox{4cm}{\\centering Inflation in \\%}",
                     ylabel_sep= .5,
                     ylabel_sepRight= .5,
                     ylabelRight ="in \\%",
                     YNumberSideRight = "right",
                     TickLineColor = "lightgray",
                     XLabel_sep = 0.04,
                     XLabel = "\\parbox{10cm}{\\centering \\scalebox{.5}{In months}\\\\\\vspace{-.05in}
                     \\scalebox{.5}{\\parbox{20cm}{\\textrm This figure shows simulated paths of CPI Rent and Share of Units renting below market under different assumptions about the speed of transition of housing units from below market to market.}}}")

# RPCUHSHA@CPIDATA 
#   RPCUHSHA@CPIDATA   [CPI-U Relative Importance: Owners' Equivalent Rent of Residences (Parts per 100)]
# UHOA@CPIDATA 
#   UHOA@CPIDATA   [CPI-U: Owners' Equivalent Rent of Residences (SA, Dec-82=100)]
# UHSP@CPIDATA 
#   UHSP@CPIDATA   [CPI-U: Rent of Primary Residence (SA, 1982-84=100)]
# UI@CPIDATA 
#   UI@CPIDATA   [CPI-U: All Items (SA, 1982-84=100)]

tt=seq(0,100,by=1)


fConvergence <- function(tt,init_share,lambda,base_l,base_m,dotlogm,dotlogl){
     output=data.frame(tt) %>%
     mutate(init_share=init_share) %>%
     mutate(lambda=lambda) %>%
     mutate(dotlogm=dotlogm/12) %>%
     mutate(dotlogl=dotlogl/12) %>%
     mutate(m=base_m*exp(dotlogm/12*tt)) %>%
     mutate(l=base_l*exp(dotlogl/12*tt)) %>%
     mutate(share=exp(-lambda*tt)) %>%
     mutate(cpi=m*(l/m)^(share*init_share)) %>%
    mutate(dotlogcpi=dotlogm+
                 lambda*init_share*share*log(m/l)+
                                  +init_share*share*(dotlogl-dotlogm)) %>%
          mutate(total_share=share*init_share)
     return(output)}

sim=fConvergence(tt=seq(0,100,by=1),
             init_share=0.5,
             lambda=0.01,
             base_l=80,
             base_m=100,
             dotlogm=0.03,
             dotlogl=0.04)
     

fPSTText(pst_root=FigureRoot,
         pst_name="CPILabel",
         pst=pst_box,
         xx_1=50,
         yy_1=9.5,
         label=paste0("Panel A: CPI Rent"),
         dir=90,
         sep=0,
         side="left")

fPSTText(pst_root=FigureRoot,
         pst_name="ShareLabel",
         pst=pst_box,
         xx_1=50,
         yy_1=48,
         label=paste0("Panel B: Share Below Market"),
         dir=90,
         sep=0,
         side="right")


fPSTLine(pst_root=FigureRoot,
         pst_name="Sim1",
         pst_x=sim$tt,
         pst_y=1200*sim$dotlogcpi,
         pst=pst_box,
         color="red",
         xx_1=70,
         yy_1=4,
         label="\\parbox{1in}{\\centering\\textcolor{red}{Low speed}}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 4pt",
         dir=90,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="Sim1share",
         pst_x=sim$tt,
         pst_y=100*sim$total_share,
         pst=pst_box,
         color="red",
         xx_1=60,
         yy_1=30,
         label="\\parbox{1in}{\\centering\\textcolor{red}{Low speed}}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 4pt",
         dir=75,
         side="right")

sim=fConvergence(tt=seq(0,100,by=1),
             init_share=0.5,
             lambda=0.06,
             base_l=80,
             base_m=100,
             dotlogm=0.03,
             dotlogl=0.04)
     

fPSTLine(pst_root=FigureRoot,
         pst_name="Sim2",
         pst_x=sim$tt,
         pst_y=1200*sim$dotlogcpi,
         pst=pst_box,
         color="green",
         xx_1=15,
         yy_1=6.2,
         label="\\parbox{1in}{\\raggedright\\textcolor{green}{High speed}}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 4pt",
         dir=45,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="Sim2share",
         pst_x=sim$tt,
         pst_y=100*sim$total_share,
         pst=pst_box,
         color="green",
         xx_1=20,
         yy_1=15,
         label="\\parbox{1in}{\\raggedright\\textcolor{green}{High speed}}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 4pt",
         dir=45,
         side="right")

####################################
fCompile(pst_root=FigureRoot,SubFiles=list("PSTAxes"
                                           ,"CPILabel"
                                           ,"ShareLabel"
                                           ,"Sim1"
                                           ,"Sim1share"
                                            ,"Sim2"
                                           ,"Sim2share"
                                           )
         ,PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

# pp<-readPNG(paste0(FigureRoot,"-1.png"))
plot.new()
# plot.window(xlim=c(0,1), ylim=c(0,1))
# rasterImage(pp,0,0,0.95,0.95*sqrt(2))
```

``` {r}
Decomp <- RepeatSale %>% 
     select(year,Date,
            coefiProp,coefooProp,coefrentProp,indexiProp,indexooProp,indexrentProp,
            inflation) 

new_row <- data.frame(year=1999,Date=as.Date("1999/1/1"),
                      indexiProp=0,indexooProp=0,indexrentProp=0)

Decomp <- bind_rows(Decomp,new_row) %>% arrange(year) %>%
     mutate(pr_rent=indexiProp-indexrentProp,
            po_rent=indexooProp-indexrentProp,
            po_pr=indexooProp-indexiProp,
            rent=indexrentProp)



```

## PW_HousingUpdate_122_PoRent_v_PrRent

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_122_PoRent_v_PrRent-1.png)

``` {r }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_122_PoRent_v_PrRent"


start_year=2000

Decomp2<-Decomp %>% filter(year>=start_year) %>%
     select(year,Date,coefiProp,coefooProp,coefrentProp) %>%
     mutate(coefiProp=ifelse(year==start_year,0,coefiProp),
            coefooProp=ifelse(year==start_year,0,coefooProp),
            coefrentProp=ifelse(year==start_year,0,coefrentProp),
            indexiProp=cumsum(coefiProp),
            indexooProp=cumsum(coefooProp),
            indexrentProp=cumsum(coefrentProp),
            Date= Date %m+% months(6)
            )


ylims=c(-22,52)
factor=.6

pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("1999/12/1"),as.Date("2013/2/1")),
                     pst_ylims         =ylims,
                     pst_xticks       =seq(as.Date(c("2000/7/1")),as.Date("2012/12/1"),by="1 year"),
                     # XTickLabels = lubridate::quarter(seq(as.Date(c("2019/2/15")),Sys.Date()-60,by="3 month")),
                     pst_xlines        =seq(as.Date(c("2000/1/1")),as.Date("2013/12/1"),by="1 year"),                                   
                     pst_yticks        =seq(-20,50,by=10),
                     #pst_ytickLabels = c(150,seq(200,800,by=100)),
                     factor            =factor,
                     # pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     # pst_ylimsRight = c(-2,20),
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(-2,10,by=2),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),#sqrt(2),
                     DateFormat    ="%Y",
                     ylabel   ="\\parbox{5cm}{\\centering Difference from 2000, \\\\ \\scriptsize{in log points $\\times$ 100}}",
                    ylabel_sep= 30,
                     # ylabel_sepRight= 100,
                     # ylabelRight ="in \\%",
                     # YNumberSideRight="right",
                     TickLineColor = "lightgray",
                     XLabel = "")



fPSTLine(pst_root=FigureRoot,
         pst_name="PoRent",
         pst_x=as.numeric(Decomp2$Date),
         pst_y=100*(Decomp2$indexooProp-Decomp2$indexrentProp),
         pst=pst_box,
         color="blue",
         xx_1=as.numeric(as.Date("2005/9/1")),
         yy_1=31,
         label="\\parbox{2in}{\\centering $P_o/\\text{rent}$}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=90,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="PrRent",
         pst_x=as.numeric(Decomp2$Date),
         pst_y=100*(Decomp2$indexiProp-Decomp2$indexrentProp),
         pst=pst_box,
         color="red",
         xx_1=as.numeric(as.Date("2004/11/1")),
         yy_1=45,
         label="\\parbox{2in}{\\flushright $P_r/\\text{rent}$ \\\\ (''Price-Rent Ratio'')}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=135,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="Rent",
         pst_x=as.numeric(Decomp2$Date),
         pst_y=100*(Decomp2$indexrentProp),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2012/6/1")),
         yy_1=23,
         label="\\parbox{1.5in}{\\flushright $\\text{rent}$}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=135,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="PoPr",
         pst_x=as.numeric(Decomp2$Date),
         pst_y=100*(Decomp2$indexooProp-Decomp2$indexiProp),
         pst=pst_box,
         color="green",
         xx_1=as.numeric(as.Date("2007/8/1")),
         yy_1=-13,
         label="\\parbox{1.5in}{\\flushright $P_o/P_r$ \\\\ (''Price-Price Ratio'')}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=135,
         side="left")

fCompile(pst_root=FigureRoot,SubFiles=list("PSTAxes"#"ListingsMA","SalesMA"
                                           ,"PoRent"
                                           ,"PrRent"
                                           ,"Rent"
                                           ,"PoPr"
                                           ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```


```{r}

lambda=0.1
l=100

t=seq(0,100,by=1)

xx=data_frame(t) %>%
     mutate(lambda=0.1) %>%
     mutate(l=50) %>%
     mutate(dotm=.03/12) %>%
     mutate(m=100*exp(dotm/12*t)) %>%
     mutate(share=exp(-lambda*t)) %>%
     mutate(dotcpi=lambda*(1-l/m)*share+(1-share)*dotm/m)
          



```


## PW_HousingUpdate_123_PoRent_v_PrRent_Long

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_123_PoRent_v_PrRent_Long-1.png)

``` {r }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_123_PoRent_v_PrRent_Long"

start_year=2000

Decomp2<-Decomp %>% filter(year>=start_year) %>%
     select(year,Date,coefiProp,coefooProp,coefrentProp) %>%
     mutate(coefiProp=ifelse(year==start_year,0,coefiProp),
            coefooProp=ifelse(year==start_year,0,coefooProp),
            coefrentProp=ifelse(year==start_year,0,coefrentProp),
            indexiProp=cumsum(coefiProp),
            indexooProp=cumsum(coefooProp),
            indexrentProp=cumsum(coefrentProp),
            Date= Date %m+% months(6)
            )


ylims=c(-22,72)
factor=.7

pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("1999/12/1"),as.Date("2023/2/1")),
                     pst_ylims         =ylims,
                     pst_xticks       =seq(as.Date(c("2000/7/1")),as.Date("2022/12/1"),by="1 year"),
                     # XTickLabels = lubridate::quarter(seq(as.Date(c("2019/2/15")),Sys.Date()-60,by="3 month")),
                     pst_xlines        =seq(as.Date(c("2000/1/1")),as.Date("2022/12/1"),by="1 year"),                                   
                     pst_yticks        =seq(-20,70,by=10),
                     #pst_ytickLabels = c(150,seq(200,800,by=100)),
                     factor            =factor,
                     # pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     # pst_ylimsRight = c(-2,20),
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(-2,10,by=2),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),#sqrt(2),
                     DateFormat    ="%y",
                     ylabel   ="\\parbox{5cm}{\\centering Difference from 2000, \\\\ \\scriptsize{in log points $\\times$ 100}}",
                    ylabel_sep= 30,
                     # ylabel_sepRight= 100,
                     # ylabelRight ="in \\%",
                     # YNumberSideRight="right",
                     TickLineColor = "lightgray",
                     XLabel = "")



fPSTLine(pst_root=FigureRoot,
         pst_name="PoRent",
         pst_x=as.numeric(Decomp2$Date),
         pst_y=100*(Decomp2$indexooProp-Decomp2$indexrentProp),
         pst=pst_box,
         color="blue",
         xx_1=as.numeric(as.Date("2005/9/1")),
         yy_1=31,
         label="\\parbox{2in}{\\centering $P_o/\\text{rent}$}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=90,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="PrRent",
         pst_x=as.numeric(Decomp2$Date),
         pst_y=100*(Decomp2$indexiProp-Decomp2$indexrentProp),
         pst=pst_box,
         color="red",
         xx_1=as.numeric(as.Date("2007/1/1")),
         yy_1=45,
         label="\\parbox{2in}{\\flushleft $P_r/\\text{rent}$ \\\\ (''Price-Rent Ratio'')}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=45,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="Rent",
         pst_x=as.numeric(Decomp2$Date),
         pst_y=100*(Decomp2$indexrentProp),
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2016/6/1")),
         yy_1=39,
         label="\\parbox{1.5in}{\\flushleft $\\text{rent}$}",
         LineStyle = "dashed",
         sep=0.0,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=-45,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="PoPr",
         pst_x=as.numeric(Decomp2$Date),
         pst_y=100*(Decomp2$indexooProp-Decomp2$indexiProp),
         pst=pst_box,
         color="green",
         xx_1=as.numeric(as.Date("2007/12/1")),
         yy_1=-7,
         label="\\parbox{1.5in}{\\flushleft $P_o/P_r$ \\\\ (''Price-Price Ratio'')}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=-45,
         side="left")

fCompile(pst_root=FigureRoot,SubFiles=list("PSTAxes"#"ListingsMA","SalesMA"
                                           ,"PoRent"
                                           ,"PrRent"
                                           ,"Rent"
                                           ,"PoPr"
                                           ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()
```


```{r}

lambda=0.1
l=100

t=seq(0,100,by=1)

xx=data_frame(t) %>%
     mutate(lambda=0.1) %>%
     mutate(l=50) %>%
     mutate(dotm=.03/12) %>%
     mutate(m=100*exp(dotm/12*t)) %>%
     mutate(share=exp(-lambda*t)) %>%
     mutate(dotcpi=lambda*(1-l/m)*share+(1-share)*dotm/m)
          
```


## PW_HousingUpdate_124_UDR

```{r,  }
csv_file="/shared/LoewensteinWillen/delinquency/intermediate/udr_rents.csv"

UDRDownload <- read_csv(csv_file) %>%
     readr::type_convert()

CostarData <- CostarDownload %>% select(cbsa_code,date,households,
                                        market_asking_rent_unit,
                                        market_effective_rent_unit)

Codes <- CostarDownload %>% group_by(geography_name) %>%
     summarize(cbsa_code=mean(cbsa_code)) %>%
     mutate(geography_name=str_replace(geography_name," - ",", ")) %>%
     mutate(geography_name=str_replace(geography_name,"[(]","")) %>%
     mutate(geography_name=str_replace(geography_name,"[)]","")) %>%
     mutate(geography_name=str_replace(geography_name," USA","")) %>%
     rename(location=geography_name)

UDR <- UDRDownload %>%
     mutate(date=as.Date(paste0(year(date),"/",month(date)-2,"/1"))) %>%
     mutate(location=str_replace(location,"Dallas","Dallas-Fort Worth")) %>%
     mutate(location=str_replace(location,"Metropolitan D.C.","Washington, DC")) %>%
     mutate(location=str_replace(location,"Monterey Peninsula","Salinas")) %>%
     mutate(location=str_replace(location,"Other Southern California","Inland Empire, CA")) %>%
     mutate(location=str_replace(location,"Other Florida","Miami, FL")) %>%
     left_join(.,Codes) %>%
     left_join(.,CostarData) 

     
UDR2023 <- UDR %>% 
     filter(date==as.Date("2022-4-1")|date==as.Date("2022-10-1")) %>%
     group_by(location) %>%
     summarize(gap_t=max(abs(gapt)),
               days_diff=as.numeric(difftime(date[2], date[1], units = "days")),
               quarters_diff= ceiling(days_diff / 92),
               avgrentgrowth2023=100*diff(log(rent))/quarters_diff*4,
               marginalrentgrowth2023=100*diff(log(market_effective_rent_unit))/quarters_diff*4
               ) %>%
               {.}

UDR_annual <- UDR %>% filter(quarter==4|quarter==2) %>%
     group_by(year,location) %>%
     summarize(households=mean(households),
               days_diff=as.numeric(difftime(date[2], date[1], units = "days")),
               quarters_diff= ceiling(days_diff / 92),
               avgrentgrowth=100*diff(log(rent))/quarters_diff*4,
               marginalrentgrowth=100*diff(log(market_effective_rent_unit))/quarters_diff*4) %>%
     ungroup() %>%
     group_by(year) %>%
     summarise(avgrentgrowth=weighted.mean(avgrentgrowth,households),
               marginalrentgrowth=weighted.mean(marginalrentgrowth,households),
               diff=avgrentgrowth-marginalrentgrowth)


```


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_124_UDR-1.png)

``` {r }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_124_UDR"



ylims=c(-21.5,21.5)
xlims=c(-21.5,21.5)
factor=.7

pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =xlims,
                     pst_ylims         =ylims,
                     pst_xticks       =seq(-10,10,by=2),
                     pst_yticks        =seq(-10,10,by=2),
                     factor            =factor,
                     pst_yticks_main   =99,
                     pst_xticks_decimal=0,
                     pst_yticks_decimal=0,
                     aspect            =sqrt(1),#sqrt(2),
                     ylabel   ="\\parbox{5cm}{\\centering Average Rent Growth in \\%}",
                     ylabel_sep= .3,
                     TickLineColor = "lightgray",
                     XLabel = "Marginal Rent Growth in \\%")



fPSTLine(pst_root=FigureRoot,
         pst_name="AvgVMarginal",
         pst_x=UDR2023$marginalrentgrowth2023,
         pst_y=UDR2023$avgrentgrowth2023,
         pst=pst_box,
         color="blue",
         xx_1=0,
         yy_1=0,
         label="\\parbox{2in}{\\centering }",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         Scatter = "true",
         dir=90,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="Diagonal",
         pst_x=xlims,
         pst_y=ylims,
         pst=pst_box,
         color="black",
         xx_1=0,
         yy_1=0,
         label="\\parbox{2in}{\\centering }",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="0.5pt",
         LineDash = "6pt 2pt",
         Scatter = "false",
         dir=90,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="ZeroMarginal",
         pst_x=rep(0,2),
         pst_y=ylims,
         pst=pst_box,
         color="lightgray",
         xx_1=0,
         yy_1=0,
         label="\\parbox{2in}{\\centering }",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="0.5pt",
         LineDash = "6pt 2pt",
         Scatter = "false",
         dir=90,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="ZeroAverage",
         pst_x=xlims,
         pst_y=rep(0,2),
         pst=pst_box,
         color="lightgray",
         xx_1=0,
         yy_1=0,
         label="\\parbox{2in}{\\centering }",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="0.5pt",
         LineDash = "6pt 2pt",
         Scatter = "false",
         dir=90,
         side="left")

fCompile(pst_root=FigureRoot,SubFiles=list("PSTAxes"#"ListingsMA","SalesMA"
                                           ,"AvgVMarginal"
                                           ,"Diagonal"
                                           ,"ZeroMarginal"
                                           ,"ZeroAverage"
                                           ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()
```


## PW_HousingUpdate_125_CPT

<!-- LoewensteinWillen/delinquency/data/secfilings/cpt/cpt_10k_23_24.csv -->

```{r}


#3 this merges together the properties in the camden property trust 10ks with costar information on the properties and all the market information by submarket.

csv_file="/shared/LoewensteinWillen/delinquency/data/costar/costar_10K_merge_final.csv"
costarDownload <- read_csv(csv_file) %>%
     readr::type_convert() %>%
     relocate(Period,avg_rent_10k,`Market Asking Rent/Unit_submarket`)

names(costarDownload) <- make_clean_names(names(costarDownload))     

costar <- costarDownload %>%
      mutate(date=as.Date(
          paste0(substr(period,1,4),"/",
                 3*as.numeric(substr(period,7,7))-2,"/1"))) %>%
     select(date,property_name,market_effective_rent_unit_submarket,market_name,inventory_units_submarket) 

costar_annual <- costar %>% mutate(year=year(date)) %>%
     group_by(year,property_name) %>%
     summarise(year=mean(year),
               rent=mean(market_effective_rent_unit_submarket),
               market_name=paste(unique(market_name)),
               inventory=mean(inventory_units_submarket))

# this is average rent per unit by year for each of the properties.

csv_file="/shared/LoewensteinWillen/delinquency/intermediate/cpt_10k_avg_rent.csv"
cptDownload <- read_csv(csv_file) %>%
     readr::type_convert()
names(cptDownload) <- make_clean_names(names(cptDownload))     

cpt <- cptDownload %>%
     mutate(date=as.Date(
          paste0(year,"/10/1")),
          year=year(date)) %>%
     # rename(property_name=property) %>%
     mutate(property_name=trimws(gsub("\\([^()]*\\)", "", property))) 

# here we join together the property names 

cpt_y_o_y <- cpt %>%
     left_join(costar) %>%
     group_by(property_name) %>%
     mutate(new_rent=avg_rent[1]*market_effective_rent_unit_submarket/market_effective_rent_unit_submarket[1],
            gap=log(new_rent)-log(avg_rent),
            avg_growth=log(avg_rent)-lag(log(avg_rent)),
            new_growth=log(new_rent)-lag(log(new_rent))) %>%
     na.omit(.)

cpt_gap <- cpt_y_o_y %>% group_by(date) %>%
     summarize(pos_gap=mean(gap>0),
               gap=mean(gap),
               avg_rent=mean(avg_rent),
               new_rent=mean(new_rent),
               avg_growth=mean(avg_growth),
               new_growth=mean(new_growth)) %>%
     na.omit(.)


cpt_annual <- cpt %>% left_join(costar_annual) %>%
     group_by(property_name) %>%
     mutate(new_rent=avg_rent[1]*rent/rent[1],
            gap=log(new_rent)-log(avg_rent),
            avg_growth=log(avg_rent)-lag(log(avg_rent)),
            new_growth=log(new_rent)-lag(log(new_rent))) %>%
     filter(is.na(inventory)==0) %>%
     # na.omit(.) %>%
     {.}

cpt_gap_annual <- cpt_annual %>% group_by(year) %>%
     summarize(pos_gap=weighted.mean(gap>0,inventory,na.rm=TRUE),
               gap=weighted.mean(gap,inventory,na.rm=TRUE),
               avg_rent=weighted.mean(avg_rent,inventory,na.rm=TRUE),
               new_rent=weighted.mean(new_rent,inventory,na.rm=TRUE),
               avg_growth=weighted.mean(avg_growth,inventory,na.rm=TRUE),
               new_growth=weighted.mean(new_growth,inventory,na.rm=TRUE)) %>%
     # na.omit(.) %>%
     {.}

```

## PW_HousingUpdate_126_ConstructionPipeline


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_126_ConstructionPipeline-1.png) 

``` {r }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_126_ConstructionPipeline"

factor=0.65
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("1984/1/1"),Sys.Date()+30),
                     pst_ylims         =c(-50,1850),
                     # pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("1985/1/1")),Sys.Date()+30,by="5 year"),
                     # pst_xlines        =seq(as.Date(c("1985/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =c(seq(0,2000,by=200)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 1,
                     aspect            =sqrt(2),
                     DateFormat    ="%Y",
                     ylabel   ="\\scalebox{.8}{\\parbox{6cm}{\\centering Units under construction \\\\ \\scriptsize{In thousands, seasonally adjusted at annual rates}}}",
                     ylabel_sep= 600,
                     # ylabel_sepRight= 35,
                     # ylabelRight =
                     #      "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                      XLabel = "\\scalebox{.5}{\\parbox{16cm}{\\textrm This figure shows units of housing under construction.  Source:  US Census}}")






fPSTLine(pst_root=FigureRoot,
         pst_name="HCCT",
         pst_x=as.numeric(rhm$Date),
         pst_y=rhm$HCCT,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2003/3/15")),
         yy_1=1500,
         label="\\parbox{2cm}{\\centering Construction Pipeline}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=90,
         side="left")


fPSTArea(pst_root=FigureRoot,
         pst_name="SF",
         pst_x=as.numeric(rhm$Date),
         pst_y=rhm$HCCT-rhm$HCC1,
         pst_y2 =rhm$HCCT,
         pst=pst_box,
         color=paste0(as.character(c(255,156,96)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2002/7/1")),
         yy_1=600,
         label="\\parbox{1in}{\\centering Single Family}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=90,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="MF",
         pst_x=as.numeric(rhm$Date),
         pst_y=c(0,0),
         pst_y2 =rhm$HCCT-rhm$HCC1,
         pst=pst_box,
         color=paste0(as.character(c(96,255,96)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2018/12/1")),
         yy_1=200,
         label="\\parbox{1in}{\\centering Multi-family }",
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".5pt",
         LineDash = "6pt 2pt",
         dir=90,
         Opacity = .4,
         side="left")


fCompile(pst_root=FigureRoot,
         SubFiles=list("HCCT"
                       ,"SF"
                       ,"MF"
                       ,"PSTAxes"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```


## PW_HousingUpdate_127_RentComparison_SFRI


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_127_RentComparison_SFRI-1.png) 

``` {r, }

RentComparisonLevel <- RentComparison %>% filter(date>=as.Date("2005/1/1")) %>%
     pivot_longer(.,cols=names(.)[2:NCOL(.)],
                  names_to="Series",
                  values_to="value") %>%
     group_by(Series) %>%
     mutate(index=value/value[1]*100) %>%
     select(-value) %>%
     pivot_wider(.,
                 names_from=Series,
                 values_from=index)

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_127_RentComparison_SFRI"

factor=0.75
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2004/12/1"),Sys.Date()+30),
                     pst_ylims         =log(c(98,195)),
                     # pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("2005/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2005/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =log(c(seq(100,190,by=10))),
                     pst_ytickLabels =c(seq(100,190,by=10)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =100,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 1,
                     aspect            =sqrt(2),
                     DateFormat    ="%y",
                     ylabel   ="\\scalebox{.8}{\\parbox{4cm}{\\centering Cumulative Rent Growth \\\\ \\scriptsize{Q1, 2005=100}}}",
                     ylabel_sep= 100,
                     # ylabel_sepRight= 35,
                     # ylabelRight =
                     #      "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "\\scalebox{.5}{\\parbox{20cm}{\\textrm This figures shows various rent indexes at quarterly frequency, all relative to the first quarter of 2005.}}")





fPSTLine(pst_root=FigureRoot,
         pst_name="SFRI",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=log(RentComparisonLevel$SFRI),
         pst=pst_box,
         color="blue",
         xx_1=as.numeric(as.Date("2018/1/1")),
         yy_1=log(150),
         label="\\parbox{3cm}{\\centering Combined \\\\ (blue solid line)}",
         LineStyle = "solid",
         sep=0.2,
         LineWidth="0.5pt",
         LineDash = "6pt 2pt",
         dir=90,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="Attached",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=log(RentComparisonLevel$SFRI_Attached),
         pst=pst_box,
         color="red",
         xx_1=as.numeric(as.Date("2016/1/1")),
         yy_1=log(135),
         label="\\parbox{3cm}{\\raggedleft Attached}",
         LineStyle = "dashed",
         sep=0.2,
         LineWidth="0.5pt",
         LineDash = "6pt 2pt",
         dir=135,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="Detached",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=log(RentComparisonLevel$SFRI_Detached),
         pst=pst_box,
         color="green",
         xx_1=as.numeric(as.Date("2016/1/1")),
         yy_1=log(128),
         label="\\parbox{3cm}{\\raggedright Detached}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="0.5pt",
         LineDash = "1pt 1pt",
         dir=-45,
         side="left")


fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes"
                         ,"SFRI"
                         ,"Attached"
                       ,"Detached"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```



## PW_HousingUpdate_128_Zillow_v_SFRI


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_128_Zillow_v_SFRI-1.png) 

``` {r, }

RentComparisonLevel <- RentComparison %>% filter(date>=as.Date("2019/10/1")) %>%
     pivot_longer(.,cols=names(.)[2:NCOL(.)],
                  names_to="Series",
                  values_to="value") %>%
     group_by(Series) %>%
     mutate(index=value/value[1]*100) %>%
     select(-value) %>%
     pivot_wider(.,
                 names_from=Series,
                 values_from=index)

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_128_Zillow_v_SFRI"

factor=0.65
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2018/12/1"),Sys.Date()+30),
                     pst_ylims         =c(95,142),
                     # pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("2019/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2019/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =c(seq(100,140,by=10)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =100,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 1,
                     aspect            =sqrt(1.25),
                     DateFormat    ="%Y",
                     ylabel   ="\\scalebox{.8}{\\parbox{4cm}{\\centering Cumulative Rent Growth \\\\ \\scriptsize{Q4, 2019=100}}}",
                     ylabel_sep= 60,
                     # ylabel_sepRight= 35,
                     # ylabelRight =
                     #      "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "\\scalebox{.5}{\\parbox{16cm}{\\textrm This figures shows various rent indexes all relative to the fourth quarter of 2019}}")




fPSTLine(pst_root=FigureRoot,
         pst_name="SFRIAttached",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$SFRI_Attached,
         pst=pst_box,
         color="red",
         xx_1=as.numeric(last(RentComparisonLevel$date))+45,
         yy_1=last(na.omit(RentComparisonLevel$SFRI_Attached)),
         label="$\\swarrow$\\parbox{3cm}{\\raggedright SFRI Attached}",
         LineStyle = "solid",
         sep=0.01,
         LineWidth="1pt",
         LineDash = "6pt 2pt",
         dir=45,
         side="left")


fPSTLine(pst_root=FigureRoot,
         pst_name="SFRIDetached",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$SFRI_Detached,
         pst=pst_box,
         color="red",
         xx_1=as.numeric(last(RentComparisonLevel$date))+45,
         yy_1=last(na.omit(RentComparisonLevel$SFRI_Detached)),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright SFRI Detached}",
         LineStyle = "dashed",
         sep=0.01,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="ZillowMF",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$ZillowMF,
         pst=pst_box,
         color="green",
         xx_1=as.numeric(last(RentComparisonLevel$date))+45,
         yy_1=last(na.omit(RentComparisonLevel$ZillowMF)),
         label="$\\nwarrow$\\parbox{3cm}{\\raggedright Zillow MF}",
         LineStyle = "solid",
         sep=0.01,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=-45,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="ZillowSF",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$ZillowSF,
         pst=pst_box,
         color="green",
         xx_1=as.numeric(last(RentComparisonLevel$date))+45,
         yy_1=last(na.omit(RentComparisonLevel$ZillowSF)),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright Zillow SF}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="Costar",
         pst_x=as.numeric(RentComparisonLevel$date)+45,
         pst_y=RentComparisonLevel$Costar,
         pst=pst_box,
         color="blue",
         xx_1=as.numeric(last(RentComparisonLevel$date))+45,
         yy_1=last(na.omit(RentComparisonLevel$Costar)),
         label="$\\leftarrow$\\parbox{3cm}{\\raggedright Costar}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 2pt",
         dir=0,
         side="left")




fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes"
                       ,"ZillowSF"
                       ,"ZillowMF"
                       ,"SFRIAttached"
                       ,"SFRIDetached"
                       ,"Costar"
                       # ,"Earnings"
                       # ,"SFRILabel"
                       # ,"HPI"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```











## PW_HousingUpdate_129_AHM


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_129_AHM-1.png) 

``` {r, }


csv_file="/home/a1psw01/Desktop/Notebooks/Data/amh_reit_data.csv"

ahmDownload <- read_csv(csv_file) %>%
     readr::type_convert() %>%
     mutate(market=ifelse(grepl("Total",market)==1,"Total / Average",market))

ahmTotal <- ahmDownload %>% 
     filter(market=="Total / Average") %>%
     # filter(market=="Phoenix, AZ") %>%
     {.}

ahmBar1 <- ahmTotal %>% mutate(code=1) %>%
     mutate(rent_re_leases=0,rent_new_leases=0)
ahmBar2 <- ahmTotal %>% mutate(code=2)
ahmBar3 <- ahmTotal %>% mutate(code=3) %>%
     mutate(date=date+30)
ahmBar4 <- ahmTotal %>% mutate(code=4) %>%
     mutate(rent_re_leases=0,rent_new_leases=0) %>%
     mutate(date=date+30)

ahmBar <- rbind(ahmBar1,ahmBar2,ahmBar3,ahmBar4)  %>%
     arrange(date,code)

require(haven)

xx<-read_dta("/home/a1psw01/Desktop/Notebooks/Data/exShelterCPIByPSU.dta")
```


```{r}
FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_129_AHM"

factor=0.65
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2014/12/1"),Sys.Date()+30),
                     pst_ylims         =c(-1,17),
                     # pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("2015/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2015/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =c(seq(0,16,by=4)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 1,
                     aspect            =sqrt(1.25),
                     DateFormat    ="%Y",
                     ylabel   ="\\scalebox{.8}{\\parbox{4cm}{\\centering Rent growth \\\\ \\scriptsize{in percent}}}",
                     ylabel_sep= 10,
                     # ylabel_sepRight= 35,
                     # ylabelRight =
                     #      "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "\\scalebox{.5}{\\parbox{16cm}{\\textrm This figures shows rent-growth for same units at the time of leasing.  Source: America's Homes For Rent REIT SEC filings}}")





fPSTArea(pst_root=FigureRoot,
         pst_name="New",
         pst_x=as.numeric(ahmBar$date)-30+45,
         pst_y=100*rep(0,NROW(ahmBar)),
         pst_y2 =ahmBar$rent_new_leases,
         pst=pst_box,
         color=paste0(as.character(c(255,64,64)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2021/10/1")),
         yy_1=14,
         label="\\parbox{1.5cm}{\\centering New Leases\\\\ (red)}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=45,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="Renewal",
         pst_x=as.numeric(ahmBar$date)+45,
         pst_y=100*rep(0,NROW(ahmBar)),
         pst_y2 =ahmBar$rent_re_leases,
         pst=pst_box,
         color=paste0(as.character(c(0,192,96)/256),collapse = ","),
           xx_1=as.numeric(as.Date("2023/12/1")),
         yy_1=5,
         label="\\parbox{1.25cm}{\\centering Renewals (green)}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=45,
         Opacity = .4,
         side="left")





fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes"
                       ,"New"
                       ,"Renewal"
                       # ,"Earnings"
                       # ,"SFRILabel"
                       # ,"HPI"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```














## PW_HousingUpdate_129a_AHM_Phoenix


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_129a_AHM_Phoenix-1.png) 

``` {r, }


csv_file="/home/a1psw01/Desktop/Notebooks/Data/amh_reit_data.csv"

ahmDownload <- read_csv(csv_file) %>%
     readr::type_convert() %>%
     mutate(market=ifelse(grepl("Total",market)==1,"Total / Average",market))

ahmTotal <- ahmDownload %>% 
     # filter(market=="Total / Average") %>%
     filter(market=="Phoenix, AZ") %>%
     {.}

ahmBar1 <- ahmTotal %>% mutate(code=1) %>%
     mutate(rent_re_leases=0,rent_new_leases=0)
ahmBar2 <- ahmTotal %>% mutate(code=2)
ahmBar3 <- ahmTotal %>% mutate(code=3) %>%
     mutate(date=date+30)
ahmBar4 <- ahmTotal %>% mutate(code=4) %>%
     mutate(rent_re_leases=0,rent_new_leases=0) %>%
     mutate(date=date+30)

ahmBar <- rbind(ahmBar1,ahmBar2,ahmBar3,ahmBar4)  %>%
     arrange(date,code)


```


```{r}
FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_129a_AHM_Phoenix"

factor=0.65
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2014/12/1"),Sys.Date()+30),
                     pst_ylims         =c(-1,27),
                     # pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("2015/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2015/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =c(seq(0,25,by=5)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 1,
                     aspect            =sqrt(1.25),
                     DateFormat    ="%Y",
                     ylabel   ="\\scalebox{.8}{\\parbox{4cm}{\\centering Rent growth \\\\ \\scriptsize{in percent}}}",
                     ylabel_sep= 10,
                     # ylabel_sepRight= 35,
                     # ylabelRight =
                     #      "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "\\scalebox{.5}{\\parbox{16cm}{\\textrm This figures shows rent-growth for same units at the time of leasing.  Source: America's Homes For Rent REIT SEC filings}}")





fPSTArea(pst_root=FigureRoot,
         pst_name="New",
         pst_x=as.numeric(ahmBar$date)-30+45,
         pst_y=100*rep(0,NROW(ahmBar)),
         pst_y2 =ahmBar$rent_new_leases,
         pst=pst_box,
         color=paste0(as.character(c(255,64,64)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2021/10/1")),
         yy_1=24,
         label="\\parbox{1.5cm}{\\centering New Leases\\\\ (red)}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=45,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="Renewal",
         pst_x=as.numeric(ahmBar$date)+45,
         pst_y=100*rep(0,NROW(ahmBar)),
         pst_y2 =ahmBar$rent_re_leases,
         pst=pst_box,
         color=paste0(as.character(c(0,192,96)/256),collapse = ","),
           xx_1=as.numeric(as.Date("2023/12/1")),
         yy_1=5,
         label="\\parbox{1.25cm}{\\centering Renewals (green)}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=45,
         Opacity = .4,
         side="left")





fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes"
                       ,"New"
                       ,"Renewal"
                       # ,"Earnings"
                       # ,"SFRILabel"
                       # ,"HPI"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```















## PW_HousingUpdate_129b_AHM


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_129b_AHM_PhoenixAZ-1.png) 

``` {r, }


csv_file="/home/a1psw01/Desktop/Notebooks/Data/amh_reit_data.csv"

ahmDownload <- read_csv(csv_file) %>%
     readr::type_convert() %>%
     mutate(market=ifelse(grepl("Total",market)==1,"Total / Average",market)) %>%
     mutate(market=gsub(" ","",market),
            market=gsub("[/(),]","",market),
            market=gsub("[(]","",market),
            market=gsub("[)]","",market),
            market=gsub("[$,]","",market))



```


```{r}


for (markets in unique(ahmDownload$market)) {
FigureRoot=
     paste0("/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_129b_AHM_",markets)

ahmTotal <- ahmDownload %>% 
     # filter(market=="Phoenix, AZ") %>%
     filter(market==markets) %>%
     mutate(quarter=quarter(date)) %>%
     # filter(quarter==3) %>%
     {.}

barWidth=30

ahmBar1 <- ahmTotal %>% mutate(code=1) %>%
     mutate(rent_re_leases=0,rent_new_leases=0)
ahmBar2 <- ahmTotal %>% mutate(code=2)
ahmBar3 <- ahmTotal %>% mutate(code=3) %>%
     mutate(date=date+barWidth)
ahmBar4 <- ahmTotal %>% mutate(code=4) %>%
     mutate(rent_re_leases=0,rent_new_leases=0) %>%
     mutate(date=date+barWidth)

ahmBar <- rbind(ahmBar1,ahmBar2,ahmBar3,ahmBar4)  %>%
     arrange(date,code)


factor=0.65
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2014/12/1"),Sys.Date()+30),
                     pst_ylims         =c(-1,17),
                     # pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("2015/7/1")),Sys.Date()+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2015/1/1")),Sys.Date()+30,by="1 year"),
                     pst_yticks        =c(seq(0,16,by=4)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 1,
                     aspect            =sqrt(1.25),
                     DateFormat    ="%Y",
                     ylabel   ="\\scalebox{.8}{\\parbox{4cm}{\\centering Rent growth \\\\ \\scriptsize{in percent}}}",
                     ylabel_sep= 10,
                     # ylabel_sepRight= 35,
                     # ylabelRight =
                     #      "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "\\scalebox{.5}{\\parbox{16cm}{\\textrm This figures shows rent-growth for same units at the time of leasing.  Source: America's Homes For Rent REIT SEC filings}}")





fPSTArea(pst_root=FigureRoot,
         pst_name="New",
         pst_x=as.numeric(ahmBar$date)-barWidth,
         pst_y=100*rep(0,NROW(ahmBar)),
         pst_y2 =ahmBar$rent_new_leases,
         pst=pst_box,
         color=paste0(as.character(c(255,64,64)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2021/10/1")),
         yy_1=14,
         label="\\parbox{1.5cm}{\\centering New Leases\\\\ (red)}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=45,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="Renewal",
         pst_x=as.numeric(ahmBar$date),
         pst_y=100*rep(0,NROW(ahmBar)),
         pst_y2 =ahmBar$rent_re_leases,
         pst=pst_box,
         color=paste0(as.character(c(0,192,96)/256),collapse = ","),
           xx_1=as.numeric(as.Date("2023/12/1")),
         yy_1=5,
         label="\\parbox{1.25cm}{\\centering Renewals (green)}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=45,
         Opacity = .4,
         side="left")





fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes"
                       ,"New"
                       ,"Renewal"
                       # ,"Earnings"
                       # ,"SFRILabel"
                       # ,"HPI"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")
}

plot.new()

```














## PW_HousingUpdate_130_AHM_2


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_130_AHM_2-1.png) 

``` {r, }


csv_file="/home/a1psw01/Desktop/Notebooks/Data/amh_reit_data.csv"

ahmDownload <- read_csv(csv_file) %>%
     readr::type_convert() %>%
     mutate(market=ifelse(grepl("Total",market)==1,"Total / Average",market))

ahmTotal_b <- ahmDownload %>% filter(market=="Total / Average") %>%
     mutate(quarter=quarter(date))


for (qq in seq(1,4,by=1)){
     xx=ahmTotal_b %>% filter(quarter==qq) %>%
     arrange(desc(date)) %>% 
     mutate(c_rent_re_leases=exp(cumsum(rent_re_leases)/100),
            c_rent_new_leases=exp(cumsum(rent_new_leases)/100)) %>%
     arrange(date) %>%
     mutate(date=date %m-% years(1)) 
     assign(paste0("ahm",qq),xx)}


ahmBar1 <- ahm3 %>% mutate(code=1) %>%
     mutate(c_rent_re_leases=1,c_rent_new_leases=1)
ahmBar2 <- ahm3 %>% mutate(code=2)
ahmBar3 <- ahm3 %>% mutate(code=3) %>%
     mutate(date=date+60)
ahmBar4 <- ahm3 %>% mutate(code=4) %>%
     mutate(c_rent_re_leases=1,c_rent_new_leases=1) %>%
     mutate(date=date+60)

ahmBar <- rbind(ahmBar1,ahmBar2,ahmBar3,ahmBar4)  %>%
     arrange(date,code)



```


```{r}
FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_130_AHM_2"

factor=0.65
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2013/12/1"),Sys.Date()%m-% years(1)+30),
                     pst_ylims         =c(-1,95),
                     # pst_ylimsRight    =c(7.2,12),
                     pst_xticks        =seq(as.Date(c("2014/7/1")),Sys.Date()%m-% years(1)+30,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2014/1/1")),Sys.Date()%m-% years(1)+30,by="1 year"),
                     pst_yticks        =c(seq(0,90,by=15)),
                     factor            =factor,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(7.5,9,by=.5),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 1,
                     aspect            =sqrt(1.25),
                     DateFormat    ="%Y",
                     ylabel   ="\\scalebox{.8}{\\parbox{4cm}{\\centering Cumulative rent growth \\\\ \\scriptsize{in percent}}}",
                     ylabel_sep= 10,
                     # ylabel_sepRight= 35,
                     # ylabelRight =
                     #      "\\parbox{1.5cm}{\\centering\\scriptsize Rent/Price ratio in \\%}",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "\\scalebox{.5}{\\parbox{16cm}{\\textrm This figures shows cumulative rent growth for a unit leased in the third quarter and is either renewed every year or is leased to a new tenant.  Source: America's Homes For Rent REIT SEC filings}}")





fPSTArea(pst_root=FigureRoot,
         pst_name="New",
         pst_x=as.numeric(ahmBar$date)-60-30,
         pst_y=100*rep(0,NROW(ahmBar)),
         pst_y2 =100*ahmBar$c_rent_new_leases-100,
         pst=pst_box,
         color=paste0(as.character(c(255,64,64)/256),collapse = ","),
         xx_1=as.numeric(as.Date("2016/12/1")),
         yy_1=67,
         label="\\parbox{1.5cm}{\\centering Re-leased each year\\\\ (red)}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=45,
         Opacity = .4,
         side="left")

fPSTArea(pst_root=FigureRoot,
         pst_name="Renewal",
         pst_x=as.numeric(ahmBar$date)-30,
         pst_y=100*rep(0,NROW(ahmBar)),
         pst_y2 =100*ahmBar$c_rent_re_leases-100,
         pst=pst_box,
         color=paste0(as.character(c(0,192,96)/256),collapse = ","),
           xx_1=as.numeric(as.Date("2021/12/1")),
         yy_1=16,
         label="\\parbox{1.25cm}{\\centering Renewed each year (green)}",
         LineStyle = "none",
         sep=0.1,
         LineWidth="0pt",
         LineDash = "6pt 2pt",
         dir=45,
         Opacity = .4,
         side="left")





fCompile(pst_root=FigureRoot,
         SubFiles=list("PSTAxes"
                       ,"New"
                       ,"Renewal"
                       # ,"Earnings"
                       # ,"SFRILabel"
                       # ,"HPI"
                       ),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()

```





## PW_HousingUpdate_131_Regression


```{r,  }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_131_Regressions"



cpi_data <- rhm %>% select(Date,UIXFDHEN) %>%
     mutate(year=year(Date),quarter=quarter(Date)) %>%
     group_by(year,quarter) %>%
     summarise_all(mean) %>%
     ungroup %>%
     mutate(date=as.Date(paste0(year,"/",3*quarter-2,"/1"))) %>%
     mutate(inflation_ex_shelter=100*(log(UIXFDHEN)-lag(log(UIXFDHEN),4))) %>%
     na.omit() %>%
     {.}

csv_file="/home/a1psw01/Desktop/Notebooks/Data/amh_reit_data.csv"


ahmData <- read_csv(csv_file) %>%
     readr::type_convert() %>%
     mutate(market=ifelse(grepl("Total",market)==1,"Total / Average",market)) %>%
     mutate(market=gsub(" ","",market),
            market=gsub("[/(),]","",market)) %>%
     mutate(quarter=quarter(date))  %>%
     mutate(constant=1) %>%
     left_join(.,cpi_data) %>%
     filter(is.na(rent_new_leases)!=1) %>%
     # na.omit() %>%
     {.}


num="131a"
name<-paste0("spec",num)
specs<-name #c(specs,name)
y<-"rent_re_leases"
x<-c("rent_new_leases | market^factor(quarter)")
StartDate<-as.Date("2018/1/1")
EndDate<-as.Date("2024/6/30")
reg_formula<-formula(paste(y, paste(x, collapse=" + "), sep=" ~ " ))
sample<- ahmData
Output  <- feols(reg_formula,data=sample)
assign(name,list(y=y,x=x,Output=Output,StartDate=StartDate,EndDate=EndDate))

num="131b"
name<-paste0("spec",num)
specs<-c(specs,name)
y<-"rent_re_leases"
x<-c("rent_new_leases+inflation_ex_shelter|market^factor(quarter)")
StartDate<-as.Date("2018/1/1")
EndDate<-as.Date("2024/6/30")
reg_formula<-formula(paste(y, paste(x, collapse=" + "), sep=" ~ " ))
sample<- ahmData
Output  <- feols(reg_formula,data=sample)
assign(name,list(y=y,x=x,Output=Output,StartDate=StartDate,EndDate=EndDate))

num="131c"
name<-paste0("spec",num)
specs<-c(specs,name)
y<-"rent_re_leases"
x<-c("inflation_ex_shelter| market^factor(quarter)")
StartDate<-as.Date("2018/1/1")
EndDate<-as.Date("2024/6/30")
reg_formula<-formula(paste(y, paste(x, collapse=" + "), sep=" ~ " ))
sample<- ahmData
Output  <- feols(reg_formula,data=sample)
assign(name,list(y=y,x=x,Output=Output,StartDate=StartDate,EndDate=EndDate))


num="131d"
name<-paste0("spec",num)
specs<-c(specs,name)
y<-"rent_re_leases"
x<-c("rent_new_leases|market^factor(quarter)+factor(date)")
StartDate<-as.Date("2018/1/1")
EndDate<-as.Date("2024/6/30")
reg_formula<-formula(paste(y, paste(x, collapse=" + "), sep=" ~ " ))
sample<- ahmData
Output  <- feols(reg_formula,data=sample)
assign(name,list(y=y,x=x,Output=Output,StartDate=StartDate,EndDate=EndDate))

num="131e"
name<-paste0("spec",num)
specs<-c(specs,name)
y<-"rent_re_leases"
x<-c("1 | market^factor(quarter)+factor(date)")
StartDate<-as.Date("2018/1/1")
EndDate<-as.Date("2024/6/30")
reg_formula<-formula(paste(y, paste(x, collapse=" + "), sep=" ~ " ))
sample<- ahmData
Output  <- feols(reg_formula,data=sample)
assign(name,list(y=y,x=x,Output=Output,StartDate=StartDate,EndDate=EndDate))


dictx = c(rent_new_leases="\\multirow{2}{6cm}{\\hangindent=1cm Rent growth for new leases}",
          rent_re_leases="Rent growth for renewals",
          inflation_ex_shelter="\\multirow{2}{6cm}{\\hangindent=1cm Core inflation ex-shelter}")

eval(
     parse(
          text=paste0(
               "etable(list(",
               paste0(specs,"$Output",collapse=","),")",
               # ",tex = TRUE",
               paste0(",file =\"",FigureRoot,"_tabular.tex\""),
               ",replace = TRUE",
               ",dict=dictx",
               ",vcov=~quarter+market",
               ")"
               )
          )
     )

cor(ahmData$rent_new_leases,ahmData$inflation_ex_shelter)

fCompileTable(pst_root=FigureRoot,Width="!",Height="3cm",
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()


m1 <- feols(rent_re_leases ~ 1 | factor(date), data = ahmData)
m2 <- feols(rent_re_leases ~ rent_new_leases | factor(date), data = ahmData)
etable(m1, m2)
```



## PW_HousingUpdate_132_Redfin_Inventory

![](../Output/PW_HousingUpdate_132_Redfin_Inventory-1.png)
``` {r }

FigureRoot="../Output/PW_HousingUpdate_132_Redfin_Inventory"


ylims=c(17,122)

factor=0.75
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2016/12/1"),Sys.Date()+90),
                     pst_ylims         =ylims,
                     pst_xticks       =seq(as.Date(c("2017/07/01")),Sys.Date()+90,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2017/01/01")),Sys.Date()+90,by="1 year"),                                   pst_yticks        =seq(20,120,by=20),
                     factor            =factor,
                     # pst_xticks_main   =0,
                     pst_yticks_main   =100,
                     # pst_ylimsRight = c(-2,20),
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(-2,10,by=2),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),#sqrt(2),
                     DateFormat    ="%y",
                     ylabel   ="\\parbox{7cm}{\\centering 2017-2019=100, Seasonally Adjusted}",
                     ylabel_sep= 50,
                     # ylabel_sepRight= 100,
                     # ylabelRight ="in \\%",
                     # YNumberSideRight="right",
                     TickLineColor = "lightgray",
                     XLabel = "")

codes <- c("MA","CT","RI","ME","VT","NH","US")
cc <- c("blue","red","green","yellow","magenta","cyan","black")

states=data.frame(codes,cc)

for (ii in seq(1,NROW(states),by=1)){
redfin_i <- redfin2 %>% filter(state_code==states$codes[ii])




fPSTLine(pst_root=FigureRoot,
         pst_name=states$codes[ii],
         pst_x=as.numeric(redfin_i$period_begin+15),
         pst_y=redfin_i$inventory_index,
         pst=pst_box,
         color=states$cc[ii],
         xx_1=last(as.numeric(redfin_i$period_begin+15)),
         yy_1=last(redfin_i$inventory_index),
         label=paste0("$\\leftarrow$",states$codes[ii]),
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".25pt",
         LineDash = "2pt 1pt",
         dir=0,
         side="left")
}


fPSTText(pst_root=FigureRoot,
         pst_name="Label_Inventory",
         pst=pst_box,
         xx_1=as.numeric(as.Date("2020/3/1")),
         yy_1=65,
         label="Inventory",
         dir=-135,
         sep=0.1,
         side="left")


fCompile(pst_root=FigureRoot,SubFiles=list("MA","VT","ME","US"#,"NH","RI","CT"
                                           ,"Label_Inventory"
                                           ,"PSTAxes"),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "../Output/")

plot.new()

```




## PW_HousingUpdate_133_Redfin_SaleHazard

![](../Output/PW_HousingUpdate_133_Redfin_SaleHazard-1.png)
``` {r }

FigureRoot="../Output/PW_HousingUpdate_133_Redfin_SaleHazard"


ylims=c(0,100)

pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2016/12/1"),Sys.Date()+90),
                     pst_ylims         =ylims,
                     pst_xticks       =seq(as.Date(c("2017/07/01")),Sys.Date()+90,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2017/01/01")),Sys.Date()+90,by="1 year"),                                   pst_yticks        =seq(0,100,by=10),
                     factor            =0.75,
                     # pst_xticks_main   =0,
                     pst_yticks_main   =99,
                     # pst_ylimsRight = c(-2,20),
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(-2,10,by=2),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),#sqrt(2),
                     DateFormat    ="%y",
                     ylabel   ="Probability of Sale in \\%",
                     ylabel_sep= 50,
                     # ylabel_sepRight= 100,
                     # ylabelRight ="in \\%",
                     # YNumberSideRight="right",
                     TickLineColor = "lightgray",
                     XLabel = "")

codes <- c("MA","CT","RI","ME","VT","NH")
cc <- c("blue","red","green","yellow","magenta","cyan")

states=data.frame(codes,cc)

for (ii in seq(1,6,by=1)){
redfin_i <- redfin %>% filter(state_code==states$codes[ii]) %>%
     subset(select=c(period_begin,sale_hazard)) %>%
     drop_na

fPSTLine(pst_root=FigureRoot,
         pst_name=states$codes[ii],
         pst_x=as.numeric(redfin_i$period_begin+15),
         pst_y=100*redfin_i$sale_hazard,
         pst=pst_box,
         color=states$cc[ii],
         xx_1=last(as.numeric(redfin_i$period_begin+15)),
         yy_1=last(100*redfin_i$sale_hazard),
         label=paste0("$\\leftarrow$",states$codes[ii]),
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".25pt",
         LineDash = "2pt 1pt",
         dir=0,
         side="left")
}




fCompile(pst_root=FigureRoot,SubFiles=list("MA","VT","RI","CT"#"ME","NH",
                                           ,"PSTAxes"),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "../Output/")

plot.new()

```

## PW_HousingUpdate_134_Redfin_SaleLevel

![](../Output/PW_HousingUpdate_134_Redfin_SaleLevel-1.png)
``` {r }

FigureRoot="../Output/PW_HousingUpdate_134_Redfin_SaleLevel"


ylims=c(55,170)

factor=0.75
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(as.Date("2016/12/1"),Sys.Date()+90),
                     pst_ylims         =ylims,
                     pst_xticks       =seq(as.Date(c("2017/07/01")),Sys.Date()+90,by="1 year"),
                     pst_xlines        =seq(as.Date(c("2017/01/01")),Sys.Date()+90,by="1 year"),
                     pst_yticks        =seq(60,170,by=20),
                     factor            =factor,
                     pst_xticks_main   =100,
                     pst_yticks_main   =100,
                     # pst_ylimsRight = c(-2,20),
                     # pst_yticks_mainRight = 0,
                     # pst_yticksRight   =seq(-2,10,by=2),
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),#sqrt(2),
                     DateFormat    ="%Y",
                     ylabel   ="\\parbox{7cm}{\\centering 2017-2019=100, Seasonally Adjusted}",
                     ylabel_sep= 50,
                     # ylabel_sepRight= 100,
                     # ylabelRight ="in \\%",
                     # YNumberSideRight="right",
                     TickLineColor = "lightgray",
                     XLabel = "")

codes <- c("MA","CT","RI","ME","VT","NH","US")
cc <- c("blue","red","green","yellow","magenta","cyan","black")
xx_offset <- rep(0,7)
yy_offset <- rep(0,7)

states=data.frame(codes,cc,xx_offset,yy_offset)

states$yy_offset[states$codes=="VT"]<-1

for (ii in seq(1,NROW(states),by=1)){
redfin_i <- redfin2 %>% filter(state_code==states$codes[ii])




fPSTLine(pst_root=FigureRoot,
         pst_name=states$codes[ii],
         pst_x=as.numeric(redfin_i$period_begin+15),
         pst_y=redfin_i$sales_index,
         pst=pst_box,
         color=states$cc[ii],
         xx_1=last(as.numeric(redfin_i$period_begin+15))+states$xx_offset[ii],
         yy_1=last(redfin_i$sales_index)+states$yy_offset[ii],
         label=paste0("$\\leftarrow$",states$codes[ii]),
         LineStyle = "solid",
         sep=0.1,
         LineWidth=".25pt",
         LineDash = "2pt 1pt",
         dir=0,
         side="left")
}

fPSTText(pst_root=FigureRoot,
         pst_name="Label_Sales",
         pst=pst_box,
         xx_1=as.numeric(as.Date("2020/7/1")),
         yy_1=140,
         label="Sales",
         dir=135,
         sep=0.1,
         side="left")


fCompile(pst_root=FigureRoot,SubFiles=list("MA","VT","US"#"NH",,"RI","CT"
                                           ,"Label_Sales"
                                           ,"PSTAxes"),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "../Output/")

plot.new()

```



## fHousingUpdate

![](../Documents/RUCCCodes.png)

```{r}

# redfin_county_download <- read_csv("/shared/HDM_Policy_Charts/data/processed/housing/merged_urban_rural_redfin.csv")



codes<- redfin_county_download %>% select(FIPS,state_code,RUCC_2023,Population_2020) %>% filter(is.na(Population_2020)==FALSE) %>%
     unique(.) %>%
     mutate(FIPS=str_pad(FIPS,width=5,pad="0"))



redfin_county <- redfin_county_download %>%
     mutate(FIPS=str_pad(FIPS,width=5,pad="0")) %>%
     filter(property_type_id==-1) %>%
     subset(select=names(.)[-grep("mom",names(.))]) %>%
     subset(select=names(.)[-grep("yoy",names(.))])  %>%
     select(-c(state_code,RUCC_2023,Population_2020)) %>%
     mutate(sale_hazard=homes_sold/inventory) %>%
     arrange(state,period_begin) %>%
     # filter(!(period_begin<as.Date("2017/1/1")))%>%
     filter(is_seasonally_adjusted==FALSE) %>%
     mutate(date=period_begin) %>%
     left_join(HPI_County,.) %>%
     left_join(.,codes) %>%
     mutate(nonmetro=RUCC_2023>3) %>%
     mutate(rural=RUCC_2023 %in% c(4,5,6,7,8,9)) %>%
     mutate(new_england=state_code %in% c("MA","CT","RI","VT","ME","NH")) %>%
     mutate(providence=FIPS=="44007")%>%
     mutate(year=year(date),month=month(date),quarter=quarter(date)) %>%
     {.}


xx <-redfin_county_download %>% filter(state_code=="CT")

for (ss in c("MA","CT","RI","VT","ME","NH") ){
     redfin_county <- redfin_county %>%
          mutate(!!sym(ss) := state_code == ss)
     
}


     
     
fHousingUpdate = function(figs,treat,sample,nn,start_year){

     if (missing(start_year)){start_year=2016}
          
DataSet<- redfin_county %>%
     filter(date>=as.Date(paste0(start_year,"/1/1"))) %>%
     {if (sample!="all") {filter(.,!!sym(sample)==TRUE)} else .} %>%
     mutate(year=relevel(factor(year),ref="2019")) %>%
     mutate(treatment=!!sym(treat[1])) %>%
     {.}


for (ii in seq(1,NROW(figs))) {
     
     
     
     num=figs$depvars[ii]
     name<-paste0("spec",num)
     if (ii==1)  {specs<-name}      else {specs<-c(specs,name)}
     y<-paste0("log(",figs$depvars[ii],")")
     x<-c("treatment*factor(year)|factor(FIPS)^quarter")
     StartDate<-as.Date("2018/1/1")
     EndDate<-Sys.Date()
     reg_formula<-formula(paste(y, paste(x, collapse=" + "), sep=" ~ " ))
     Output  <- feols(reg_formula,DataSet[!is.na(DataSet$home_price_index),],weights = ~Population_2020)
     assign(name,list(y=y,x=x,Output=Output,StartDate=StartDate,EndDate=EndDate))
     
     cat(name)
     
     FigureRoot=paste0("../Output/PW_HousingUpdate_",nn,"_Redfin_",treat[1],"_",sample,"_",start_year,"_",figs$depvars[ii])
     
     
     RUest <- get(sym(name))$Output$coeftable %>% 
          mutate(year=parse_number(rownames(.))) %>%
          select(year,Estimate) %>% 
          mutate(groupR=ifelse(grepl("treatment",rownames(.))==TRUE,"treatment","control")) %>%
          pivot_wider(names_from=groupR,values_from=Estimate) %>%
          bind_rows(data.frame(year=2019,control=0,treatment=0)) %>%
          {if (figs$level_or_log[ii]=="logs") {mutate(.,control_index=log(100*exp(control)))}
               else {mutate(.,control_index=100*exp(control))}} %>%
          {if (figs$level_or_log[ii]=="logs") {mutate(.,treatment_index=log(100*exp(control+treatment)))}
               else {mutate(.,treatment_index=100*exp(control+treatment))}} %>%
          mutate(date=as.Date(paste0(year,"/7/1"))) %>%
          arrange(year) %>%
          {.}
     
     if (figs$level_or_log[ii]=="logs"){
          ylims=log(unlist(figs$ylims[ii]))
          yticks=log(unlist(figs$yticks[ii]))
          yticklabels=unlist(figs$yticks[ii])
          yy_1=log(unlist(figs$labels_loc[ii])[2])
          # RUest <- RUest %>%
          #      mutate(control_index=log(control_index)) %>%
          #      mutate(treatment_index=log(treatment_index))
          }
     else {ylims=unlist(figs$ylims[ii])
          yticks=unlist(figs$yticks[ii])
          yticklabels=unlist(figs$yticks[ii])
          yy_1=unlist(figs$labels_loc[ii])[2]}
     
     factor=0.85
     pst_box  <- fPSTAxes(pst_root=FigureRoot,
                          pst_xlims         =c(as.Date(paste0(start_year-1,"/12/1")),Sys.Date()+90),
                          pst_ylims         =ylims,
                          pst_xticks       =seq(as.Date(paste0(start_year,"/07/01")),Sys.Date()+90,by="1 year"),
                          pst_xlines        =seq(as.Date(paste0(start_year,"/01/01")),Sys.Date()+90,by="1 year"),                                   
                          pst_yticks        =yticks,
                          pst_ytickLabels = yticklabels,
                          factor            =factor,
                          # pst_xticks_main   =0,
                          pst_yticks_main   =100,
                          # pst_ylimsRight = c(-2,20),
                          # pst_yticks_mainRight = 0,
                          # pst_yticksRight   =seq(-2,10,by=2),
                          pst_xticks_decimal=2,
                          pst_yticks_decimal=0,
                          # pst_yticks_decimalRight = 0,
                          aspect            =sqrt(1.25),#sqrt(2),
                          DateFormat    ="%y",
                          ylabel   ="\\parbox{7cm}{\\centering\\scriptsize 2019=100, Seasonally Adjusted}",
                          ylabel_sep= 50,
                          # ylabel_sepRight= 100,
                          # ylabelRight ="in \\%",
                          # YNumberSideRight="right",
                          TickLineColor = "lightgray",
                          XLabel = "")
     
     
     
     
     
     fPSTLine(pst_root=FigureRoot,
              pst_name="Control",
              pst_x=as.numeric(RUest$date+15),
              pst_y=RUest$control_index,
              pst=pst_box,
              color="blue",
              xx_1=last(as.numeric(RUest$date+15)),
              yy_1=last(RUest$control_index),
              label=paste0("$\\leftarrow$",treat[3]),
              LineStyle = "solid",
              sep=0.1,
              LineWidth=".25pt",
              LineDash = "2pt 1pt",
              dir=0,
              side="left")
     
     fPSTLine(pst_root=FigureRoot,
              pst_name="Treatment",
              pst_x=as.numeric(RUest$date+15),
              pst_y=RUest$treatment_index,
              pst=pst_box,
              color="red",
              xx_1=last(as.numeric(RUest$date+15)),
              yy_1=last(RUest$treatment_index),
              label=paste0("$\\leftarrow$",treat[2]),
              LineStyle = "solid",
              sep=0.1,
              LineWidth=".25pt",
              LineDash = "2pt 1pt",
              dir=0,
              side="left")
     
     
     fPSTText(pst_root=FigureRoot,
              pst_name="Label",
              pst=pst_box,
              xx_1=unlist(figs$labels_loc[ii])[1],
              yy_1=yy_1,
              label=figs$labels[ii],
              dir=-135,
              sep=0.1,
              side="left")
     
     
     fCompile(pst_root=FigureRoot,SubFiles=list("Control","Treatment"
                                                ,"Label"
                                                ,"PSTAxes"),
              PictureSize=factor/.75*c(9,7),
              WorkingDirectory = "../Output/")}
     
 
FigureRoot=paste0("../Output/PW_HousingUpdate_",nn,"_Redfin_",treat[1],"_",sample,"_Regressions")
    
 eval(parse(text=
                paste("dictx=c(",paste0(
                     paste(
                          paste0(
                               paste0("\"factor(year)",seq(2017,2024),"\"="),
                                              paste0("\"",seq(2017,2024),"\"")),
                     collapse=","),")",
           collapse="")
     )))

dictx=c(dictx,"treatmentTRUE"=treat[2],
        "log(inventory)"="Inventory",
        "log(new_listings)"="New Listings",
        "log(homes_sold)"="Sales",
        "log(median_ppsf)"="Median Price",
        "log(home_price_index)"="Repeat Sales Index",
        "factor(FIPS)"="County$\\times$Calendar"
        )

getwd()
eval(
     parse(
          text=paste0(
               "etable(list(",
               paste0(specs,"$Output",collapse=","),")",
               ",tex = TRUE",
               paste0(",file =\"",FigureRoot,"_tabular.tex\""),
               ",replace = TRUE",
               ",dict=dictx",
               ",vcov=~FIPS",
               ")"
               )
          )
     )

fCompileTable(pst_root=FigureRoot,Width="!",Height="4.5cm",
         WorkingDirectory = "../Output")
     
}
plot.new() 

```

## PW_HousingUpdate_140_Redfin_rural_new_england
```{r}

depvars <- c("inventory","new_listings","homes_sold","median_ppsf","home_price_index")
labels <- c("Inventory","Listings","Sales","Median PPSF","CoreLogic HPI")
labels_loc <- list(c(as.Date("2019/1/1"),95),c(as.Date("2019/1/1"),95),c(as.Date("2019/1/1"),95),c(as.Date("2019/1/1"),95),c(as.Date("2019/1/1"),95))
ylims <- list(c(17,122),c(62,105),c(65,132),c(85,190),c(85,190))
yticks <- list(seq(20,120,by=20),seq(70,100,by=10),seq(80,120,by=20),seq(100,180,by=20),seq(100,180,by=20))
level_or_log <- c("levels","levels","levels","levels","logs")
figs <- data.frame(depvars,level_or_log,labels,I(labels_loc),I(ylims),I(yticks))
treat <- c("rural","Rural","Urban")
sample <- "new_england"
nn <- 140

fHousingUpdate(figs,treat,sample,nn)

plot.new()
```

## PW_HousingUpdate_141_Redfin_new_england_all


```{r}

depvars <- c("inventory","new_listings","homes_sold","median_ppsf","home_price_index")
labels <- c("Inventory","Listings","Sales","Median PPSF","CoreLogic HPI")
labels_loc <- list(c(as.Date("2019/1/1"),95),c(as.Date("2019/1/1"),95),c(as.Date("2019/1/1"),95),c(as.Date("2019/1/1"),95),c(as.Date("2019/1/1"),95))
ylims <- list(c(17,122),c(62,105),c(65,132),c(85,190),c(85,190))
yticks <- list(seq(20,120,by=20),seq(70,100,by=10),seq(80,120,by=20),seq(100,180,by=20),seq(100,180,by=20))
level_or_log <- c("levels","levels","levels","levels","logs")
figs <- data.frame(depvars,level_or_log,labels,I(labels_loc),I(ylims),I(yticks))
treat <- c("new_england","NE","ROC")
sample <- "all"
nn <- 141

fHousingUpdate(figs,treat,sample,nn,start_year=2016)

plot.new()
```

## PW_HousingUpdate_142_Redfin_new_england_all_2012_inventory


```{r, echo=FALSE, message=FALSE, results='hide'}

nn <- 142
depvars <- c("inventory")
labels <- c("Inventory")
labels_loc <- list(c(as.Date("2019/1/1"),95))
ylims <- list(c(37,185))
yticks <- list(seq(40,180,by=20))
level_or_log <- c("levels")
figs <- data.frame(depvars,level_or_log,labels,I(labels_loc),I(ylims),I(yticks))
treat <- c("new_england","NE","ROC")
sample <- "all"


fHousingUpdate(figs,treat,sample,nn,start_year=2012)

plot.new()
```
## PW_HousingUpdate_145_Redfin_rural_new_england_2012_inventory

![](../Output/PW_HousingUpdate_145_Redfin_rural_new_england_2012_inventory-1.png)

```{r}
nn <- 145
depvars <- c("inventory")
labels <- c("Inventory")
labels_loc <- list(c(as.Date("2019/1/1"),95))
ylims <- list(c(17,185))
yticks <- list(seq(20,180,by=20))
level_or_log <- c("levels")
figs <- data.frame(depvars,level_or_log,labels,I(labels_loc),I(ylims),I(yticks))
treat <- c("rural","Rural","Urban")
sample <- "new_england"


fHousingUpdate(figs,treat,sample,nn,start_year=2012)

plot.new()
```

## PW_HousingUpdate_143_Redfin_new_england_all_2000_home_price_index

![](../Output/PW_HousingUpdate_143_Redfin_new_england_all_2000_home_price_index-1.png)

```{r}
nn <- 143
depvars <- c("home_price_index")
labels <- c("CoreLogic HPI")
labels_loc <- list(c(as.Date("2019/1/1"),95))
ylims <- list(c(44,156))
yticks <- list(seq(60,140,by=20))
level_or_log <- c("logs")
figs <- data.frame(depvars,level_or_log,labels,I(labels_loc),I(ylims),I(yticks))
treat <- c("new_england","NE","ROC")
sample <- "all"


fHousingUpdate(figs,treat,sample,nn,start_year=2000)

plot.new()
```
## PW_HousingUpdate_144_Redfin_rural_new_england_2000_home_price_index
```{r}

depvars <- c("home_price_index")
labels <- c("CoreLogic HPI")
labels_loc <- list(c(as.Date("2019/1/1"),95))
ylims <- list(c(44,186))
yticks <- list(seq(60,180,by=20))
level_or_log <- c("logs")
figs <- data.frame(depvars,level_or_log,labels,I(labels_loc),I(ylims),I(yticks))
treat <- c("rural","Rural","Urban")
sample <- "new_england"
nn <- 144

fHousingUpdate(figs,treat,sample,nn,start_year = 2000)

plot.new()
```

## PW_HousingUpdate_146_Redfin_rural_SS_2012_inventory

![](../Output/PW_HousingUpdate_146_Redfin_rural_MA_2012_inventory-1.png)

```{r}
for (ss in c("MA","CT","VT","ME","NH") ){
nn <- 146
depvars <- c("inventory")
labels <- c("Inventory")
labels_loc <- list(c(as.Date("2019/1/1"),95))
ylims <- list(c(17,185))
yticks <- list(seq(20,180,by=20))
level_or_log <- c("levels")
figs <- data.frame(depvars,level_or_log,labels,I(labels_loc),I(ylims),I(yticks))
treat <- c("rural","Rural","Urban")
sample <- ss


fHousingUpdate(figs,treat,sample,nn,start_year=2012)

plot.new()
}
```

## PW_HousingUpdate_149_Redfin_providence_RI_2000_home_price_index
```{r}

depvars <- c("home_price_index")
labels <- c("CoreLogic HPI")
labels_loc <- list(c(as.Date("2019/1/1"),95))
ylims <- list(c(44,186))
yticks <- list(seq(60,180,by=20))
level_or_log <- c("logs")
figs <- data.frame(depvars,level_or_log,labels,I(labels_loc),I(ylims),I(yticks))
treat <- c("rural","Rural","Urban")
sample <- "new_england"
nn <- 144

fHousingUpdate(figs,treat,sample,nn,start_year = 2000)

plot.new()
```


## PW_HousingUpdate_147_Redfin_rural_SS_2000_home_price_index
```{r}

for (ss in c("MA","CT","VT","ME","NH") ){
nn <- 147
depvars <- c("home_price_index")
labels <- c("CoreLogic HPI")
labels_loc <- list(c(as.Date("2019/1/1"),95))
ylims <- list(c(44,186))
yticks <- list(seq(60,180,by=20))
level_or_log <- c("logs")
figs <- data.frame(depvars,level_or_log,labels,I(labels_loc),I(ylims),I(yticks))
treat <- c("rural","Rural","Urban")
sample <- ss


fHousingUpdate(figs,treat,sample,nn,start_year = 2000)

plot.new()}
```

## PW_HousingUpdate_148_Redfin_rural_RI_2012_inventory

![](../Output/PW_HousingUpdate_145_Redfin_rural_new_england_2012_inventory-1.png)

```{r}
nn <- 148
depvars <- c("inventory")
labels <- c("Inventory")
labels_loc <- list(c(as.Date("2019/1/1"),95))
ylims <- list(c(17,185))
yticks <- list(seq(20,180,by=20))
level_or_log <- c("levels")
figs <- data.frame(depvars,level_or_log,labels,I(labels_loc),I(ylims),I(yticks))
treat <- c("providence","Providence","Rest-of-State")
sample <- "RI"


fHousingUpdate(figs,treat,sample,nn,start_year=2012)

plot.new()
```

## PW_HousingUpdate_149_Redfin_providence_RI_2000_home_price_index

![](../Output/PW_HousingUpdate_149_Redfin_providence_RI_2000_home_price_index-1.png)

```{r}
nn <- 149
depvars <- c("home_price_index")
labels <- c("CoreLogic HPI")
labels_loc <- list(c(as.Date("2019/1/1"),95))
ylims <- list(c(44,156))
yticks <- list(seq(60,140,by=20))
level_or_log <- c("logs")
figs <- data.frame(depvars,level_or_log,labels,I(labels_loc),I(ylims),I(yticks))
treat <- c("providence","Providence","Rest-of-State")
sample <- "RI"


fHousingUpdate(figs,treat,sample,nn,start_year=2000)

plot.new()
```

## PW_HousingUpdate_139_Redfin_Selected

```{r}


FigureRoot="../Output/PW_HousingUpdate_139_Redfin_Selected"

FileName=paste0(FigureRoot,"_tabular.tex")



redfin_table <- redfin_county %>%
     filter(is.na(Population_2020)==FALSE) %>%
     group_by(FIPS) %>%
     mutate(home_price_index_2019=mean(home_price_index[year==2019&quarter==2],na.rm=TRUE)) %>%
     mutate(inventory_2019=mean(inventory[year==2019&quarter==2],na.rm=TRUE)) %>%
     ungroup() %>%
     group_by(year,quarter) %>%
     summarize(nobs=n(),
               median_dom=weighted.mean(median_dom,Population_2020,na.rm = TRUE),
               sale_hazard=weighted.mean(sale_hazard,Population_2020,na.rm = TRUE),
               months_of_supply=weighted.mean(months_of_supply,Population_2020,na.rm = TRUE),
               homes_sold=weighted.mean(homes_sold,Population_2020,na.rm = TRUE),
               avg_sale_to_list=weighted.mean(avg_sale_to_list,Population_2020,na.rm = TRUE),
               hpi=weighted.mean(home_price_index/home_price_index_2019,Population_2020,na.rm=TRUE),
               inv_index=weighted.mean(inventory/inventory_2019,Population_2020,na.rm=TRUE)) %>%
     filter(year %in% c(2019,2024) & quarter ==2)


s_line <- redfin_table %>% filter(year==2019)
s_line1 <- paste("\\multirow{2}{*}{US Total} &&",
                    paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\")

s_line <- redfin_table %>% filter(year==2024)
s_line2 <- paste("\\textit{} &&",
                    paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\\\midrule")


redfin_table <- redfin_county %>%
     filter(is.na(Population_2020)==FALSE) %>%
     group_by(FIPS) %>%
     mutate(home_price_index_2019=mean(home_price_index[year==2019&quarter==2],na.rm=TRUE)) %>%
     mutate(inventory_2019=mean(inventory[year==2019&quarter==2],na.rm=TRUE)) %>%
     ungroup() %>%
     group_by(new_england,year,quarter) %>%
     summarize(nobs=n(),
               median_dom=weighted.mean(median_dom,Population_2020,na.rm = TRUE),
               sale_hazard=weighted.mean(sale_hazard,Population_2020,na.rm = TRUE),
               months_of_supply=weighted.mean(months_of_supply,Population_2020,na.rm = TRUE),
               homes_sold=weighted.mean(homes_sold,Population_2020,na.rm = TRUE),
               avg_sale_to_list=weighted.mean(avg_sale_to_list,Population_2020,na.rm = TRUE),
               hpi=weighted.mean(home_price_index/home_price_index_2019,Population_2020,na.rm=TRUE),
               inv_index=weighted.mean(inventory/inventory_2019,Population_2020,na.rm=TRUE)) %>%
     filter(year %in% c(2019,2024) & quarter ==2)

s_line <- redfin_table %>% filter(year==2019,new_england==TRUE)
s_line3all <- paste("\\multirow{7}{*}{New England} & \\multirow{2}{*}{All} & ",paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\")

s_line <- redfin_table %>% filter(year==2024,new_england==TRUE)
s_line4all <- paste("\\textit{} &  & ",
                    paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\\\cmidrule{2-8}")


redfin_table <- redfin_county %>%
     filter(is.na(Population_2020)==FALSE) %>%
     group_by(FIPS) %>%
     mutate(home_price_index_2019=mean(home_price_index[year==2019&quarter==2],na.rm=TRUE)) %>%
     mutate(inventory_2019=mean(inventory[year==2019&quarter==2],na.rm=TRUE)) %>%
     ungroup() %>%
     group_by(rural,new_england,year,quarter) %>%
     summarize(nobs=n(),
               median_dom=weighted.mean(median_dom,Population_2020,na.rm = TRUE),
               sale_hazard=weighted.mean(sale_hazard,Population_2020,na.rm = TRUE),
               months_of_supply=weighted.mean(months_of_supply,Population_2020,na.rm = TRUE),
               homes_sold=weighted.mean(homes_sold,Population_2020,na.rm = TRUE),
               avg_sale_to_list=weighted.mean(avg_sale_to_list,Population_2020,na.rm = TRUE),
               hpi=weighted.mean(home_price_index/home_price_index_2019,Population_2020,na.rm=TRUE),
               inv_index=weighted.mean(inventory/inventory_2019,Population_2020,na.rm=TRUE)) %>%
     filter(year %in% c(2019,2024) & quarter ==2)

s_line <- redfin_table %>% filter(year==2019,new_england==TRUE,rural==FALSE)
s_line3 <- paste("\\multirow{4}{*}{} & \\multirow{2}{*}{Urban} & ",paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\")

s_line <- redfin_table %>% filter(year==2024,new_england==TRUE,rural==FALSE)
s_line4 <- paste("\\textit{} &  & ",
                    paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\\\cmidrule{2-8}")

s_line <- redfin_table %>% filter(year==2019,new_england==TRUE,rural==TRUE)
s_line5 <- paste("\\textit{} & \\multirow{2}{*}{Rural} &",
                    paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\")

s_line <- redfin_table %>% filter(year==2024,new_england==TRUE,rural==TRUE)
s_line6 <- paste("\\textit{} &   &",
                    paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\")

cat(paste(s_line1,s_line2,s_line3,s_line4,s_line5,s_line6,sep="\n"))

s_line <- redfin_table %>% filter(year==2019,new_england==FALSE,rural==FALSE)
s_line7 <- paste("\\multirow{4}{*}{Rest-of-US} & \\multirow{2}{*}{Urban}  &",
                    paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\")

s_line <- redfin_table %>% filter(year==2024,new_england==FALSE,rural==FALSE)
s_line8 <- paste("\\textit{} &   &",
                    paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\\\cmidrule{2-8}")

s_line <- redfin_table %>% filter(year==2019,new_england==FALSE,rural==TRUE)
s_line9 <- paste("\\textit{} & \\multirow{2}{*}{Rural}  &",
                    paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\")

s_line <- redfin_table %>% filter(year==2024,new_england==FALSE,rural==TRUE)
s_line10 <- paste("\\textit{} &   &",
                    paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\")

redfin_table <- redfin_county %>%
     filter(is.na(Population_2020)==FALSE) %>%
     group_by(FIPS) %>%
     mutate(home_price_index_2019=mean(home_price_index[year==2019&quarter==2],na.rm=TRUE)) %>%
     mutate(inventory_2019=mean(inventory[year==2019&quarter==2],na.rm=TRUE)) %>%
     ungroup() %>%
     group_by(rural,new_england,year,quarter) %>%
     summarize(nobs=n(),
               median_dom=weighted.mean(median_dom,Population_2020,na.rm = TRUE),
               sale_hazard=weighted.mean(sale_hazard,Population_2020,na.rm = TRUE),
               months_of_supply=weighted.mean(months_of_supply,Population_2020,na.rm = TRUE),
               homes_sold=weighted.mean(homes_sold,Population_2020,na.rm = TRUE),
               avg_sale_to_list=weighted.mean(avg_sale_to_list,Population_2020,na.rm = TRUE),
               hpi=weighted.mean(home_price_index/home_price_index_2019,Population_2020,na.rm=TRUE),
               inv_index=weighted.mean(inventory/inventory_2019,Population_2020,na.rm=TRUE)) %>%
     filter(year %in% c(2019,2024) & quarter ==2)

s_line <- redfin_table %>% filter(year==2019,new_england==TRUE,rural==FALSE)
s_line3 <- paste("\\multirow{4}{*}{} & \\multirow{2}{*}{Urban} & ",paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\")

s_line <- redfin_table %>% filter(year==2024,new_england==TRUE,rural==FALSE)
s_line4 <- paste("\\textit{} &  & ",
                    paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\\\cmidrule{2-8}")

s_line <- redfin_table %>% filter(year==2019,new_england==TRUE,rural==TRUE)
s_line5 <- paste("\\textit{} & \\multirow{2}{*}{Rural} &",
                    paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\")

s_line <- redfin_table %>% filter(year==2024,new_england==TRUE,rural==TRUE)
s_line6 <- paste("\\textit{} &   &",
                    paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\\\midrule")

head<-paste0("\\centering\\begin{tabular}{llccccccccccccccc}\\toprule")
topline1<-paste0("\\multirow{3}{*}{Geography}&\\multirow{3}{*}{Type}&\\multirow{3}{*}{Year} 
                    &\\multirow{3}{2cm}{\\centering Days-on-Market}
                    &\\multirow{3}{2cm}{\\centering Monthly Prob. of Sale in \\%}
                    &\\multirow{3}{2cm}{\\centering Sale Price/\\\\ List Price \\\\ in \\%}
                    &\\multirow{3}{2cm}{\\centering House Price Index}
                    &\\multirow{3}{2cm}{\\centering Inventory Index}
                 \\\\ \\\\ \\\\ \\midrule")
     


tabulation <- paste(head,topline1,s_line1,s_line2,
                    s_line3all,s_line4all,
                    s_line3,s_line4,
                    s_line5,s_line6,                    
                    " ",sep="\n")
cat(tabulation)
cat(tabulation,file = FileName)


for (ss in c("MA","CT","RI","VT","ME","NH")){

redfin_table <- redfin_county %>%
     filter(is.na(Population_2020)==FALSE) %>%
     filter(state_code==ss) %>%
     group_by(FIPS) %>%
     mutate(home_price_index_2019=mean(home_price_index[year==2019&quarter==2],na.rm=TRUE)) %>%
     mutate(inventory_2019=mean(inventory[year==2019&quarter==2],na.rm=TRUE)) %>%
     ungroup() %>%
     group_by(year,quarter) %>%
     summarize(nobs=n(),
               median_dom=weighted.mean(median_dom,Population_2020,na.rm = TRUE),
               sale_hazard=weighted.mean(sale_hazard,Population_2020,na.rm = TRUE),
               months_of_supply=weighted.mean(months_of_supply,Population_2020,na.rm = TRUE),
               homes_sold=weighted.mean(homes_sold,Population_2020,na.rm = TRUE),
               avg_sale_to_list=weighted.mean(avg_sale_to_list,Population_2020,na.rm = TRUE),
               hpi=weighted.mean(home_price_index/home_price_index_2019,Population_2020,na.rm=TRUE),
               inv_index=weighted.mean(inventory/inventory_2019,Population_2020,na.rm=TRUE)) %>%
     filter(year %in% c(2019,2024) & quarter ==2)

if (ss == "MA")
{s_line <- redfin_table %>% filter(year==2019)
s_line_ss_1 <- paste("\\multirow{13}{*}{By State}&\\multirow{2}{*}{",ss,"} &",
                    paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\")
}
else {
s_line <- redfin_table %>% filter(year==2019)
s_line_ss_1 <- paste("&\\multirow{2}{*}{",ss,"} &",
                    paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\")
}

if (ss == "NH"){
s_line <- redfin_table %>% filter(year==2024)
s_line_ss_2 <- paste("\\textit{} &&",
                    paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\")}
else {
s_line <- redfin_table %>% filter(year==2024)
s_line_ss_2 <- paste("\\textit{} &&",
                    paste(c(s_line$year,
                         round(s_line$median_dom,0),
                         round(s_line$sale_hazard,2)*100,
                         round(s_line$avg_sale_to_list,2)*100,
                         round(s_line$hpi*100,0),
                         round(s_line$inv_index*100,0)), collapse="  & "),"\\\\\\cmidrule{2-8}")     
}


cat(paste(s_line_ss_1,s_line_ss_2," ",sep="\n"),file = FileName,append = TRUE)


}


foot=paste0("\\bottomrule\\end{tabular}")


cat(foot,file = FileName, append = TRUE)
fCompileTable(pst_root=FigureRoot,Width="!",Height="3cm",
         WorkingDirectory = "../Output")
     

plot.new()


```


# Simple model of the evolution of aggregate rent

things to do to make this better:

(1)  do for metro areas DONE
(2)  use the zillow indices DONE
(3)  add in seasonality
/home/a1psw01/Desktop/Notebooks/Documents/2009-Seasonality.pdf
(4)  turn into function and minimize squared errors DONE
(5)  add national data to overall sample DONE

## Code to load the data
This code inputs the data and creates cl_sfri which includes the sfri data and the 

Data was last updated on RADAR on 9/22/22.  Today is 10/25.  Why no new data?

```{r loaddata1}


csv_file <- "/shared/crt/OptimalBlue/RateCalcs/Data/research_haver_monthly.csv"
rhm <- read.csv(file = csv_file, header = TRUE, sep = ",",
                dec = ".",strip.white = TRUE)
rhm$Date <- as.Date(rhm$date-1,origin="0000-01-01")
rhm$Date <- as.Date(paste0(lubridate::year(rhm$Date),"/",lubridate::month(rhm$Date),"/1"))

pr_series<- rhm %>% select(Date,USZOI,PCUHSRRN)

HaverCBSACode <- c("UHSRHTN", # 26429
  "UHSRDAA", # 19804
  "UHSRDNV", #  Denver?
  "UHSRDFW", # 19124
  "UHSRCHG", # 16974
  "UHSRBON", # 14454
  "UHSRBTM", # 12580
  "UHSRATL", # 12060
  "UHSRSFC", # 41884
  "UHSRSDI", # 41740
  "UHSRRSB", # 40140
  "UHSRPHO", # 38060
  "UHSRPHI", # 37964
  "UHSRNYT", # 35614
  "UHSRMIM", # 33124
  "UHSRLNA", # 31084
  "UHSRWSH", # 47894
  "UHSRTMA", # 45300
  "UHSRSTL", # 41180
  "UHSRSTW") # 42644

cbsacodeSFRI <- c( 26429
  ,19804
  ,NA
  ,19124
  ,16974
  ,14454
  ,12580
  ,12060
  ,41884
  ,41740
  ,40140
  ,38060
  ,37964
  ,35614
  ,33124
  ,31084
  ,47894
  ,45300
  ,41180
  ,42644
  )

msa<-data_frame(HaverCBSACode,cbsacodeSFRI)

regional_cpi_rent <- rhm %>% select(c(Date,PCUHSRRN,msa$HaverCBSACode)) %>%
     melt(id="Date") %>% 
     rename(HaverCBSACode=variable,CPI=value) %>%
     filter(Date>=as.Date("2004/1/1")) %>%
     group_by(HaverCBSACode) %>%
     filter(Date>=min(Date[is.na(CPI)==0])) %>%
     filter(Date<=max(Date[is.na(CPI)==0])) %>%
     mutate(CPI = na.approx(CPI, na.rm=FALSE))  %>%
     left_join(.,msa) %>%
     mutate(cbsacodeSFRI=ifelse(HaverCBSACode=="PCUHSRRN",99999,cbsacodeSFRI)) %>%
     drop_na


csv_file="/home/a1psw01/Desktop/Notebooks/Data/sfri_dw_sfri_combined_v4_202312.csv"
cl_sfri<-read.csv(file = csv_file, header = TRUE, sep = ",",
                dec = ".",strip.white = TRUE) %>% rename(cbsacodeSFRI=geo_code) %>% 
     filter(tier_code==7)  %>%
     mutate(cbsacodeSFRI=ifelse(is.na(cbsacodeSFRI)==1,99999,cbsacodeSFRI)) %>%
     mutate(Date=as.Date(paste0(substr(as_of_mon_id,1,4),"/",substr(as_of_mon_id,5,6),"/1")))  %>%
     mutate(year=lubridate::year(Date),
            month=lubridate::month(Date)) %>%
     left_join(.,pr_series) %>%
     left_join(.,regional_cpi_rent) %>%
     drop_na(CPI) %>%
     arrange(Date,cbsacodeSFRI)

cbsa_codes <- cl_sfri %>% select(cbsacodeSFRI,geo_name)  %>% unique
```




## Function that simulates cpi rent using lags of SFRI

```{r simulation}
     
# function takes corelogic sfri data and
#    (1) computes weights -- how many people who first leased in "2021/1/1" are still around in "2022/7/1"
#    (2) computes updatd rents -- how much will you pay if you renew
#    (3) computes the average rent paid by month
#    (4) sum(weights) just shows us how close we are to the steady state.  
fPredCPI <- function(alpha,gamma,data){

     data=data_1
     cl_lease <- data %>% 
          subset(select=c(single_family_rent_index,Date,cbsacodeSFRI))  %>% 
          rename(LeaseDate=Date)
     cl_renewal <- data %>% 
          subset(select=c(single_family_rent_index,Date,cbsacodeSFRI))  %>%
          rename(RenewalDate=Date,RenewalRent=single_family_rent_index)
     
     # this code creates a matrix of all possible year-cohort-cbsa combinations 
     xx <- data %>% subset(select="Date") %>% unique
     xz <- data %>% subset(select="Date") %>% unique %>% rename(LeaseDate=Date)
     xy <- data %>% subset(select="cbsacodeSFRI") %>% unique
     
     renterHist <- expand_grid(xx,xz) %>% 
     filter(LeaseDate<=Date) %>%   
     expand_grid(.,xy) %>% 
     mutate(diff=12*year(Date)+month(Date)-12*year(LeaseDate)-month(LeaseDate)) %>%
     left_join(.,cl_lease) %>%
     mutate(bin=floor(diff/12)) %>%
     mutate(RenewalDate=as.Date(paste0(year(LeaseDate)+bin,"/",month(LeaseDate),"/1"))) %>%
     left_join(.,cl_renewal) %>% filter(RenewalDate>LeaseDate) 
     
     
     output <-renterHist %>%     
     mutate(weight=alpha^bin*(1-alpha))  %>%
     mutate(UpdatedRent=(1-gamma)*single_family_rent_index+gamma*RenewalRent) %>%
     group_by(Date,cbsacodeSFRI) %>%
     summarise(CPIPred=weighted.mean(UpdatedRent,weight,na.rm=TRUE),sum(weight)) %>% ungroup
return(output)}

data_1 <- cl_sfri %>% filter(cbsacodeSFRI==99999) %>%
     filter(Date>=as.Date("2008/12/1"))

predCPI<-fPredCPI(alpha=0.8,
                  gamma=0.5,
                  data=data_1)
```

## Code to create a dataset for Giovanni

```{r dataGiovanni}
data_1=cl_sfri

predCPI<-fPredCPI(alpha=0.95,
                  gamma=0.5,
                  data=data_1)

sfri_data <- data_1 %>%
     subset(select=c(single_family_rent_index,Date,cbsacodeSFRI)) 

rentIndices <- predCPI %>%
     left_join(.,sfri_data) %>%
     left_join(.,regional_cpi_rent) %>%
     arrange(cbsacodeSFRI,Date)
     
          
write.csv(rentIndices,"/home/a1psw01/Desktop/Notebooks/Data/PWNotebook_2023_10_RentData2023_11.csv", row.names = FALSE)
```

##  Version where we arbitrarily choose $\alpha$ and $\gamma$

assume that even if you stay in an apartment, your rent is some convex combination of the market rent and your lease rate.

According to an urban institute survey, as of April 2022, about half of landlords plan to raise rents by less than 5 percent and about 85 percent less than 10 percent.

according to the single family rent index, rents went up by about 12 percent from April 2021 to April 2022. 

This version embeds version 2 when gamme=0

https://www.urban.org/urban-wire/though-most-mom-and-pop-landlords-plan-raise-rent-under-market-rates-many-tenants-will


```{r forecast}

#  This code appends on a forecast for SFRI to the actual data
#  does it for national data but we can obviously replace with anything we want
rr <- cl_sfri %>% filter(cbsacodeSFRI==99999) %>%
     filter(Date==last(Date)) %>%
     slice(rep(n(),120)) %>%
     mutate(Date=seq(Date[1], by = "month", length.out = 120))  %>%
     mutate(single_family_rent_index=
                 single_family_rent_index*exp(.02/12*seq(0,119,by=1))) %>%
     slice(-1)

cl_sfri_natl<- cl_sfri %>% filter(cbsacodeSFRI==99999) %>%
     bind_rows(.,rr)


data_1 <- cl_sfri_natl

predCPI<-fPredCPI(alpha=0.4,
                  gamma=0.1,
                  data=data_1)

sfri_data <- data_1 %>%
     subset(select=c(single_family_rent_index,Date,cbsacodeSFRI)) 

rentIndices <- predCPI %>%
     left_join(.,sfri_data) %>%
     left_join(.,regional_cpi_rent) %>% 
     group_by(cbsacodeSFRI) %>%
     mutate(SimCPIInflYOY=100*(log(CPIPred)-lag(log(CPIPred),12))) %>%
     mutate(CPIInflYOY=100*(log(CPI)-lag(log(CPI),12))) %>%
     mutate(SFRIInflYOY=100*(log(single_family_rent_index)-lag(log(single_family_rent_index),12)))

rentIndexPandemic <- rentIndices %>% 
     filter(cbsacodeSFRI==99999) 

       


```

### make figure: PW_001_RentForecast

![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_001_RentForecast-1.png)

```{r PriceRentCOVID115_ZHVIRUCC_BinScatter, fig.height = 10, fig.width = 8*sqrt(2), fig.align = "center"}



FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_001_RentForecast"

pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =as.Date(c("2018/11/1","2030/8/1")),
                     pst_ylims         =c(-0.5,12.5),
                     pst_xticks        =seq(as.Date(c("2019/7/1")),as.Date("2030/7/1"),by="1 year"),
                     pst_xlines        =seq(as.Date(c("2019/1/1")),as.Date("2030/1/1"),by="1 year"),
                     pst_yticks        =seq(0,12,by=2),
                     # pst_ytickLabels   =c(seq(150,500,by=50)),
                     factor            =.9,
                     pst_xticks_main   =0,
                     pst_yticks_main   =0,
                     pst_xticks_decimal=2,
                     pst_yticks_decimal=0,
                     # pst_yticks_decimalRight = 0,
                     aspect            =sqrt(2),
                     DateFormat    ="%Y",
                     ylabel   ="Growth in \\%",
                     ylabel_sep= 100,
                     # ylabel_sepRight= 100,
                     # ylabelRight ="rate in \\%",
                     # YNumberSide = "left",
                     TickLineColor = "lightgray",
                     XLabel = "Year")





fPSTLine(pst_root=FigureRoot,
         pst_name="SimCPIActual",
         pst_x=as.numeric(
              rentIndexPandemic$Date[rentIndexPandemic$Date<=as.Date("2022/7/1")]),
         pst_y=rentIndexPandemic$SimCPIInflYOY[rentIndexPandemic$Date<=as.Date("2022/7/1")],
         pst=pst_box,
         color="red",
         xx_1=as.numeric(as.Date("2025/7/1")),
         yy_1=3.5,
         label="\\parbox{1.5cm}{\\centering\\textcolor{red}{Simulated CPI Rent}}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "1pt 4pt",
         dir=45,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="SimCPIPred",
         pst_x=as.numeric(
              rentIndexPandemic$Date[rentIndexPandemic$Date>=as.Date("2022/7/1")]),
         pst_y=rentIndexPandemic$SimCPIInflYOY[rentIndexPandemic$Date>=as.Date("2022/7/1")],
         pst=pst_box,
         color="red",
         xx_1=as.numeric(as.Date("2019/7/1")),
         yy_1=log(1800),
         label="",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "3pt 3pt",
         dir=90,
         side="left")



fPSTLine(pst_root=FigureRoot,
         pst_name="CPIRent",
         pst_x=as.numeric(rentIndexPandemic$Date),
         pst_y=rentIndexPandemic$CPIInflYOY,
         pst=pst_box,
         color="black",
         xx_1=as.numeric(as.Date("2019/12/1")),
         yy_1=4.1,
         label="\\parbox{1cm}{\\centering CPI Rent}",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "4pt 4pt",
         dir=90,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="SFRIActl",
         pst_x=as.numeric(rentIndexPandemic$Date[rentIndexPandemic$Date<=as.Date("2022/7/1")]),
         pst_y=rentIndexPandemic$SFRIInflYOY[rentIndexPandemic$Date<=as.Date("2022/7/1")],
         pst=pst_box,
         color="green",
         xx_1=as.numeric(as.Date("2019/7/1")),
         yy_1=log(1800),
         label="",
         LineStyle = "solid",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "6pt 1pt",
         dir=90,
         side="left")

fPSTLine(pst_root=FigureRoot,
         pst_name="SFRIPred",
         pst_x=as.numeric(rentIndexPandemic$Date[rentIndexPandemic$Date>=as.Date("2022/7/1")]),
         pst_y=rentIndexPandemic$SFRIInflYOY[rentIndexPandemic$Date>=as.Date("2022/7/1")],
         pst=pst_box,
         color="green",
         xx_1=as.numeric(as.Date("2022/10/1")),
         yy_1=10,
         label="\\parbox{1.5cm}{\\centering\\textcolor{green}{ Market Rents (CoreLogic)}}",
         LineStyle = "dashed",
         sep=0.1,
         LineWidth="1pt",
         LineDash = "3pt 3pt",
         dir=45,
         side="left")

####################################
fCompile(pst_root=FigureRoot,SubFiles=list("PSTAxes","SimCPIActual","SimCPIPred","CPIRent","SFRIActl","SFRIPred"),WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")#

# pp<-readPNG(paste0(FigureRoot,"-1.png"))
plot.new()
# plot.window(xlim=c(0,1), ylim=c(0,1))
# rasterImage(pp,0,0,0.95,0.95*sqrt(2))



```


#  Distributional effects of interest rates


## Optimal Blue Download

```{r OptimalBlue}

require(haven)

# obDownload <- read_dta(file = "/home/a1psw01/Desktop/Notebooks/Data/lock_data_clean.dta")

loan_purpose<-  c(112,111,276,106,277)
refi<-          c(  1,  2,  3,  0,  4)
refi_desc<-     c("RateTerm","CashOut","FHA_Streamline","Purchase","VAIRRRL")
refi<-          data.frame(loan_purpose,refi,refi_desc)

ob <- obDownload %>%  filter(loan_amount>10e3) %>% 
     filter(purchase_price>10e3) %>%
     filter(cashout_amount<loan_amount) %>% 
     mutate(zip=as.factor(str_pad(zip,5,pad=0))) %>%
     left_join(.,refi) %>%
     mutate(date=lock_dt) %>%
     filter(is.na(refi)==0) %>%
     mutate(rate_locks=rate) %>%
     {.}


# ob  <- sample_frac(ob,0.1)
```


## Create OB loan-level dataset
```{r OptimalBluedstatasmall}

xlsx_file <- paste0("/home/a1psw01/Desktop/Notebooks/Data/ZIP_CBSA_122019.xlsx")


zip_cbsa <- read_excel(path=xlsx_file) %>% 
     mutate(zip=as.factor(ZIP)) %>%
     mutate(cbsa=as.factor(CBSA)) %>%
     group_by(zip) %>%
       mutate(rank = rank(RES_RATIO, ties.method = "first")) %>%
     ungroup %>%
     filter(rank==1) %>%
     select(-c(RES_RATIO,BUS_RATIO,OTH_RATIO,TOT_RATIO,ZIP,CBSA))


obSmall <- ob %>% select(week,
                                   customer_h_index,
                                   loan_type,
                                   loan_term,
                                   loan_purpose,
                                   property_type,
                                   occupancy,
                                   fico,
                                   loan_amount,
                                   purchase_price,
                                   ltv,
                                   rate_locks,
                                   zip,
                                   dti,
                                   qm_flag,
                                   cltv,
                                   cashout_amount,
                                   pi_amount,
                                   date,
                                   fthb_flag,
                                   refi,
                                   program,
                                   loan_term,
                                   channel,
                                   selfemployed_flag)%>%
     mutate(Date=as.Date(date)) %>% 
     filter(is.na(dti)==0) %>% 
     filter(dti<100&dti>0) %>% 
     filter(is.na(selfemployed_flag)==0) %>% 
     filter(is.na(pi_amount)==0) %>%
     filter(pi_amount>0) %>%
     mutate(log_dti=log(dti),log_pi_amount=log(pi_amount)) %>%
     mutate(month=lubridate::month(Date),quarter=lubridate::quarter(Date),year=lubridate::year(Date)) %>%
     mutate(ym=factor(paste0(year,"m",str_pad(month,2,pad=0))),yq=factor(paste0(year,"q",quarter))) %>%
     left_join(.,zip_cbsa) %>%
     filter(is.na(cbsa)==0)


```

## create OB aggregated datasets

``` {r OptimalBlueAnalysis}


ob_date <-ob %>% mutate(Date=as.Date(date)) %>% 
     filter(is.na(dti)==0) %>% 
     filter(dti<100) %>% 
     filter(is.na(pi_amount)==0)%>%
     filter(is.na(refi)==0) %>%
     mutate(weekday=lubridate::wday(date)) %>%
     filter(weekday>1&weekday<7) %>%
     group_by(Date)  %>%
     summarise(n=n(),meanrate=mean(rate_locks),meandti=mean(dti),p50=median(dti),
               p10=quantile(dti,.1),
               p90=quantile(dti,.9),
               cashout=mean(refi==2),
               purchase=mean(refi==0),
               rateterm=mean(refi==1),
               meanpi=mean(pi_amount),
               meanltv=mean(ltv),
               secondhome=mean(occupancy==3),
               investor=mean(occupancy==1))%>%
     filter(n>100) %>% ungroup

ob_week <-ob %>% mutate(Date=as.Date(date)) %>% 
     filter(is.na(dti)==0) %>% 
     filter(dti<100) %>% 
     filter(is.na(pi_amount)==0)%>%
     filter(is.na(refi)==0) %>%
     mutate(week=lubridate::week(Date),year=lubridate::year(Date)) %>%
     group_by(year,week)  %>%
     summarise(n=n(),meanrate=mean(rate_locks),
               meandti=mean(dti),
               p50=median(dti),
               p10=quantile(dti,.1),
               p90=quantile(dti,.9),
               cashout=mean(refi==2),
               purchase=mean(refi==0),
               rateterm=mean(refi==1),
               cashout_num=sum(refi==2),
               purchase_num=sum(refi==0),
               rateterm_num=sum(refi==1),
               meanpi=mean(pi_amount),
               meanltv=mean(ltv),
               meanl=mean(loan_amount),
               meanv=mean(purchase_price),
               secondhome=mean(occupancy==3),
               investor=mean(occupancy==1),
               ficomean=mean(fico),
               ficop50=median(fico),
               ficop10=quantile(fico,.1),
               ficop90=quantile(fico,.9),
               Date=max(Date))%>%
     filter(n>100) %>% ungroup
ob_week_x53 <- ob_week %>% filter(week<52&Date<max(Date))


ob_week_cashout <-ob %>% 
     mutate(Date=as.Date(date)) %>% 
     filter(is.na(dti)==0) %>% 
     filter(dti<100) %>% 
     filter(is.na(pi_amount)==0)%>%
     filter(cashout_amount>0.02*loan_amount)%>%
     filter(cashout_amount<loan_amount)%>%
     filter(refi==2)%>%
     filter(is.na(refi)==0) %>%
     mutate(cashout_to_i=cashout_amount/pi_amount*.43) %>%
     mutate(week=lubridate::week(Date),year=lubridate::year(Date)) %>%
     group_by(year,week)  %>%
     summarise(n=n(),meanrate=mean(rate_locks),meandti=mean(dti),p50=median(dti),
               p10=quantile(dti,.1),
               p90=quantile(dti,.9),
               meanpi=mean(pi_amount),
               medianpi=median(pi_amount),
               meanloanamt=mean(loan_amount),
               medianloanamt=median(loan_amount),
               meanvalue=mean(purchase_price),
               medianvalue=median(purchase_price),
               meanltv=mean(ltv),
               meanltv_pre=mean(ltv-cashout_amount/purchase_price*100),
               medianltv=median(ltv),
               medianltv_pre=median(ltv-cashout_amount/purchase_price*100),
               sumcashout=sum(cashout_amount),
               meancashout=mean(cashout_amount),
               medianrelativecashout=median(cashout_amount/(loan_amount-cashout_amount)),
               mediancashout=median(cashout_amount),
               meancoti=mean(cashout_to_i),
               mediancoti=mean(cashout_to_i),
               Date=max(Date)) %>%
     ungroup


ob_week_cashout_x53 <- ob_week_cashout %>% filter(week<52&Date<max(Date))


ob_week_purchase <-ob %>% mutate(Date=as.Date(date)) %>% 
     filter(is.na(dti)==0) %>% 
     filter(dti<100&dti>0) %>% 
     filter(is.na(pi_amount)==0)%>%
     filter(refi==0)%>%
     filter(is.na(refi)==0) %>%
     mutate(week=lubridate::week(Date),year=lubridate::year(Date)) %>%
     group_by(year,week)  %>%
     mutate(inc=pi_amount/dti*100) %>%
     summarise(n=n(),meanrate=mean(rate_locks),
               meandti=mean(dti),
               p50=median(dti),
               p10=quantile(dti,.1),
               p90=quantile(dti,.9),
               cashout=mean(refi==2),
               purchase=mean(refi==0),
               rateterm=mean(refi==1),
               cashout_num=sum(refi==2),
               purchase_num=sum(refi==0),
               rateterm_num=sum(refi==1),
               meanpi=mean(pi_amount),
               meanltv=mean(ltv),
               meancltv=mean(cltv),
               meanl=mean(loan_amount),
               meanv=mean(purchase_price),
               secondhome=mean(occupancy==3),
               investor=mean(occupancy==1),
               ficomean=mean(fico),
               ficop50=median(fico),
               ficop10=quantile(fico,.1),
               ficop90=quantile(fico,.9),
               Date=max(Date),
               meaninc=mean(inc)) %>%
     filter(n>100) %>%
     mutate(totinc=n*meaninc) %>%
     ungroup

ob_week_purchase_x53 <- ob_week_purchase %>% filter(week<52&Date<max(Date))


ob_month_purchase <-ob %>% mutate(Date=as.Date(date)) %>% 
     filter(is.na(dti)==0) %>% 
     filter(dti<100&dti>0) %>% 
     filter(is.na(pi_amount)==0)%>%
     filter(refi==0)%>%
     filter(is.na(refi)==0) %>%
     mutate(month=lubridate::month(Date),year=lubridate::year(Date)) %>%
     group_by(year,month)  %>%
     mutate(inc=pi_amount/dti*100) %>%
     summarise(n=n(),meanrate=mean(rate_locks),
               meandti=mean(dti),
               p50=median(dti),
               p10=quantile(dti,.1),
               p90=quantile(dti,.9),
               cashout=mean(refi==2),
               purchase=mean(refi==0),
               rateterm=mean(refi==1),
               cashout_num=sum(refi==2),
               purchase_num=sum(refi==0),
               rateterm_num=sum(refi==1),
               meanpi=mean(pi_amount),
               meanltv=mean(ltv),
               meancltv=mean(cltv),
               meanl=mean(loan_amount),
               meanv=mean(purchase_price),
               secondhome=mean(occupancy==3),
               investor=mean(occupancy==1),
               ficomean=mean(fico),
               ficop50=median(fico),
               ficop10=quantile(fico,.1),
               ficop90=quantile(fico,.9),
               Date=max(Date),
               meaninc=mean(inc)) %>%
     filter(n>100) %>%
     mutate(totinc=n*meaninc) %>%
     ungroup %>%
     filter(lubridate::mday(Date)>27)

ob_quarter_purchase <-ob %>% mutate(Date=as.Date(date)) %>% 
     filter(is.na(dti)==0) %>% 
     filter(dti<100&dti>0) %>% 
     filter(is.na(pi_amount)==0)%>%
     filter(refi==0)%>%
     filter(is.na(refi)==0) %>%
     mutate(quarter=lubridate::quarter(Date),year=lubridate::year(Date)) %>%
     group_by(year,quarter)  %>%
     mutate(inc=pi_amount/dti*100) %>%
     summarise(n=n(),meanrate=mean(rate_locks),
               meandti=mean(dti),
               p50=median(dti),
               p10=quantile(dti,.1),
               p90=quantile(dti,.9),
               cashout=mean(refi==2),
               purchase=mean(refi==0),
               rateterm=mean(refi==1),
               cashout_num=sum(refi==2),
               purchase_num=sum(refi==0),
               rateterm_num=sum(refi==1),
               meanpi=mean(pi_amount),
               meanltv=mean(ltv),
               meancltv=mean(cltv),
               meanl=mean(loan_amount),
               meanv=mean(purchase_price),
               secondhome=mean(occupancy==3),
               investor=mean(occupancy==1),
               ficomean=mean(fico),
               ficop50=median(fico),
               ficop10=quantile(fico,.1),
               ficop90=quantile(fico,.9),
               Date=max(Date),
               meaninc=mean(inc)
               ) %>%
     filter(n>100) %>% ungroup %>%
     mutate(totinc=n*meaninc,
            totdays=Date-dplyr::lag(Date)) %>%
     filter(totdays>89)



ob_quarter_purchase$Date-dplyr::lag(ob_quarter_purchase$Date)

```
## OB Zipcode dataset

``` {r optimalblue zip dataset}

obZipYM <- obSmall %>% filter(is.na(dti)==0) %>% 
     filter(dti<100) %>% 
     filter(is.na(pi_amount)==0)%>% 
     filter(loan_purpose==106) %>% 
     filter(zip!="NA") %>%
     filter(occupancy==2) %>% 
     mutate(quarter=lubridate::quarter(date),month=lubridate::month(date),year=lubridate::year(date))  %>%
     select(date,fico,loan_amount,purchase_price,ltv,rate_locks,zip,month,year,dti,cltv,pi_amount) %>%
     group_by(year,month,zip) %>%
     mutate(num_loans = n()) %>%
     summarise_all(mean) %>% 
     ungroup() %>% 
     mutate(date=as.Date(paste0(year,"/",month,"/1"))) 

obZipNum<- obSmall %>% select(zip) %>%
     group_by(zip) %>%
     summarize(total_loans=n()) %>% 
     arrange(desc(total_loans)) %>%
     mutate(cum_sum=cumsum(total_loans)) %>%
     mutate(cum_pct=cum_sum/sum(total_loans)) 

BigZips <- obZipNum %>% filter(cum_pct<.9) %>%
     select(zip)
     


```
## statistics of income
``` {r loadsoi}

csv_file <- "/shared/crt/OptimalBlue/RateCalcs/Data/19zpallnoagi.csv"
soi_download <- read.csv(file = csv_file, header = TRUE, sep = ",",
dec = ".",strip.white = TRUE)

soi <- soi_download %>% select(ZIPCODE,N1,A00100,N02650,A02650,N00200,A00200) %>% group_by(ZIPCODE) %>%
     summarise_all(mean) %>% ungroup %>% mutate(tot_inc=A02650/N02650,ws_inc=A00200/N00200) %>%
     mutate(zip=as.factor(str_pad(ZIPCODE,5,pad=0))) 


soi <- left_join(obZipYM,soi) %>% filter(dti>0&dti<100) %>%
     mutate(log_loan_amount=log(loan_amount),
            log_purchase_price=log(purchase_price),
            log_pi_amount=log(pi_amount),
            log_ws_inc=log(ws_inc),
            log_dti=log(dti),
            log_tot_inc=log(tot_inc),
            log_num_loans=log(num_loans),
            log_N1=log(N1)) %>%
     left_join(.,zip_cbsa) %>% filter(is.na(cbsa)==0) %>% 
     mutate(quarter=lubridate::quarter(date),
            DateYQ=as.factor(as.Date(paste0(year,"/",quarter*3-2,"/1"))),
            DateYM=as.factor(as.Date(paste0(year,"/",month,"/1"))))%>% 
     filter(is.na(N1)==FALSE) %>% 
     left_join(.,obZipNum)





# save(soi,file="/shared/crt/Notebooks/Data/soi_zip_month.Rda")
# load(file="/shared/crt/Notebooks/Data/soi_zip_month.Rda")



```


```{r binscatter}

require(binsreg)
require(lfe)


StartDate<-as.Date("2018/12/31")
EndDate<-as.Date("2024/6/30")

sample=soi[soi$date>=StartDate&soi$date<=EndDate&soi$num_loans>100,]

```

## PW_HousingUpdate_201_Binscatter


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_201_Binscatter-1.png)

```{r,  }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_201_Binscatter"

factor=0.85
ylims=c(-.485,.255)
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(-.75,1.05),
                     pst_ylims         =ylims,
                     pst_xticks        =seq(-.8,1,by=.2),
                     # pst_xlines        =seq(-.8,1,by=.2),
                     pst_yticks        =seq(-.4,.25,by=.1),
                     factor            =factor,
                     pst_xticks_main   =0.0,
                     pst_yticks_main   =0,
                     pst_xticks_decimal=1,
                     pst_yticks_decimal=2,
                     aspect            =sqrt(2),
                     ylabel   ="Deviations from mean CBSA purchases (in logs)",
                     ylabel_sep= .05,
                     XLabel = "Deviations from mean CBSA income (in logs)",
                     XLabel_sep = .05,
                     # pst_ylimsRight    =c(-2.5,11.5),
                     # pst_yticksRight   =seq(-2,3,by=1),
                     # ylabel_sepRight= 30,
                     # ylabelRight ="\\parbox{3cm}{\\centering in \\%}",
                     # YNumberSide="left",
                     # YNumberSideRight="right",
                     # pst_yticks_decimalRight=0,
                     )

reg_formula_y=formula("log_num_loans ~ log_N1 | cbsa+ quarter")
reg_formula_x=formula("log_tot_inc ~ log_N1 | cbsa+ quarter")
NBins=15

number<-seq(1,4,by=1)
year<-seq(2020,2023,by=1)
color<-c("green","red","black","yellow")

ss<-data.frame(number,year,color)

for (yy in seq(1,4,by=1)){

     sample<-soi %>% filter(year==ss$year[yy]&quarter<3)
     color<- ss$color[yy]

     res_y <- lfe::felm(reg_formula_y,sample,weights = sample$N1 ,keepCX=TRUE, nostats=TRUE)
     res_x <- lfe::felm(reg_formula_x,sample,weights = sample$N1 ,keepCX=TRUE, nostats=TRUE)
     
est<-binsreg(res_y$resid,res_x$resid,nbins = NBins)
result <- est$data.plot$`Group Full Sample`


fPSTLine(pst_root=FigureRoot,
         pst_name=paste0("Y",ss$year[yy]),
         pst_x=result$data.dots$x,
         pst_y=result$data.dots$fit,
         pst=pst_box,
         color=ss$color[yy],
         xx_1=result$data.dots$x[14],
         yy_1=result$data.dots$fit[14],
         label=paste0(ss$year[yy]),
         sep=0.1,
         LineWidth="1pt",
         dir=0,
         Scatter = "true")
}


fCompile(pst_root=FigureRoot,SubFiles=list("PSTAxes","Y2023","Y2020","Y2021","Y2022"),         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")

plot.new()


```


## PW_HousingUpdate_202_pi_fico_Binscatter_NoFE


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_202_pi_fico_Binscatter_NoFE-1.png)

```{r,  }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_202_pi_fico_Binscatter_NoFE"

factor=0.85
ylims=c(6.5,7.7)
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(590,810),
                     pst_ylims         =ylims,
                     pst_xticks        =seq(600,800,by=20),
                     # pst_xlines        =seq(-.8,1,by=.2),
                     pst_yticks        =seq(6.4,7.6,by=.2),
                     factor            =factor,
                     pst_xticks_main   =0.0,
                     pst_yticks_main   =0,
                     pst_xticks_decimal=0,
                     pst_yticks_decimal=1,
                     aspect            =sqrt(2),
                     ylabel   ="\\parbox{5cm}{\\centering Monthly Payment (in logs)}",
                     ylabel_sep= 10,
                     XLabel = "\\parbox{5cm}{\\centering FICO Score}",
                     XLabel_sep = .05,
                     # pst_ylimsRight    =c(-2.5,11.5),
                     # pst_yticksRight   =seq(-2,3,by=1),
                     # ylabel_sepRight= 30,
                     # ylabelRight ="\\parbox{3cm}{\\centering in \\%}",
                     # YNumberSide="left",
                     # YNumberSideRight="right",
                     # pst_yticks_decimalRight=0,
                     )

NBins=15

number<-seq(1,5,by=1)
year<-seq(2019,2023,by=1)
color<-c("green","red","black","yellow","blue")

ss<-data.frame(number,year,color)

for (yy in seq(1,5,by=1)){

     sample<-d2stataSmall %>% filter(year==ss$year[yy]&month==7)
     color<- ss$color[yy]

 
est<-binsreg(sample$log_pi_amount,sample$fico,nbins = NBins)
result <- est$data.plot$`Group Full Sample`


fPSTLine(pst_root=FigureRoot,
         pst_name=paste0("Y",ss$year[yy]),
         pst_x=result$data.dots$x,
         pst_y=result$data.dots$fit,
         pst=pst_box,
         color=ss$color[yy],
         xx_1=result$data.dots$x[1],
         yy_1=result$data.dots$fit[1],
         label=paste0(ss$year[yy]),
         sep=0.1,
         LineWidth="1pt",
         dir=-45,
         Scatter = "true")
}

# fPSTText(
#      pst_root=FigureRoot,
#          pst_name="Y2019Label",
#          pst=pst_box,
#          xx_1=.15,
#          yy_1=.12,
#          label="2019",
#          sep=0.1,
#          dir=90)
# 
# fPSTText(
#      pst_root=FigureRoot,
#          pst_name="Y2022Label",
#          pst=pst_box,
#          xx_1=.15,
#          yy_1=.035,
#          label="2022",
#          sep=0.1,
#          dir=-90)

fCompile(pst_root=FigureRoot,SubFiles=list("PSTAxes",
                                           "Y2019","Y2020","Y2021","Y2022","Y2023"),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")
plot.new()

```
## PW_HousingUpdate_203_fico_Binscatter_NoFE


![](/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_203_fico_Binscatter_NoFE-1.png)

```{r,  }

FigureRoot="/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate/PW_HousingUpdate_203_fico_Binscatter_NoFE"


factor=0.85
ylims=c(11.9,13.8)
pst_box  <- fPSTAxes(pst_root=FigureRoot,
                     pst_xlims         =c(500,850),
                     pst_ylims         =ylims,
                     pst_xticks        =seq(500,850,by=50),
                     # pst_xlines        =seq(-.8,1,by=.2),
                     pst_yticks        =seq(12,14,by=.4),
                     factor            =factor,
                     pst_xticks_main   =0.0,
                     pst_yticks_main   =0,
                     pst_xticks_decimal=1,
                     pst_yticks_decimal=1,
                     aspect            =sqrt(2),
                     ylabel   ="\\parbox{5cm}{\\centering Purchase price (in logs)}",
                     ylabel_sep= .05,
                     XLabel = "\\parbox{5cm}{\\centering Income (in logs)}",
                     XLabel_sep = .05,
                     # pst_ylimsRight    =c(-2.5,11.5),
                     # pst_yticksRight   =seq(-2,3,by=1),
                     # ylabel_sepRight= 30,
                     # ylabelRight ="\\parbox{3cm}{\\centering in \\%}",
                     # YNumberSide="left",
                     # YNumberSideRight="right",
                     # pst_yticks_decimalRight=0,
                     )

NBins=15

number<-seq(1,5,by=1)
year<-seq(2019,2023,by=1)
color<-c("green","red","black","yellow","blue")

ss<-data.frame(number,year,color)

for (yy in seq(1,5,by=1)){

     sample<-soi %>% filter(year==ss$year[yy]&month==7)
     color<- ss$color[yy]

est<-binsreg(sample$log_purchase_price,sample$fico,nbins = NBins)
result <- est$data.plot$`Group Full Sample`


fPSTLine(pst_root=FigureRoot,
         pst_name=paste0("Y",ss$year[yy]),
         pst_x=result$data.dots$x,
         pst_y=result$data.dots$fit,
         pst=pst_box,
         color=ss$color[yy],
         xx_1=result$data.dots$x[14],
         yy_1=result$data.dots$fit[14],
         label="",
         sep=0.1,
         LineWidth="1pt",
         dir=0,
         Scatter = "true")
}

# fPSTText(
#      pst_root=FigureRoot,
#          pst_name="Y2019Label",
#          pst=pst_box,
#          xx_1=.15,
#          yy_1=.12,
#          label="2019",
#          sep=0.1,
#          dir=90)
# 
# fPSTText(
#      pst_root=FigureRoot,
#          pst_name="Y2022Label",
#          pst=pst_box,
#          xx_1=.15,
#          yy_1=.035,
#          label="2022",
#          sep=0.1,
#          dir=-90)

fCompile(pst_root=FigureRoot,SubFiles=list("PSTAxes",
                                           "Y2019","Y2020","Y2021","Y2022","Y2023"),
         PictureSize=factor/.75*c(9,7),
         WorkingDirectory = "/home/a1psw01/Desktop/Notebooks/Images/HousingUpdate")
plot.new()

```

